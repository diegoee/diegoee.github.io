<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Web test">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons" > 
    <!-- UIkit CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/uikit@3.4.0/dist/css/uikit.min.css" />    
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, minimal-ui">
    <title>Web Test5_simuMov</title>
    <style> 
      #loading{
        background-color: rgb(255,255,255,0.85);
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 100000;
        display: flex;
        align-items: center;
        justify-content: center; 
        opacity: 0.75;
      }  
    </style>
  </head>
  <body>   
    <div id="loading"> 
      <div uk-spinner="ratio: 5"></div>
    </div> 
    <div id="app">
      <div class="uk-grid-collapse uk-grid-match  uk-child-width-expand@s uk-padding-small" uk-grid>
        <div class="uk-width-1-3@m">
          <div class="uk-placeholder">  
            <div class="uk-margin" uk-grid>   
              <div class="uk-width-2-3"> 
                <button id="btn1" class="uk-button uk-width-1-1 uk-button-primary"><span uk-icon="icon: play-circle"></span></button>
              </div>
              <div class="uk-width-1-3"> 
                <button id="btn2" class="uk-button uk-width-1-1 uk-button-danger"><span uk-icon="icon: trash"></span></button>
              </div> 
            </div>
            <div class="uk-margin" uk-grid> 
              <div class="uk-width-1-1">
                <label class="uk-form-label" for="form-stacked-text">NÂº point</label>
                <div class="uk-form-controls">
                  <select id="sel1" class="uk-select uk-form-small"></select>
                </div>
              </div> 
            </div> 
            <div class="uk-margin" uk-grid>
              <div class="uk-width-1-2">
                <label class="uk-form-label" for="form-stacked-text">Mobility</label>
                <div class="uk-form-controls">
                  <select id="sel2" class="uk-select uk-form-small"></select>
                </div>
              </div>
              <div class="uk-width-1-2">
                <label class="uk-form-label" for="form-stacked-text">% start</label>
                <div class="uk-form-controls">
                  <select id="sel3" class="uk-select uk-form-small"></select>
                </div>
              </div> 
            </div>
            <div class="uk-margin" uk-grid>
              <div class="uk-width-1-2"> 
                <label id ="textGraph" class="uk-form-label" for="form-stacked-text">Evolution</label>
              </div>
              <div class="uk-width-1-2 uk-text-right"> 
                <label id ="textCanvas" class="uk-form-label" for="form-stacked-text"></label>
              </div>  
              <div class="uk-width-1-1"> 
                <div id="chartContainer" class="uk-form-controls uk-text-center">
                </div>
              </div>  
            </div> 
          </div>
        </div>
        <div class="uk-width-expand@m">
          <div class="uk-placeholder">            
            <div class="uk-margin">
              <div id="canvasContainer"></div>
            </div>
          </div>
        </div>
      </div>
    </div> 
    <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/uikit@3.4.0/dist/js/uikit.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/uikit@3.4.0/dist/js/uikit-icons.min.js"></script> 
    <script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.3/dist/Chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/3.6.2/fabric.min.js"></script> 
    <script type="text/javascript"> 
      (function exe(){   
        var simu = {  
          interGraph: undefined, 
          running: false,
          states: [0,0,0],
          countStates: function(objs){ 
            var aux = [0,0,0];
            for (var i in objs){
              if(objs[i].state===0){
                aux[1]++;
              }else if(objs[i].state===1){
                aux[0]++;
              }else{
                aux[2]++;
              }
            }
            simu.states=aux; 
          },
          start: function(){ 
            dApp.createCanvas(); 
            var canvas = new fabric.Canvas('canvas',{ 
              selection: false,
              preserveObjectStacking: true,
              width: $('#canvasContainer').innerWidth(), 
              height: $('#canvasContainer').innerHeight()             
            });
            
            for(var i=0; i<dApp.getNpoint(); i++){
              var point = new fabric.Circle({ 
                radius: (canvas.height>canvas.width?0.0175*canvas.height/2*Math.PI:0.0175*canvas.width/2*Math.PI),   
                fill: 'black', 
                state: 0, 
                time: 0,
                top: canvas.height*Math.random(), 
                left: canvas.width*Math.random(), 
                originX: 'center',
                originY: 'center', 
                selectable: false 
              });
              canvas.add(point);
              canvas.renderAll();
            }
            //start state
            var aux = [];
            for(var i=0; i<Math.round(dApp.getNpoint()*dApp.getStartPoint()/100); i++){
              aux.push((Math.floor(Math.random()*dApp.getNpoint())+1)-1);
            }
            var timeState = 100;
            for (var i in aux){ 
              canvas.getObjects()[aux[i]].set({ 
                state: 1,
                time: timeState+(Math.floor(Math.random()*timeState/4)+1)
              });  
            }            
            simu.countStates(canvas.getObjects());
            canvas.renderAll();
 
            var prevTime = Date.now(); 
            var myfps = 60;
            var frames = 0; 
            dApp.setTextCanvas('FPS: 0/' + myfps);

            this.running = true; 
            function animate(){
              var time = Date.now();
              frames++; 
              if ( time > prevTime + 1000 ) {
                var fps = Math.round( ( frames * 1000 ) / ( time - prevTime ) );
                prevTime = time;
                frames = 0; 
                dApp.setTextCanvas('FPS: '+(fps<10?'0'+fps:fps)+'/'+myfps);
              }

              canvas.forEachObject(function(obj){  
                var x = obj.left+(Math.random()-0.5)*dApp.getMobility();
                var y = obj.top+(Math.random()-0.5)*dApp.getMobility();
                if(x>0&&x<canvas.width){ 
                  obj.left=x;
                }
                if(y>0&&y<canvas.height){ 
                  obj.top=y;
                } 
                obj.set({  
                  fill: (obj.state===0)?'green':(obj.state===1)?'red':'blue',
                  state: (obj.state===1&&obj.time===0)?2:obj.state,
                  time: (obj.time===0)?0:obj.time-1
                });  
                
                canvas.forEachObject(function(o){
                  if (obj === o) return;   
                  obj.setCoords();
                  if (obj.intersectsWithObject(o)&&o.state===1&&obj.state===0){
                    obj.set({  
                      state: 1,
                      time: timeState+(Math.floor(Math.random()*timeState/4)+1)
                    });
                  } 
                });  

              });  
              simu.countStates(canvas.getObjects()); 
              if(simu.running){ 
                fabric.util.requestAnimFrame(animate, canvas.getElement()); 
                canvas.renderAll();
              }
            }
            fabric.util.requestAnimFrame(animate, canvas.getElement()); 
            canvas.renderAll();
            
            var sChart = dApp.createChart();
            var chart = new Chart(sChart.id,{
              type: 'line',
              data: {
                labels: [],
                datasets: [{
                  data: [this.states[0]],
                  borderColor: 'red',
					        backgroundColor: 'red',
                  fill: true,  
                  label: 'Red'
                },{
                  data: [this.states[1]],
                  borderColor: 'green',
					        backgroundColor: 'green',
                  fill: true,  
                  label: 'Green'
                },{
                  data: [this.states[2]],
                  borderColor: 'blue',
					        backgroundColor: 'blue',
                  fill: true,  
                  label: 'Blue'
                }]
              },
              options: {
                responsive: true,
                title: {
                  display: true,
                  text: sChart.title
                },
                tooltips: {
                  mode: 'index',
                  intersect: false,
                },
                hover: {
                  mode: 'nearest',
                  intersect: true
                },
                elements: {
                  point:{
                    radius: 0
                  }
                },
                scales: {
                  xAxes: [{
                    display: true,
                    scaleLabel: {
                      display: true,
                      labelString: 'Time'
                    }
                  }],
                  yAxes: [{
                    stacked: true,
                    display: true,
                    scaleLabel: {
                      display: true,
                      labelString: 'N'
                    }
                  }]
                },
                animation: {
                  duration: 750,
                },
              }
            });
            var pos = 1;
            var n = 4;
            var posEnd = 30*n;
            var ms = 1000/n;             
            this.interGraph = setInterval(function(){ 
              chart.data.labels.push(pos); 
              pos++;     
              for (var i=0; i<chart.data.datasets.length; i++){ 
                chart.data.datasets[i].data.push(simu.states[i]); 
              }      
              chart.update();
              dApp.setTextGraph('Evolution: '+Math.floor(pos/n)+'/'+posEnd/n);
              if(pos>=posEnd){
                simu.stop();
                dApp.fireExeClick();
              }
            },ms);  
          },
          stop: function(){
            this.running = false;
            clearInterval(this.interGraph);  
            dApp.resetText();  
          }
        }
        var dApp = {
          nChart: -1,
          onOffLoading: function(state){ 
            if(state){
              $('#loading').css({
                display: 'flex'
              });
            }else{
              $('#loading').css({
                display: 'none'
              });
            } 
          },
          fireExeClick: function(){
            $('#btn1').trigger('click'); 
          },
          createChart: function(){ 
            this.nChart++;
            var idChart = 'chart'+(this.nChart<10?'0'+this.nChart:this.nChart);
            var desc = 'Npoint: '+this.getNpoint()+' - Mobility: '+this.getMobility()+' - %start: '+this.getStartPoint();
            $('#chartContainer').prepend('<canvas id="'+idChart+'"></canvas>');
            return {
              id: idChart,
              title: desc
            };
          },
          createCanvas: function(){
            $('#canvasContainer').html('<canvas id="canvas"></canvas>');
            $('#canvasContainer').css({ 
              'width': '100%',
              'height': '500px'
            });
            $('#canvas').css({
              'border-style': 'dotted',
              'border-width': '2px',
              'border-radius': '0.25em',
              'border-color': '#1e87f0',
              'width': '100%',
              'height': '100%'
            });
            $('#canvasContainer').off('mouseenter');
            $('#canvasContainer').off('mouseleave');
            $('#canvasContainer').on({ 
              mouseenter: function(options) { 
                $('#canvasContainer').addClass('uk-box-shadow-large'); 
              },
              mouseleave: function(options) { 
                $('#canvasContainer').removeClass('uk-box-shadow-large'); 
              } 
            });
          },
          getNpoint: function(){
            return parseInt($('#sel1').val()); 
          }, 
          getMobility: function(){
            return parseInt($('#sel2').val()); 
          },
          getStartPoint: function(){
            return parseInt($('#sel3').val()); 
          },
          setTextGraph: function(text){
            $('#textGraph').text(text); 
          },
          setTextCanvas: function(text){
            $('#textCanvas').text(text); 
          },
          btnStart: function(){ 
            $('#btn1').html('<span uk-icon="icon: ban"></span>');
            $('#btn1').removeClass('uk-button-danger');
            $('#btn1').removeClass('uk-button-primary');
            $('#btn1').addClass('uk-button-danger');
            $('select').attr('disabled',true);
          },
          btnStop: function(){
            $('#btn1').html('<span uk-icon="icon: play-circle"></span>');
            $('#btn1').removeClass('uk-button-danger');
            $('#btn1').removeClass('uk-button-primary');
            $('#btn1').addClass('uk-button-primary');
            $('select').removeAttr('disabled');
          },
          setCombos: function(){
            for(var i=10; i<=250; i=i+10){              
              $('#sel1').append('<option value="'+i+'">'+i+'</option>');
            }
            
            $('#sel2').append('<option value="1">1</option>');
            $('#sel2').append('<option value="5">5</option>');
            for(var i=10; i<=100; i=i+10){              
              $('#sel2').append('<option value="'+i+'">'+i+'</option>');
            }
            $('#sel3').append('<option value="1">1</option>');
            $('#sel3').append('<option value="2">2</option>');
            $('#sel3').append('<option value="5">5</option>');
            $('#sel1').val(50);
            $('#sel2').val(20);
            $('#sel3').val(2);
          },
          setActionButton: function(){
            $('#btn1').on('click',function(){
              if($('#btn1').hasClass('uk-button-primary')){
                dApp.btnStart(); 
                dApp.onOffLoading(true);
                simu.start(); 
                dApp.onOffLoading(false);
              }else{  
                dApp.btnStop();
                dApp.onOffLoading(true);
                simu.stop();
                dApp.onOffLoading(false);
              }
            });
          },
          setDeleteButton: function(){
            $('#btn2').on('click',function(){ 
              $($('#chartContainer canvas')[0]).animate({ 
                width: 0, 
                height: 0
              },{
                duration: 250, 
                complete: function(now) {
                  $(this).remove();
                }
              });
            });
          },
          resetText: function(){
            dApp.setTextCanvas('FPS: --/--');
            dApp.setTextGraph('Evolution: --/--');  
          },
          exe: function(){
            this.setCombos();
            this.setActionButton(); 
            this.setDeleteButton();  
            this.resetText();   
            dApp.onOffLoading(true); 
            $('#app').innerHeight($(window).innerHeight());  
            simu.stop();   
            dApp.btnStop();   
            dApp.createCanvas();
            dApp.onOffLoading(false);   
          }
        }
        dApp.exe();
      })();
    </script>
    <noscript>JAVASCRIPT NOT WORKING!</noscript>
  </body>
</html>
