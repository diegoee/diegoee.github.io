<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Web test">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons" > 
    <!-- UIkit CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/uikit@3.4.0/dist/css/uikit.min.css" />    
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, minimal-ui">
    <title>Web Test5_simuMov</title>
    <style> 
      #loading{
        background-color: rgb(255,255,255,0.85);
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 100000;
        display: flex;
        align-items: center;
        justify-content: center; 
        opacity: 0.75;
      }  
    </style>
  </head>
  <body>   
    <div id="loading"> 
      <div uk-spinner="ratio: 5"></div>
    </div> 
    <div id="app">
      <div class="uk-grid-collapse uk-grid-match  uk-child-width-expand@s uk-padding-small" uk-grid>
        <div class="uk-width-1-3@m">
          <div class="uk-placeholder">  
            <div class="uk-margin">              
              <button id="btn1" class="uk-button uk-width-1-1 uk-button-primary"><span uk-icon="icon: play-circle"></span></button>
            </div>
            <div class="uk-margin" uk-grid> 
              <div class="uk-width-1-2">
                <label class="uk-form-label" for="form-stacked-text">NÂº point</label>
                <div class="uk-form-controls">
                  <select id="sel1" class="uk-select uk-form-small"></select>
                </div>
              </div>
              <div class="uk-width-1-2">
                <label class="uk-form-label" for="form-stacked-text">Speed</label>
                <div class="uk-form-controls">
                  <select id="sel2" class="uk-select uk-form-small"></select>
                </div>
              </div>
            </div> 
            <div class="uk-margin" uk-grid>
              <div class="uk-width-1-2">
                <label class="uk-form-label" for="form-stacked-text">Mobility</label>
                <div class="uk-form-controls">
                  <select id="sel3" class="uk-select uk-form-small"></select>
                </div>
              </div>
              <div class="uk-width-1-2">
                <label class="uk-form-label" for="form-stacked-text">% start</label>
                <div class="uk-form-controls">
                  <select id="sel4" class="uk-select uk-form-small"></select>
                </div>
              </div> 
            </div>
            <div class="uk-margin">
              <label id ="textGraph" class="uk-form-label" for="form-stacked-text">Evolution</label>
              <div class="uk-form-controls">
                <canvas id="chart"></canvas>
              </div>
            </div>  
          </div>
        </div>
        <div class="uk-width-expand@m">
            <div class="uk-placeholder">            
              <div class="uk-margin">
                <div id="canvasContainer">
                </div>
              </div>
            </div>
        </div>
      </div>
    </div> 
    <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/uikit@3.4.0/dist/js/uikit.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/uikit@3.4.0/dist/js/uikit-icons.min.js"></script> 
    <script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.3/dist/Chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/3.6.2/fabric.min.js"></script> 
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/6.6.2/math.min.js"></script>  
    <script type="text/javascript"> 
      (function exe(){   
        var simu = {
          interCanvas: undefined, 
          interGraph: undefined,
          canvas: undefined, 
          states: [10,10,10],
          start: function(){
            dApp.createCanvas();
            canvas = new fabric.Canvas('canvas',{ 
              selection: false,
              preserveObjectStacking: true,
              width: $('#canvasContainer').innerWidth(), 
              height: $('#canvasContainer').innerHeight()             
            }); 
            canvas.on({ 
              'mouse:over': function(options) { 
                $('#canvas').addClass('uk-box-shadow-large'); 
              },
              'mouse:out': function(options) { 
                $('#canvas').removeClass('uk-box-shadow-large'); 
              }
            });

            for(var i=0; i<dApp.getNpoint(); i++){
              var point = new fabric.Circle({ 
                radius: 5,   
                fill: 'black', 
                state: 'lol', 
                top: canvas.height*Math.random(), 
                left: canvas.width*Math.random(), 
                originX: 'center',
                originY: 'center' 
              });
              canvas.add(point);
              canvas.renderAll();
            }

            //TODO: borrar            
            //$('#chart').css({
            //  display: 'none'
            //});
            
            //window.canvas=canvas;
            //console.log(canvas);
            this.interCanvas = setInterval(function(){  
              for (var i in canvas.getObjects()){
                var x = canvas.getObjects()[i].left+(Math.random()-0.5)*dApp.getMobility();
                var y = canvas.getObjects()[i].top+(Math.random()-0.5)*dApp.getMobility();
                if(x>0&&x<canvas.width){ 
                  canvas.getObjects()[i].left=x;
                }
                if(y>0&&y<canvas.height){ 
                  canvas.getObjects()[i].top=y;
                } 
              }
              canvas.renderAll(); 
            },50); 

            var chart = new Chart('chart',{
              type: 'line',
              data: {
                labels: [],
                datasets: [{
                  data: [this.states[0]],
                  borderColor: 'red',
					        backgroundColor: 'red',
                  fill: true,  
                  label: 'state 1'
                } ,{
                  data: [this.states[1]],
                  borderColor: 'green',
					        backgroundColor: 'green',
                  fill: true,  
                  label: 'state 2'
                },{
                  data: [this.states[2]],
                  borderColor: 'blue',
					        backgroundColor: 'blue',
                  fill: true,  
                  label: 'state 3'
                }]
              },
              options: {
                responsive: true,
                title: {
                  display: false
                },
                tooltips: {
                  mode: 'index',
                  intersect: false,
                },
                hover: {
                  mode: 'nearest',
                  intersect: true
                },
                elements: {
                  point:{
                    radius: 0
                  }
                },
                scales: {
                  xAxes: [{
                    display: true,
                    scaleLabel: {
                      display: true,
                      labelString: 'Time'
                    }
                  }],
                  yAxes: [{
                    stacked: true,
                    display: true,
                    scaleLabel: {
                      display: true,
                      labelString: 'N'
                    }
                  }]
                },
                animation: {
                  duration: 750,
                },
              }
            });
            var pos = 1;
            var n = 4;
            var posEnd = 30*n;
            var timef = 1000/n;             
            this.interGraph = setInterval(function(){ 
              chart.data.labels.push(pos); 
              pos++;     
              for (var i=0; i<chart.data.datasets.length; i++){ 
                chart.data.datasets[i].data.push(simu.states[i]); 
              }      
              chart.update();
              dApp.setTextGraph('Evolution: '+Math.round(pos/n)+'/'+posEnd/n);
              if(pos>posEnd){
                simu.stop();
                dApp.fireExeClick();
              }
            },timef);  
          },
          stop: function(){
            if (this.canvas!==undefined){
              this.canvas.clear();
            }
            dApp.createCanvas();
            clearInterval(this.interGraph);
            clearInterval(this.interCanvas);
          }
        }
        var dApp = {
          onOffLoading: function(state){ 
            if(state){
              $('#loading').css({
                display: 'flex'
              });
            }else{
              $('#loading').css({
                display: 'none'
              });
            } 
          },
          resize: function(){    
            dApp.onOffLoading(true); 
            $('#app').innerHeight($(window).innerHeight());  
            simu.stop();   
            dApp.btnStop();   
            dApp.onOffLoading(false);  
          },
          fireExeClick: function(){
            $('#btn1').trigger('click'); 
          },
          createCanvas: function(){
            $('#canvasContainer').html('<canvas id="canvas"></canvas>');
            $('#canvasContainer').css({ 
              'width': '100%',
              'height': '500px'
            });
            $('#canvas').css({
              'border-style': 'dotted',
              'border-width': '2px',
              'border-radius': '0.25em',
              'border-color': '#1e87f0',
              'width': '100%',
              'height': '100%'
            });
          },
          getNpoint: function(){
            return parseInt($('#sel1').val()); 
          },
          getSpeed: function(){
            return parseInt($('#sel2').val()); 
          },
          getMobility: function(){
            return parseInt($('#sel3').val()); 
          },
          setTextGraph: function(text){
            $('#textGraph').text(text); 
          },
          btnStart: function(){ 
            $('#btn1').html('<span uk-icon="icon: ban"></span>');
            $('#btn1').removeClass('uk-button-danger');
            $('#btn1').removeClass('uk-button-primary');
            $('#btn1').addClass('uk-button-danger');
            $('select').attr('disabled',true);
          },
          btnStop: function(){
            $('#btn1').html('<span uk-icon="icon: play-circle"></span>');
            $('#btn1').removeClass('uk-button-danger');
            $('#btn1').removeClass('uk-button-primary');
            $('#btn1').addClass('uk-button-primary');
            $('select').removeAttr('disabled');
          },
          exe: function(){
            $('#sel1').append('<option value="10">10</option>');
            $('#sel1').append('<option value="50">50</option>');        
            $('#sel1').append('<option value="100">100</option>');
            $('#sel2').append('<option value="10">10</option>');
            $('#sel2').append('<option value="25">25</option>');
            $('#sel2').append('<option value="50">50</option>');
            $('#sel3').append('<option value="10">10</option>');
            $('#sel3').append('<option value="50">50</option>');
            $('#sel3').append('<option value="100">100</option>'); 
            $('#sel4').append('<option value="1">1</option>');
            $('#sel4').append('<option value="5">5</option>');
            $('#sel4').append('<option value="20">20</option>');
            $('#btn1').on('click',function(){
              if($('#btn1').hasClass('uk-button-primary')){
                dApp.btnStart();
                simu.start();
              }else{  
                dApp.btnStop();
                simu.stop();
              }
            });
            this.resize();
            $(window).on('resize',this.resize);
            setTimeout(function(){ 
              dApp.fireExeClick();
            },250); 
          }
        }
        dApp.exe();
      })();
    </script>
    <noscript>JAVASCRIPT NOT WORKING!</noscript>
  </body>
</html>
