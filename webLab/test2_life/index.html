<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Web test">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons" > 
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">  
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, minimal-ui">
    <title>Web Test2_life</title>
    <style> 
      #loading{
        background-color: rgb(255,255,255,0.85);
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 1000;
        display: flex;
        align-items: center;
        justify-content: center;
      } 
      #monitorFloat{ 
        position: absolute;
        top: 0;
        right: 0; 
        z-index: 100; 
      }     
    </style>
  </head>
  <body> 
    <div id="loading"> 
      <div class="preloader-wrapper big active">
        <div class="spinner-layer spinner-blue-only">
          <div class="circle-clipper left">
            <div class="circle"></div>
          </div><div class="gap-patch">
            <div class="circle"></div>
          </div><div class="circle-clipper right">
            <div class="circle"></div>
          </div>
        </div>
      </div>
    </div>  
    <div id="monitorFloat">  
    </div> 
    <div class="container">
      <div class="row">
        <div class="col s12">
          <div id="canvasContainer" class="card-panel hoverable">  
          </div>
        </div> 
      </div>
    </div>
    <script type="text/javascript" src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/3.6.2/fabric.min.js"></script>  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stats.js/r16/Stats.js"></script> 
    <script type="text/javascript"> 
      (function exe(){   
        var stats = new Stats();
        stats.showPanel(2); // 0: fps, 1: ms, 2: mb, 3+: custom
        $('#monitorFloat').html(stats.domElement);  
        function animateMemo(){
          stats.begin();
          stats.end();
          requestAnimationFrame(animateMemo);
        }
        requestAnimationFrame(animateMemo);

        function toast(text,fn){
          M.Toast.dismissAll();
          var toastMsg = M.toast({
            html: '<span>'+text+'</span><button class="btnToast btn-flat toast-action">Close</button>', // btn-flat toast-action
            displayLength: 1500, 
            completeCallback: fn
          }); 
          $('.btnToast').on('click',function(){
            M.Toast.dismissAll();
          }); 
        } 
        function onOffLoading(state){ 
          if(state){
            $('#loading').css({
              display: 'flex'
            });
          }else{
            $('#loading').css({
              display: 'none'
            });
          } 
        }
        onOffLoading(true);
         
        var canvas = undefined;
        function plotCanvas(){ 
          onOffLoading(true);          
          canvas = new fabric.Canvas('canvas',{ 
            width: $('#canvasContainer').innerWidth()-48, 
            height: $('#canvasContainer').innerHeight()-48,
            selection: false,
            preserveObjectStacking: true,             
          });  
          var matrixPos = [];
          var fabricObj = []; 
          var cc = 15;
          for (var h=0; h<canvas.height; h=h+cc+1){ 
            var aux = [];
            for (var w=0; w<canvas.width; w=w+cc+1){
              aux.push([h,w]);  
            } 
            matrixPos.push(aux);   
          }  
          delete aux,h,w; 

          for(var i=0; i<matrixPos.length; i++){
            fabricObj.push(new fabric.Rect({
              left: 0,
              top:  matrixPos[i][0][0],
              fill: 'BLACK',
              width: matrixPos[0][matrixPos[0].length-1][1],
              height: 0.5,
              selectable: false 
            }));   
          } 
          
          for(var i=0; i<matrixPos[0].length; i++){
            fabricObj.push(new fabric.Rect({
              left: matrixPos[0][i][1],
              top: 0,
              fill: 'BLACK',
              width: 0.5,
              height: matrixPos[matrixPos.length-1][0][0],
              selectable: false 
            }));   
          }  
          delete i; 
          var group = new fabric.Group(fabricObj,{
            top: canvas.height/2,
            left: canvas.width/2,
            originX: 'center',
            originY: 'center',
            selectable: false
          });  
           
          for(var i=0; i<matrixPos.length-1; i++){
           matrixPos[i].pop();
          }
          matrixPos.pop(); 
 
          //1 start   
          var pathCounter = 0;
          var path = [];   

          function restartPath(){ 
            pathCounter = 0;
            path = []; 
            //Math.floor(Math.random()*10)+1;  // returns a random integer from 1 to 10
            path.push([Math.floor(Math.random()*(matrixPos.length-1))+0,Math.floor(Math.random()*(matrixPos[0].length-1))+0]); 
          }
          
          function calPath(){  
            var seqIter = [];      
            function addPathElement(){             
              //2 rndN candidates path          
              seqIter = [[-1,0],[1,0],[0,-1],[0,1]];
              seqIter.sort(function(a,b){
                // RANDOM ALGO PATHING
                var s = Math.random(); 
                return s-0.5;
              });
              
              for(var i=0; i<seqIter.length; i++){
                seqIter[i][0]=path[path.length-1][0]+seqIter[i][0];
                seqIter[i][1]=path[path.length-1][1]+seqIter[i][1];
              }
              
              //3 check candidates
              var seqIterOk = []; 
              for (var i =0; i<seqIter.length; i++){
                val = path.find(function(value,index){
                  return ((value[0]===seqIter[i][0])&&(value[1]===seqIter[i][1])); 
                });    
                val = val===undefined;  
                if((seqIter[i][0]>matrixPos.length-1)||(seqIter[i][0]<0)){
                  val = false;
                } 
                if((seqIter[i][1]>matrixPos[0].length-1)||(seqIter[i][1]<0)){
                  val = false;
                } 
                seqIterOk.push(val);
              }   

              if(seqIterOk.some(function(e){
                return e;
              })){  
                path.push(seqIter[seqIterOk.indexOf(true)]);
                addPathElement(); 
              }else{
                return;
              }  
            }
            addPathElement(); 
          } 

          var color = ['black','red', 'purple', 'blue', 'green', 'yellow', 'orange', 'brown', 'grey'];
          var colorPos = 0;
          function restartCanvasWithPath(){
            canvas.clear();
            canvas.add(group);  
            var rect = new fabric.Rect({
              left: group.left-group.width/2 + matrixPos[path[0][0]][path[0][1]][1],
              top: group.top-group.height/2 +matrixPos[path[0][0]][path[0][1]][0], 
              fill: color[colorPos],
              width: cc, 
              height: cc,
              selectable: false 
            }); 
            canvas.add(rect);
            canvas.renderAll();
          }
          
          restartPath();
          calPath();   
          restartCanvasWithPath();

          function animate(){  
            if(startStop){
              if(pathCounter<path.length-1){
                var rect = new fabric.Rect({
                  left: group.left-group.width/2 + matrixPos[path[pathCounter][0]][path[pathCounter][1]][1],
                  top: group.top-group.height/2 + matrixPos[path[pathCounter][0]][path[pathCounter][1]][0],   
                  fill: color[colorPos],
                  width: cc, 
                  height: cc,
                  selectable: false 
                });    
                canvas.add(rect);
                canvas.renderAll();   
                rect.animate({ 
                    left: group.left-group.width/2 + matrixPos[path[pathCounter+1][0]][path[pathCounter+1][1]][1],
                    top: group.top-group.height/2 + matrixPos[path[pathCounter+1][0]][path[pathCounter+1][1]][0], 
                  },{
                  duration: 25,
                  onChange: canvas.renderAll.bind(canvas),
                  onComplete: function(){ 
                    pathCounter++;
                    animate();
                  },
                  easing: fabric.util.ease.easeOutBack
                });
              }else{ 
                if (path.length>=15){ 
                  for (var i=0; i<15; i++){
                    pathCounter--;
                    path.pop();
                    canvas.remove(canvas.item(canvas.getObjects().length-1));
                  } 
                  if(path.length===0){ 
                    restartPath();
                    calPath(); 
                    restartCanvasWithPath(); 
                  }else{
                    calPath(); 
                    canvas.renderAll(); 
                  } 
                }else{  
                  restartPath();
                  calPath(); 
                  restartCanvasWithPath();
                } 
                animate(); 
              }   
            }   
          }  

          var startStop = false;          
          var diffTimeMS = 0;
          canvas.on({ 
            'mouse:down': function(options) { 
              diffTimeMS = options.e.timeStamp;   
              if(!startStop){ 
                toast('Start');
                startStop = true;
                if(path.length===0){ 
                  restartPath();
                  calPath(); 
                  restartCanvasWithPath(); 
                }
                animate(); 
              }else{
                colorPos++;
                if(colorPos>color.length-1){
                  colorPos=0;
                }
              }
            },
            'mouse:up': function(options) { 
              diffTimeMS=options.e.timeStamp-diffTimeMS; 
              if(diffTimeMS>500){
                toast('Stop');
                startStop = false; 
              }
            }
          });
          onOffLoading(false); 
        }
        
        function resize(){  
          $('#canvasContainer').innerHeight($(window).innerHeight()-50);
          $('#canvasContainer').html('<canvas id="canvas" ></canvas>');
          plotCanvas(); 
        }  
                 
        toast('Start: Press on screen'); 
        resize();
        $(window).on('resize',function(){
          window.location.reload();
          resize();
        }); 
      })();
    </script>
    <noscript>JAVASCRIPT NOT WORKING!</noscript>
  </body>
</html>
