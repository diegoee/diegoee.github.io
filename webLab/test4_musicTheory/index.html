<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Web test">  
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, minimal-ui"> 
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/uikit@3.9.2/dist/css/uikit.min.css" />
    <title>Web Test4_musicTheory</title>
    <style>  
      #version{
        position: absolute;
        margin: 0;
        padding: 0;
        top: 0;
        right: 5px;
        font-size: 0.75em;
      } 
      #header{
        background-color: #EEE;
      }
      .currentNote{
        color: #2196F3;
      }
      .colorPlay,.colorPlay:active,.colorPlay:hover{
        background-color: green;
      }
      .colorStop,.colorStop:active,.colorStop:hover{
        background-color: red;
      }  
      #playBtn{
        position: absolute; 
        bottom: 0;
        right: 5px;  
        z-index: 1; 
        border-radius: 5px;
      }
      #createBtn{
        position: absolute; 
        bottom: 0;
        left: 5px; 
        z-index: 1; 
        border-radius: 5px;
      }
      #main{
        color: #333;         
      }
      .uk-notification-close {
        display: block;
      }
    </style>
  </head>
  <body>
    <div id="version"></div>  
    <button id="createBtn" class="uk-button uk-button-primary uk-margin"><span uk-icon="refresh"></span></button> 
    <button id="playBtn"   class="uk-button uk-button-primary uk-margin colorPlay"><span uk-icon="play"></span></button> 
    <div id="header" class=""> 
      <button class="uk-button uk-button-default uk-button" uk-toggle="target: #modalMenu"><span uk-icon="menu"></span></button>        
    </div>
    <div id="main" class=></div>     
    <div id="modalMenu" uk-modal>
      <div class="uk-modal-dialog">
          <button class="uk-modal-close-default" type="button" uk-close></button>
          <div class="uk-modal-header"> 
              <h2 class="uk-modal-title">Menú</h2>
          </div>
          <div class="uk-modal-body" uk-overflow-auto> 
            <div uk-grid>
              <div>
                <label>Level</label>
                <select id="levelSelect" class="uk-select"> 
                <option value="0" selected>Easy</option>
                <option value="1">Medium</option>
                <option value="2">Hard</option>
                </select>
              </div>
              <div>
                <p> 
                  <input id="playIntro" type="checkbox" class="filled-in" checked="checked" disabled/>
                  <span>Play Intro</span> 
                </p> 
                <p> 
                  <input id="playBeats" type="checkbox" class="filled-in" checked="checked" disabled />
                  <span>Play background beat</span> 
                </p>
                <p> 
                  <input id="playCursor" type="checkbox" class="filled-in" checked="checked" disabled />
                  <span>Display Cursor</span> 
                </p> 
              </div>
            </div>
            <div class="uk-margin">  
              <p>Tempo (beats): (<span id="tempoBarValue"></span> bpm)</p>
              <div class="uk-margin">
                <input class="uk-range" type="range" value="60" id="tempoBar" min="40" max="150" step="1">
              </div>  
            </div> 
          </div> 
          <div class="uk-modal-footer uk-text-right"> 
          </div>
      </div>
    </div>
    <script type="text/javascript" src="https://code.jquery.com/jquery-3.2.1.min.js"></script>  
    <script src="https://cdn.jsdelivr.net/npm/uikit@3.9.2/dist/js/uikit.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/uikit@3.9.2/dist/js/uikit-icons.min.js"></script>   
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/abcjs@6.0.0-beta.35/dist/abcjs-basic-min.js"></script>   
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/tone/13.0.1/Tone.min.js"></script>          
    <script type="text/javascript">
    /*global $, UIkit, window, setTimeout, clearTimeout, Promise, Tone, ABCJS*/
    (function exe(){
      var abcjs=window.ABCJS;
      //versión
      $('#version').html('v1.0.0');
      //app
      var app = {  
        notes: [
          ['C',  'D',   'E', 'F', 'G', 'A', 'B', 'c'],
          ['A,', 'B,',  'C', 'D', 'E', 'F', 'G', 'A', 'B','c', 'd', 'e', 'f'],
          ['G,', 'A,', 'B,', 'C', 'D', 'E', 'F', 'G', 'A', 'B','c', 'd', 'e', 'f', 'g', 'a', 'b'],
        ], 
        timeSig: ['2/4', '3/4', '4/4', '6/8'],
        timeSigSel: undefined,
        level: 0,
        bpm: 40,
        musicSheet: undefined,
        playMusicSheet: undefined,
        synth: undefined,
        playBack: false,
        playIntro: false,
        playCursor: false,
        translateNote: function(note){
          var notesTranslator = [ 
            ['C,','D,','E,','F,','G,', 'A,','B,','C', 'D', 'E', 'F', 'G',  'A', 'B', 'c', 'd', 'e', 'f', 'g',  'a', 'b'],
            ['Do','Re','Mi','Fa','Sol','La','Si','Do','Re','Mi','Fa','Sol','La','Si','Do','Re','Mi','Fa','Sol','La','Si'],
          ];
          var res = notesTranslator[0].findIndex(function(e){
            return e===note;
          }); 
          res = notesTranslator[0][res] +' - '+notesTranslator[1][res]; 
          return res;
        },
        rndValue: function(arr){  
          var rndN = '';
          if(Array.isArray(arr)){
            //Math.floor(Math.random()*10)+1;  // returns a random integer from 1 to 10
            rndN = Math.floor(Math.random()*(arr.length));
            rndN=arr[rndN];
          }
          return rndN;
        }, 
        rndMusic: function(ts){  
          var level = this.level; 
          var song='';  
          var len=2*6; 
          var line=6;   
          for(var i=0; i<len; i++){
            if(i%line===0&&i!==0){
              song=song+'\n'; 
            }
            if(ts==='2/4'){
              song=song+this.rndValue(this.notes[level])+'4 '+this.rndValue(this.notes[level])+'4|';
            }
            if(ts==='3/4'){
              song = song+this.rndValue(this.notes[level])+'2 '+this.rndValue(this.notes[level])+'2 '+this.rndValue(this.notes[level])+'2|';
            }
            if(ts==='4/4'){
              song = song+this.rndValue(this.notes[level])+'2 '+this.rndValue(this.notes[level])+'2 '+this.rndValue(this.notes[level])+'2 '+this.rndValue(this.notes[level])+'2|';
            }
            if(ts==='6/8'){
              song = song+this.rndValue(this.notes[level])+'1'+this.rndValue(this.notes[level])+'1'+
              this.rndValue(this.notes[level])+'1 '+this.rndValue(this.notes[level])+'1'+
              this.rndValue(this.notes[level])+'1'+this.rndValue(this.notes[level])+'1|';
            }               
          }          
          return song;
        },
        createMusicSheet: function(clickFn){ 
          var abc =''
          abc =abc+'X:1\nK:C\n';
          this.timeSigSel=this.rndValue(this.timeSig);
          abc=abc+'M:'+this.timeSigSel+'\n';
          abc=abc+this.rndMusic(this.timeSigSel,this.level);  
          console.log(abc);
          this.musicSheet = abcjs.renderAbc("main",abc,{ 
            add_classes: true,
            responsive: "resize",
            clickListener: function(e){
              if(typeof clickFn==='function'){
                clickFn(e);
              }
            } 
          });  
        },
        play: function(endFn){ 
          intro = 0;
          if(app.playIntro){
            intro = 2;
          } 
          app.playMusicSheet = new ABCJS.TimingCallbacks(app.musicSheet[0], {
            qpm: app.bpm,
            extraMeasuresAtBeginning: intro,
            beatCallback: function(a,b,c,d){ 
              if(d.top!==undefined){
                $('.abcjs-time-signature').removeClass('currentNote'); 
              }else{ 
                $('.abcjs-time-signature').addClass('currentNote');
              }
              if(app.playBack){
                if(app.timeSigSel==='2/4'&&a%2===0){  
                  app.synth.triggerAttackRelease('A5','16n');
                }else if(app.timeSigSel==='3/4'&&a%3===0){ 
                  app.synth.triggerAttackRelease('A5','16n');
                }else if(app.timeSigSel==='4/4'&&a%4===0){ 
                  app.synth.triggerAttackRelease('A5','16n');
                }else if(app.timeSigSel==='6/8'&&a%2===0){ 
                  app.synth.triggerAttackRelease('A5','16n');
                }else{ 
                  app.synth.triggerAttackRelease('A4','16n');
                } 
              }
            },
            eventCallback: function(e){ 
              if(e===null){ 
                $('.abcjs-time-signature').removeClass('currentNote');
                $('.abcjs-note').removeClass('currentNote');
                if(typeof endFn==='function'){
                  endFn();
                }
              }else{ 
                if(app.playCursor){
                  $('.abcjs-note').removeClass('currentNote');
                  $(e.elements[0][0]).addClass('currentNote');
                }
              }
            }
          });
          app.playMusicSheet.start(); 
        }, 
        stop: function(){ 
          $('.abcjs-note').removeClass('currentNote');
          $('.abcjs-time-signature').removeClass('currentNote'); 
          try{
            app.playMusicSheet.stop();
          }catch(e){
            
          }
        }, 
        init: function (clickFn){  
          this.synth = new Tone.Synth().toMaster();  
          console.log('Bpm: '+this.bpm+', Level: '+this.level+', Play Intro: '+this.playIntro+', PlayBack: '+this.playBack+', PlayCursor: '+this.playCursor);
          app.stop(); 
          this.createMusicSheet(clickFn); 
        }
      }; 
      //actionWeb  
      var web = { 
        bpm: 60,
        level: 0,
        playIntro: true,
        playBack: true,
        playCursor: true,
        currentToast: undefined,  
        toast: function (data){
          if(this.currentToast!==undefined){
            this.currentToast.close(true);
          }
          this.currentToast = UIkit.notification({
              message: data,
              status: 'primary',
              pos: 'top-right',
              timeout: 50000
          }); 
        }, 
        resize: function(){  
          $('#main').innerHeight($(window).innerHeight()-$('#header').innerHeight()-20);  
        }, 
        btnToPlay: function(){  
          $('#playBtn').removeClass("colorStop");
          $('#playBtn').addClass("colorPlay");
          $($('#playBtn').find('span')).attr('uk-icon','play'); 
        },
        btnToStop: function(){  
          $('#playBtn').removeClass("colorPlay");
          $('#playBtn').addClass("colorStop"); 
          $($('#playBtn').find('span')).attr('uk-icon','ban');
        },
        resetMain: function(){
          $('#main').html(' ');
        },
        init: function (){ 
          $('#tempoBar').val(web.bpm);
          $('#tempoBarValue').html($('#tempoBar').val()); 
          $('#tempoBar').on('change',function(){ 
            $('#tempoBarValue').html($('#tempoBar').val()); 
            web.bpm=parseInt($('#tempoBar').val());
            syncAppValue();
          });
 
          $('#levelSelect').on('change',function(){   
            web.level=parseInt($('#levelSelect').val());
            web.toast('Level: '+$( "#levelSelect option:selected" ).text());
            syncAppValue();
          }); 
          
          $('#playBeats').attr('disabled',false); 
          $('#playBeats').attr('checked',web.playBack); 
          $('#playBeats').on('change',function(){   
            if($(this).is(":checked")){
              web.playBack=true;
            }else{ 
              web.playBack=false;
            }
            web.toast('Play BackGround Beat: '+(web.playBack?'ON':'OFF'));
            syncAppValue(); 
          }); 
          $('#playIntro').attr('disabled',false);
          $('#playIntro').attr('checked',web.playIntro); 
          $('#playIntro').on('change',function(){   
            if($(this).is(":checked")){
              web.playIntro=true;
            }else{ 
              web.playIntro=false;
            }
            web.toast('Play intro: '+(web.playIntro?'ON':'OFF'));
            syncAppValue(); 
          });

          $('#playCursor').attr('disabled',false);
          $('#playCursor').attr('checked',web.playCursor); 
          $('#playCursor').on('change',function(){   
            if($(this).is(":checked")){
              web.playCursor=true;
            }else{ 
              web.playCursor=false;
            }
            web.toast('Play with Cursor: '+(web.playCursor?'ON':'OFF'));
            syncAppValue(); 
          }); 

          $('#playBtn').attr('disabled',false);
          $('#playBtn').val(web.playBack);
          $('#playBtn').on('click',function(){  
            if($(this).hasClass("colorPlay")){
              web.btnToStop();
              app.play(function endFn(){ 
                web.btnToPlay();
              });
            }else{             
              web.btnToPlay();
              app.stop();
            } 
          });   
 
          $(window).on('resize',web.resize); 
          $('#createBtn').on('click',function(){   
            web.resetMain();
            web.btnToPlay();
            exeApp();
            web.resize();
          });  

          function syncAppValue(){ 
            app.bpm=web.bpm; 
            app.level=web.level; 
            app.playIntro=web.playIntro; 
            app.playBack=web.playBack;
            app.playCursor=web.playCursor;
          }
          function exeApp(){   
            syncAppValue();         
            app.init(function clickFn(a){ 
              web.toast(app.translateNote(a.pitches[0].name))             
            });            
          }
          web.resetMain(); 
          exeApp();
          web.resize();
          web.btnToPlay();
          web.toast('Start App');
          //setTimeout(function(){
          //  $($('button')[0]).trigger('click');
          //},1000);
        }        
      } 
      web.init();
    })();
    </script>
    <noscript>JAVASCRIPT NOT WORKING!</noscript>
  </body>
</html>
