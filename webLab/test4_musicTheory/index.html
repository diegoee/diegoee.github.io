<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Web test">  
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, minimal-ui"> 
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/uikit@3.9.2/dist/css/uikit.min.css" /> 
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/abcjs@6.0.0-beta.35/abcjs-audio.css" />
    <title>Web Test4_musicTheory</title>
    <style>  
      #version{
        position: absolute;
        margin: 0;
        padding: 0;
        top: 0;
        right: 5px;
        font-size: 0.75em;
      } 
      #header{
        background-color: #EEE;
      }
      .currentNote{
        color: #2196F3;
      }
      .colorPlay,.colorPlay:active,.colorPlay:hover{
        background-color: green;
      }
      .colorStop,.colorStop:active,.colorStop:hover{
        background-color: red;
      }   
      #createBtn{
        position: fixed; 
        bottom: 0;
        left: 5px;
        z-index: 1; 
        border-radius: 5px;
      } 
      #playBtn{
        position: fixed; 
        bottom: 0;
        right: 5px;
        z-index: 1; 
        border-radius: 5px;
        color: #fff;
      }  
      #playBtn.play{
        background-color: green;
      }       
      #playBtn.stop{
        background-color: #f0506e; 
      } 
      #main{
        color: #333;         
      }
      .uk-notification-close {
        display: block;
      }
      .center{
        display: flex;
        align-items: center;
        justify-content: center;
      } 
    </style>
  </head>
  <body>
    <div id="version"></div>  
    <button id="createBtn" class="uk-button uk-button-primary uk-margin" disabled><span uk-icon="refresh"></span></button> 
    <button id="playBtn" class="uk-button uk-button-primary uk-margin play" disabled><span uk-icon="play-circle"></span></button>  
    <div id="header" class=""> 
      <button class="uk-button uk-button-default uk-button" uk-toggle="target: #modalMenu" disabled><span uk-icon="menu"></span></button>
      <div class="uk-padding-small uk-padding-remove-bottom"><div id="control" class=></div></div>   
    </div>
    <div id="main" class="center"> 
      <div uk-spinner="ratio: 6"></div> 
    </div>     
    <div id="modalMenu" uk-modal>
      <div class="uk-modal-dialog">
          <button class="uk-modal-close-default" type="button" uk-close></button>
          <div class="uk-modal-header"> 
              <h2 class="uk-modal-title">Menú</h2>
          </div>
          <div class="uk-modal-body" uk-overflow-auto>  
            <div class="uk-margin">
              <label>Play Mode</label>
              <select id="modeSelect" class="uk-select"> 
              <option value="rndMode" selected>Random notes to practice</option>
              </select>
            </div>           
            <div uk-grid>
              <div>
                <label>Level</label>
                <select id="levelSelect" class="uk-select"> 
                <option value="0" selected>Easy</option>
                <option value="1">Medium</option>
                <option value="2">Hard</option>
                </select>
              </div>
              <div>
                <label>Actions</label>
                <select id="actionSelect" class="uk-select">  
                </select>
              </div> 
            </div>
            <div class="uk-margin">  
              <p>Tempo (beats): (<span id="tempoBarValue"></span> bpm)</p>
              <div class="uk-margin">
                <input class="uk-range" type="range" value="60" id="tempoBar" min="40" max="150" step="1">
              </div>  
            </div> 
          </div> 
          <div class="uk-modal-footer uk-text-right"> 
          </div>
      </div>
    </div>
    <script type="text/javascript" src="https://code.jquery.com/jquery-3.2.1.min.js"></script>  
    <script src="https://cdn.jsdelivr.net/npm/uikit@3.9.2/dist/js/uikit.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/uikit@3.9.2/dist/js/uikit-icons.min.js"></script>   
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/abcjs@6.0.0-beta.35/dist/abcjs-basic-min.js"></script>   
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/tone/13.0.1/Tone.min.js"></script>          
    <script type="text/javascript">
    /*global $, UIkit, window, setTimeout, clearTimeout, Promise, Tone, ABCJS*/
    (function exe(){
      var abcjs=window.ABCJS;
      //versión
      $('#version').html('v1.1.0');
      //app
      var app = {  
        notes: [
          ['C',  'D',   'E', 'F', 'G', 'A', 'B', 'c'],
          ['A,', 'B,',  'C', 'D', 'E', 'F', 'G', 'A', 'B','c', 'd', 'e', 'f'],
          ['G,', 'A,', 'B,', 'C', 'D', 'E', 'F', 'G', 'A', 'B','c', 'd', 'e', 'f', 'g', 'a', 'b'],
        ], 
        timeSig: ['2/4', '3/4', '4/4', '6/8'],
        timeSigSel: undefined,
        level: 0,
        bpm: 40,
        musicSheet: undefined,
        playMusicSheet: [undefined,undefined],
        synth: undefined,
        playBack: false,
        playIntro: false,
        playCursor: false,
        playNotes: false,
        mode: 'rndMode',
        songsListUrl: [],
        songs:[ 
          {id: 'songT', title:'Test - Diego E.', abc:'X:1\nT:Test\nC:Diego E.\nL:1/4\nM:2/4\nQ:80\nK:Bm\n_F^F|=FF|F2|f2|f\'2|'},          
        ],
        setTitleSongs: function(){
          for(var i=0; i<app.songs.length; i++){
            var t = app.songs[i].abc.substring(app.songs[i].abc.indexOf('T:'), app.songs[i].abc.length);
            t = t.substring(2, t.indexOf('\n'));
            var a = app.songs[i].abc.substring(app.songs[i].abc.indexOf('C:'), app.songs[i].abc.length);
            a = a.substring(2, a.indexOf('\n')); 
            if(a==='1'){
              app.songs[i].title = t;
            }else{
              app.songs[i].title = t+' - '+a;
            } 
          }
          app.songs.sort(function(a, b) {
            if (a.title > b.title) {
              return 1;
            }
            if (a.title < b.title) {
              return -1;
            } 
            return 0;
          }); 
        },
        getSongsFromUrls: function(){
          return new Promise(function(resolve, reject){  
            var pos=0; 
            for(var i=0; i<app.songsListUrl.length; i++){
              $.ajax({
                url: app.songsListUrl[i], 
                type: 'GET',
                success: function(res){  
                  app.songs.push({
                    id: 'song'+pos,
                    title: undefined,
                    abc: res
                  });
                  pos++; 
                  if(pos===app.songsListUrl.length){ 
                    app.setTitleSongs();
                    resolve();
                  }
                },
                error: function(){
                  reject("Error GET: "+app.songsListUrl[i]);
                }
              }); 
            } 
          });
        },
        getUrlSongsInGithub: function(){
          return new Promise(function(resolve, reject){ 
            $.ajax({
              url: 'https://api.github.com/repos/diegoee/diegoee.github.io/commits', 
              type: 'GET',
              success: function(res){ 
                res = res[0].sha;   
                $.ajax({
                  url: 'https://api.github.com/repos/diegoee/diegoee.github.io/git/trees/'+res, 
                  type: 'GET',
                  success: function(res){  
                    res=res.tree;  
                    for(var i=0; i<res.length; i++){
                      if (res[i].path===('webLab')){ 
                        break;
                      }
                    }   
                    res = res[i].sha; 
                    $.ajax({
                      url: 'https://api.github.com/repos/diegoee/diegoee.github.io/git/trees/'+res, 
                      type: 'GET',
                      success: function(res){  
                        res=res.tree;  
                        for(var i=0; i<res.length; i++){
                          if (res[i].path===('test4_musicTheory')){ 
                            break;
                          }
                        }   
                        res = res[i].sha; 
                        $.ajax({
                          url: 'https://api.github.com/repos/diegoee/diegoee.github.io/git/trees/'+res, 
                          type: 'GET',
                          success: function(res){  
                            res=res.tree; 
                            for(var i=0; i<res.length; i++){
                              if (res[i].path.indexOf('.abc')!==-1){  
                                app.songsListUrl.push('https://diegoee.github.io/webLab/test4_musicTheory/'+res[i].path); 
                              }
                            }   
                            resolve(); 
                          },
                          error: function(){
                            reject("Error with level 3: https://api.github.com");
                          }
                        });
                      },
                      error: function(){
                        reject("Error with level 2: https://api.github.com");
                      }
                    }); 
                  },
                  error: function(){
                    reject("Error with level 1: https://api.github.com");
                  }
                }); 
              },
              error: function(){
                reject("Error with level 0: https://api.github.com");
              } 
            });  
          });
        },
        translateNote: function(noteName,pitch,type){ 
          var notesPitchTranslator = [ 
            [ 48,    49,  50,   51,  52,  53,  54,     55,    56, 57,    58, 59 ],  
            [  3,     3,   3,    3,   3,   3,    3,     3,     3,   3,    3,  3 ],
            ['C',  'C#', 'D', 'D#', 'E', 'F',  'F#',  'G',  'G#', 'A', 'A#', 'B'],
            ['Do','Do#','Re','Re#','Mi','Fa', 'Fa#','Sol','sol#','La','La#','Si'],
            ['C',  'Db', 'D', 'Eb', 'E', 'F',  'Gb',  'G',  'Ab', 'A', 'Bb', 'B'],
            ['Do','Reb','Re','Mib','Mi','Fa','Solb','Sol', 'Lab','La','Sib','Si'],
          ]; 
          var l = notesPitchTranslator[0].length;
          for (var i=0;i<4;i++){
            for (var ii=0;ii<l;ii++){
              notesPitchTranslator[0].push(notesPitchTranslator[0][notesPitchTranslator[0].length-1]+1);
              notesPitchTranslator[1].push(4+i);
              notesPitchTranslator[2].push(notesPitchTranslator[2][ii]);
              notesPitchTranslator[3].push(notesPitchTranslator[3][ii]);
              notesPitchTranslator[4].push(notesPitchTranslator[4][ii]);
              notesPitchTranslator[5].push(notesPitchTranslator[5][ii]);
            }
          }  
          var res = notesPitchTranslator[0].findIndex(function(e){
            return e===pitch;
          });   
          res = notesPitchTranslator[2][res]+notesPitchTranslator[1][res]; 
 
          if(type===1){ //type=1 mode text  
            res = notesPitchTranslator[0].findIndex(function(e){
              return e===pitch;
            });       
            if(noteName.indexOf('_')!==-1) { //bemol 
              res = notesPitchTranslator[4][res]+' - '+notesPitchTranslator[5][res]; 
            }else if(noteName.indexOf('^')!==-1) { //sostenido 
              res = notesPitchTranslator[2][res]+' - '+notesPitchTranslator[3][res];
            }else{ 
              res = notesPitchTranslator[2][res]+' - '+notesPitchTranslator[3][res];
            }             
          }          
          return res;
        },
        rndValue: function(arr){  
          var rndN = '';
          if(Array.isArray(arr)){
            //Math.floor(Math.random()*10)+1;  // returns a random integer from 1 to 10
            rndN = Math.floor(Math.random()*(arr.length));
            rndN=arr[rndN];
          }
          return rndN;
        }, 
        rndMusic: function(ts){  
          var level = this.level; 
          var song='';  
          var len=2*6; 
          var line=6;   
          for(var i=0; i<len; i++){
            if(i%line===0&&i!==0){
              song=song+'\n'; 
            }
            if(ts==='2/4'){
              song=song+this.rndValue(this.notes[level])+'4 '+this.rndValue(this.notes[level])+'4|';
            }
            if(ts==='3/4'){
              song = song+this.rndValue(this.notes[level])+'2 '+this.rndValue(this.notes[level])+'2 '+this.rndValue(this.notes[level])+'2|';
            }
            if(ts==='4/4'){
              song = song+this.rndValue(this.notes[level])+'2 '+this.rndValue(this.notes[level])+'2 '+this.rndValue(this.notes[level])+'2 '+this.rndValue(this.notes[level])+'2|';
            }
            if(ts==='6/8'){
              song = song+this.rndValue(this.notes[level])+'1'+this.rndValue(this.notes[level])+'1'+
              this.rndValue(this.notes[level])+'1 '+this.rndValue(this.notes[level])+'1'+
              this.rndValue(this.notes[level])+'1'+this.rndValue(this.notes[level])+'1|';
            }               
          }          
          return song;
        },
        createMusicSheet: function(clickFn){ 
          var abc =''
          if(app.mode==='rndMode'){
            abc =abc+'X:1\nK:C\n';
            abc =abc+'Q: 1/4='+app.bpm+'\n'; 
            app.timeSigSel=app.rndValue(app.timeSig);
            abc=abc+'M:'+app.timeSigSel+'\n';
            abc=abc+app.rndMusic(app.timeSigSel,app.level);
          }else{
            var i=0;
            i = app.songs.findIndex(function(e){
              return e.id==app.mode;
            });  
            app.timeSigSel='';
            app.timeSigSel=app.timeSigSel+(app.songs[i].abc.indexOf('M:2/4')!==-1?'2/4':'');
            app.timeSigSel=app.timeSigSel+(app.songs[i].abc.indexOf('M:3/4')!==-1?'3/4':'');
            app.timeSigSel=app.timeSigSel+(app.songs[i].abc.indexOf('M:4/4')!==-1?'4/4':'');
            app.timeSigSel=app.timeSigSel+(app.songs[i].abc.indexOf('M:6/8')!==-1?'6/8':''); 
            abc=app.songs[i].abc;            
          }
          app.musicSheet = abcjs.renderAbc("main",abc,{ 
            add_classes: true,
            responsive: "resize",
            clickListener: function(e){
              var noteText = app.translateNote(e.pitches[0].name,e.midiPitches[0].pitch,1);  
              if(typeof clickFn==='function'){
                clickFn(noteText);
              } 
              var note = app.translateNote(e.pitches[0].name,e.midiPitches[0].pitch,0);
              app.synth.triggerAttackRelease(note,'8n');
            } 
          });  
        },       
        stop: function(){ 
          $('.abcjs-note').removeClass('currentNote');
          $('.abcjs-time-signature').removeClass('currentNote'); 
          app.isPlaying=false;
          try{
            app.playMusicSheet[0].pause();
            app.playMusicSheet[0].restart();
            app.playMusicSheet[1].stop();
          }catch(e){
            
          }
        }, 
        init: function (clickFn,endFn,finishPlayFn){  
          this.synth = new Tone.Synth().toMaster();  
          console.log('Bpm: '+this.bpm+', Level: '+this.level+', Play Intro: '+this.playIntro+', PlayBeats: '+this.playBack+', PlayCursor: '+this.playCursor+', PlayNotes: '+this.playNotes);
          app.stop(); 
          this.createMusicSheet(clickFn); 

          var subBeat=1;
          var beat=1;
          if(app.timeSigSel==='2/4'){  
            beat=2;
          }else if(app.timeSigSel==='3/4'){ 
            beat=3;
          }else if(app.timeSigSel==='4/4'){ 
            beat=4;
          }else 
          if(app.timeSigSel==='6/8'){ 
            subBeat=3;
            beat=2;
          }
          var intro = 0;
          if(app.playIntro){
            intro = 2;
          } 
          app.playMusicSheet[0] = new ABCJS.synth.SynthController();
          app.playMusicSheet[0].load("#control", {
            beatSubdivisions: subBeat,
            extraMeasuresAtBeginning: intro,
            onStart: function() {    
              $('.abcjs-note').removeClass('currentNote');
              $('.abcjs-rest').removeClass('currentNote'); 
              $('.abcjs-time-signature').removeClass('currentNote');
              $('.abcjs-time-signature').addClass('currentNote');
            },
            onFinished: function() {    
              $('.abcjs-time-signature').removeClass('currentNote');
              $('.abcjs-note').removeClass('currentNote'); 
              if(typeof finishPlayFn==='function'){
                finishPlayFn();
              }
            },
            onBeat: function(beatNumber) {   
              function metro(){
                if(beatNumber%beat===0){ 
                  app.synth.triggerAttackRelease('A5','16n');
                }else{ 
                  app.synth.triggerAttackRelease('A4','16n');
                }
              }
              if(beatNumber<beat*subBeat*intro){ 
                metro(); 
              }else{ 
                if(app.playBack){ 
                  metro();
                } 
              }
            },
            onEvent: function(event) {  
              $('.abcjs-time-signature').removeClass('currentNote');
              if(app.playCursor){        
                $('.abcjs-note').removeClass('currentNote');
                $('.abcjs-rest').removeClass('currentNote');
                try{
                  $(event.elements[0][0]).addClass('currentNote');
                }catch(e){
                  console.error(e);
                }
              }
            }
          },{
            displayRestart: true, 
            displayPlay: true, 
            displayProgress: true 
          });
 
          app.playMusicSheet[1] = new ABCJS.synth.CreateSynth(); 
          app.playMusicSheet[1].init({  
            visualObj: app.musicSheet[0]
          }).then(function (results){
            app.playMusicSheet[0].setTune( app.musicSheet[0],false,{ 
              soundFontVolumeMultiplier: (app.playNotes?'1':'0') //'0' sound off
            }).then(function (response) {
              console.log("Audio successfully loaded.");
              if(typeof endFn==='function'){
                endFn();
              }
            }).catch(function (error) {
              console.warn("Audio problem:", error);
            });
          }).catch(function (reason) {
            console.log(reason);
          }); 

        }
      }; 
      //actionWeb  
      var web = { 
        bpm: 60,
        level: 0,
        playIntro: true,
        playBack: true,
        playCursor: true,
        playNotes: false,        
        currentToast: undefined,
        mode: 'rndMode', 
        toast: function (data){
          if(this.currentToast!==undefined){
            this.currentToast.close(true);
          }
          this.currentToast = UIkit.notification({
              message: data,
              status: 'primary',
              pos: 'top-right',
              timeout: 4000
          }); 
        }, 
        resize: function(){  
          $('#main').innerHeight($(window).innerHeight()-$('#header').innerHeight()-20);  
        },
        resetMain: function(){
          $('#main').html(' ');
          web.resetPlayBtn();
          $('button').attr('disabled',false);
        },
        initInputElements:function(){
          $('#tempoBar').val(web.bpm);
          $('#tempoBarValue').html($('#tempoBar').val()); 
          $('#tempoBar').on('change',function(){ 
            $('#tempoBarValue').html($('#tempoBar').val()); 
            web.bpm=parseInt($('#tempoBar').val());
            web.syncAppValue();
            web.exeApp(); 
            web.resetPlayBtn();
          });

          $('#levelSelect').on('change',function(){   
            web.level=parseInt($('#levelSelect').val());
            web.toast('Level: '+$( "#levelSelect option:selected" ).text());
            web.syncAppValue(); 
          }); 

          $('#actionSelect').html(' '); 
          $('#actionSelect').append('<option value="00" selected>Play Intro - Play beat  - Display Cursor</option>');
          //$('#actionSelect').append('<option value="01"         >Play Intro - Play beat </option>');
          $('#actionSelect').append('<option value="02"         >Play Intro - Display Cursor </option>');
          //$('#actionSelect').append('<option value="03"         >Play Intro</option>');
          //$('#actionSelect').append('<option value="04"         >Play beat  - Play Notes - Display Cursor</option>');
          //$('#actionSelect').append('<option value="05"         >Play beat  - Play Notes</option>');
          //$('#actionSelect').append('<option value="06"         >Play beat  - Display Cursor</option>');
          //$('#actionSelect').append('<option value="07"         >Play beat</option>'); 
          $('#actionSelect').append('<option value="08"         >Play Notes - Display Cursor</option>');
          //$('#actionSelect').append('<option value="09"         >Play Notes</option>'); 
          $('#actionSelect').append('<option value="10"         >Display Cursor</option>');           
          $('#actionSelect').on('change',function(){   
            var value=$('#actionSelect').val();
            if(value==='00'){ web.playIntro=true;  web.playBack=true;  web.playCursor=true;  web.playNotes=false; } 
            if(value==='01'){ web.playIntro=true;  web.playBack=true;  web.playCursor=false; web.playNotes=false; }
            if(value==='02'){ web.playIntro=true;  web.playBack=false; web.playCursor=true;  web.playNotes=false; }
            if(value==='03'){ web.playIntro=true;  web.playBack=false; web.playCursor=false; web.playNotes=false; }
            if(value==='04'){ web.playIntro=false; web.playBack=true;  web.playCursor=true;  web.playNotes=true;  }
            if(value==='05'){ web.playIntro=false; web.playBack=true;  web.playCursor=false; web.playNotes=true;  }
            if(value==='06'){ web.playIntro=false; web.playBack=true;  web.playCursor=true;  web.playNotes=false; }
            if(value==='07'){ web.playIntro=false; web.playBack=true;  web.playCursor=false; web.playNotes=false; }
            if(value==='08'){ web.playIntro=false; web.playBack=false; web.playCursor=true;  web.playNotes=true;  }
            if(value==='09'){ web.playIntro=false; web.playBack=false; web.playCursor=false; web.playNotes=true;  }
            if(value==='10'){ web.playIntro=false; web.playBack=false; web.playCursor=true;  web.playNotes=false; }
            web.toast($( "#actionSelect option:selected" ).text());
            web.syncAppValue();
            web.exeApp(); 
            web.resetPlayBtn();
          });           

          $('#createBtn').on('click',function(){   
            web.resetMain();
            web.exeApp();
            web.resize();
          });

          web.resetPlayBtn();
          $('#playBtn').on('click',function(){
            $('.abcjs-midi-start').trigger('click');
          });
  
          $.each(app.songs,function(i,e){  
            $('#modeSelect').append('<option value="'+app.songs[i].id+'">'+app.songs[i].title+'</option>'); 
          });

          web.mode = $('#modeSelect').val();
          $('#modeSelect').on('change',function(){   
            web.mode = $('#modeSelect').val();
            if(web.mode!=='rndMode'){
              web.toast('Song: '+$( "#modeSelect option:selected" ).text());
            }else{
              web.toast($( "#modeSelect option:selected" ).text());
            } 
            web.syncAppValue(); 
            web.exeApp();
            web.resetPlayBtn();
          }); 
        },
        resetPlayBtn: function(){ 
          var $e = $('#playBtn');
          $e.removeClass('stop');
          $e.addClass('play');
          $e.html('<span uk-icon="play-circle"></span>'); 
        },
        endLoadSongFn: function(){
          $('.abcjs-midi-start').on('click',function(){  
            var $e = $('#playBtn');
            if($e.hasClass('play')){
              $e.removeClass('play');
              $e.addClass('stop');
              $e.html('<span uk-icon="ban"></span>'); 
            }else{ 
              $e.removeClass('stop');
              $e.addClass('play');
              $e.html('<span uk-icon="play-circle"></span>'); 
            };        
          });   
        },
        syncAppValue: function(){ 
          app.bpm=web.bpm; 
          app.level=web.level; 
          app.playIntro=web.playIntro; 
          app.playBack=web.playBack;
          app.playCursor=web.playCursor;
          app.playNotes=web.playNotes;
          app.mode=web.mode;
        },
        exeApp: function(){
          web.syncAppValue();         
          app.init(function clickFn(noteText){ 
            web.toast(noteText);             
          },function endFn(){ 
            web.endLoadSongFn();             
          },function finishPlayFn(){ 
            web.resetPlayBtn();             
          });
        },
        init: function (){  
          $(window).on('resize',web.resize); 
          web.resize();
          app.getUrlSongsInGithub().then(function() {
            return app.getSongsFromUrls();
          }).then(function() { 
            web.initInputElements();  
            web.resetMain(); 
            web.exeApp();
            web.toast('Start App');  
            setTimeout(function(){
              //$($('button')[1]).trigger('click');
              //$('#actionSelect').val('08');  
              //$('#modeSelect').val('song1');  
              //$('#actionSelect').trigger('change'); 
              setTimeout(function(){
                //$('#modeSelect').trigger('change'); 
                setTimeout(function(){ 
                  //$('#playBtn').trigger('click'); 
                },1000); 
              },1000);
            },1000);
          }).catch(function(reason) {
            console.error(reason);
          });       
        }        
      } 
      web.init();
    })();
    </script>
    <noscript>JAVASCRIPT NOT WORKING!</noscript>
  </body>
</html>
