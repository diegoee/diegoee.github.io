<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Web test">  
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, minimal-ui"> 
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/uikit@3.9.2/dist/css/uikit.min.css" /> 
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/abcjs@6.0.0-beta.35/abcjs-audio.css" />
    <title>Web Test4_musicTheory</title>
    <style>  
      #version{
        position: absolute;
        margin: 0;
        padding: 0;
        top: 0;
        right: 5px;
        font-size: 0.75em;
      } 
      #header{
        background-color: #EEE;
      }
      .currentNote{
        color: #2196F3;
      }
      .colorPlay,.colorPlay:active,.colorPlay:hover{
        background-color: green;
      }
      .colorStop,.colorStop:active,.colorStop:hover{
        background-color: red;
      }   
      #createBtn{
        position: fixed; 
        bottom: 0;
        right: 5px;
        z-index: 1; 
        border-radius: 5px;
      }
      #main{
        color: #333;         
      }
      .uk-notification-close {
        display: block;
      }
    </style>
  </head>
  <body>
    <div id="version"></div>  
    <button id="createBtn" class="uk-button uk-button-primary uk-margin"><span uk-icon="refresh"></span></button>  
    <div id="header" class=""> 
      <button class="uk-button uk-button-default uk-button" uk-toggle="target: #modalMenu"><span uk-icon="menu"></span></button>
      <div class="uk-padding-small uk-padding-remove-bottom"><div id="control" class=></div></div>   
    </div>
    <div id="main" class=></div>     
    <div id="modalMenu" uk-modal>
      <div class="uk-modal-dialog">
          <button class="uk-modal-close-default" type="button" uk-close></button>
          <div class="uk-modal-header"> 
              <h2 class="uk-modal-title">Menú</h2>
          </div>
          <div class="uk-modal-body" uk-overflow-auto>  
            <div class="uk-margin">
              <label>Play Mode</label>
              <select id="modeSelect" class="uk-select"> 
              <option value="rndMode" selected>Random notes to practice</option>
              </select>
            </div>           
            <div uk-grid>
              <div>
                <label>Level</label>
                <select id="levelSelect" class="uk-select"> 
                <option value="0" selected>Easy</option>
                <option value="1">Medium</option>
                <option value="2">Hard</option>
                </select>
              </div>
              <div>
                <label>Actions</label>
                <select id="actionSelect" class="uk-select">  
                </select>
              </div> 
            </div>
            <div class="uk-margin">  
              <p>Tempo (beats): (<span id="tempoBarValue"></span> bpm)</p>
              <div class="uk-margin">
                <input class="uk-range" type="range" value="60" id="tempoBar" min="40" max="150" step="1">
              </div>  
            </div> 
          </div> 
          <div class="uk-modal-footer uk-text-right"> 
          </div>
      </div>
    </div>
    <script type="text/javascript" src="https://code.jquery.com/jquery-3.2.1.min.js"></script>  
    <script src="https://cdn.jsdelivr.net/npm/uikit@3.9.2/dist/js/uikit.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/uikit@3.9.2/dist/js/uikit-icons.min.js"></script>   
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/abcjs@6.0.0-beta.35/dist/abcjs-basic-min.js"></script>   
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/tone/13.0.1/Tone.min.js"></script>          
    <script type="text/javascript">
    /*global $, UIkit, window, setTimeout, clearTimeout, Promise, Tone, ABCJS*/
    (function exe(){
      var abcjs=window.ABCJS;
      //versión
      $('#version').html('v1.0.0');
      //app
      var app = {  
        notes: [
          ['C',  'D',   'E', 'F', 'G', 'A', 'B', 'c'],
          ['A,', 'B,',  'C', 'D', 'E', 'F', 'G', 'A', 'B','c', 'd', 'e', 'f'],
          ['G,', 'A,', 'B,', 'C', 'D', 'E', 'F', 'G', 'A', 'B','c', 'd', 'e', 'f', 'g', 'a', 'b'],
        ], 
        timeSig: ['2/4', '3/4', '4/4', '6/8'],
        timeSigSel: undefined,
        level: 0,
        bpm: 40,
        musicSheet: undefined,
        playMusicSheet: [undefined,undefined],
        synth: undefined,
        playBack: false,
        playIntro: false,
        playCursor: false,
        playNotes: false,
        mode: 'rndMode',
        songs:[ 
          {id: 'song1', title:'Ode To Joy (Intro) - Beethoven', abc:'X:1\nT:Ode To Joy (Intro)\nC:Beethoven\nL:1/4\nM:4/4\nQ:120\nK:c\nEEFG|GFED|CCDE|EDD2|\nEEFG|GFED|CCDE|DCC2|]'},
          {id: 'song2', title:'Greensleeves', abc:'X:1\nT:Greensleeves\nR:Air\nC:Trad. 16C\nO:England\nM:3/4\nL:1/8\nQ:1/4=120\nK:Em\nE2|"Em"G4A2|"G"B3cB2|"D"A4F2|"Bm"D3EF2|"Em"G4E2|E3^DE2|"B"F4^D2|B,4E2|\n"Em"G4A2|"G"B3cB2|"D"A4F2|"Bm"D3EF2|"Em"G3FE2|"B"^D3^C^D2|"Em"E6-|E4z2|\n"G"d6|d3^cB2|"D"A4F2|D3EF2|"Em"G4E2|E3^DE2|"B"F4^D2|B,6|\n"G"d6|d3^cB2|"D"A4F2|D3EF2|"Em"G4E2|"B"^D3^C^D2|"Em"E6-|E4|]\n'},
          {id: 'song3', title:'Minuetto - Adaptado de James Hook', abc:'X:1\nT:MINUETTO\nC:Adaptado de un minueto de James Hook\nL:1/4\nM:3/4\nQ:80\nK:C\nz2c|FFA|(AG)c|GG_B|(_BA)c|\nFFF|AAA|(A_B)G|F2c|FFA|(AG)c|\nGG_B|(_BA)c|FFF|ccc|(A_B)G|F2z|]\n'},
          {id: 'song4', title:'Aria - Friedrich Gluck', abc:'X:1\nT:ARIA\nC:Friedrich Gluck\nL:1/4\nM:3/4\nQ:80\nK:C\nz2C|A2A|(AG)A|_B2G|E2C|F2F|\n(FEF)|(G3|G)zG|G2G|(GA_B)|c3|D2G|\nF2F|(GFG)|(A3|A)zA|(AG)G|(GA_B)|\nc2c|(c_B)A|F2F|(A2G)|(F3|F)z|]'},
        ],
        translateNote: function(note,type){
          var notesTranslator = [ 
            ['C,','D,','E,','F,','G,', 'A,','B,','C', 'D', 'E', 'F', 'G',  'A', 'B', 'c', 'd', 'e', 'f', 'g',  'a', 'b'],  //ABC Anotation
            ['Do','Re','Mi','Fa','Sol','La','Si','Do','Re','Mi','Fa','Sol','La','Si','Do','Re','Mi','Fa','Sol','La','Si'], //Latin text
            ['C3','D3','E3','F3','G3', 'A3','B3','C4','D4','E4','F4','G4', 'A4','B4','C5','D5','E5','F5','G5', 'A5', 'B5'],//Tonejs
          ];
          var noteSearch=note.replace('_', '').replace('^', '');
          var res = notesTranslator[0].findIndex(function(e){
            return e===noteSearch;
          }); 
          var alt = (note.indexOf('^')!==-1)?'#':(note.indexOf('_')!==-1)?'b':'';
          //type=1 mode text
          if(type===1){
            res = notesTranslator[0][res]+alt+' - '+notesTranslator[1][res]+alt; 
          //type=dafult mode tonejs
          }else{ 
            res = notesTranslator[2][res][0]+alt+notesTranslator[2][res][1]; 
          }          
          return res;
        },
        rndValue: function(arr){  
          var rndN = '';
          if(Array.isArray(arr)){
            //Math.floor(Math.random()*10)+1;  // returns a random integer from 1 to 10
            rndN = Math.floor(Math.random()*(arr.length));
            rndN=arr[rndN];
          }
          return rndN;
        }, 
        rndMusic: function(ts){  
          var level = this.level; 
          var song='';  
          var len=2*6; 
          var line=6;   
          for(var i=0; i<len; i++){
            if(i%line===0&&i!==0){
              song=song+'\n'; 
            }
            if(ts==='2/4'){
              song=song+this.rndValue(this.notes[level])+'4 '+this.rndValue(this.notes[level])+'4|';
            }
            if(ts==='3/4'){
              song = song+this.rndValue(this.notes[level])+'2 '+this.rndValue(this.notes[level])+'2 '+this.rndValue(this.notes[level])+'2|';
            }
            if(ts==='4/4'){
              song = song+this.rndValue(this.notes[level])+'2 '+this.rndValue(this.notes[level])+'2 '+this.rndValue(this.notes[level])+'2 '+this.rndValue(this.notes[level])+'2|';
            }
            if(ts==='6/8'){
              song = song+this.rndValue(this.notes[level])+'1'+this.rndValue(this.notes[level])+'1'+
              this.rndValue(this.notes[level])+'1 '+this.rndValue(this.notes[level])+'1'+
              this.rndValue(this.notes[level])+'1'+this.rndValue(this.notes[level])+'1|';
            }               
          }          
          return song;
        },
        createMusicSheet: function(clickFn){ 
          var abc =''
          if(app.mode==='rndMode'){
            abc =abc+'X:1\nK:C\n';
            abc =abc+'Q: 1/4='+app.bpm+'\n'; 
            app.timeSigSel=app.rndValue(app.timeSig);
            abc=abc+'M:'+app.timeSigSel+'\n';
            abc=abc+app.rndMusic(app.timeSigSel,app.level);
          }else{
            var i=0;
            i = app.songs.findIndex(function(e){
              return e.id==app.mode;
            });  
            app.timeSigSel='';
            app.timeSigSel=app.timeSigSel+(app.songs[i].abc.indexOf('M:2/4')!==-1?'2/4':'');
            app.timeSigSel=app.timeSigSel+(app.songs[i].abc.indexOf('M:3/4')!==-1?'3/4':'');
            app.timeSigSel=app.timeSigSel+(app.songs[i].abc.indexOf('M:4/4')!==-1?'4/4':'');
            app.timeSigSel=app.timeSigSel+(app.songs[i].abc.indexOf('M:6/8')!==-1?'6/8':''); 
            abc=app.songs[i].abc;            
          }
          app.musicSheet = abcjs.renderAbc("main",abc,{ 
            add_classes: true,
            responsive: "resize",
            clickListener: function(e){
              var note = app.translateNote(e.pitches[0].name);
              app.synth.triggerAttackRelease(note,'8n');
              var noteText = app.translateNote(e.pitches[0].name,1);
              if(typeof clickFn==='function'){
                clickFn(noteText);
              }
            } 
          });  
        },       
        stop: function(){ 
          $('.abcjs-note').removeClass('currentNote');
          $('.abcjs-time-signature').removeClass('currentNote'); 
          app.isPlaying=false;
          try{
            app.playMusicSheet[0].pause();
            app.playMusicSheet[0].restart();
            app.playMusicSheet[1].stop();
          }catch(e){
            
          }
        }, 
        init: function (clickFn){  
          this.synth = new Tone.Synth().toMaster();  
          console.log('Bpm: '+this.bpm+', Level: '+this.level+', Play Intro: '+this.playIntro+', PlayBeats: '+this.playBack+', PlayCursor: '+this.playCursor+', PlayNotes: '+this.playNotes);
          app.stop(); 
          this.createMusicSheet(clickFn); 

          var subBeat=1;
          var beat=1;
          if(app.timeSigSel==='2/4'){  
            beat=2;
          }else if(app.timeSigSel==='3/4'){ 
            beat=3;
          }else if(app.timeSigSel==='4/4'){ 
            beat=4;
          }else 
          if(app.timeSigSel==='6/8'){ 
            subBeat=3;
            beat=2;
          }
          var intro = 0;
          if(app.playIntro){
            intro = 2;
          } 
          app.playMusicSheet[0] = new ABCJS.synth.SynthController();
          app.playMusicSheet[0].load("#control", {
            beatSubdivisions: subBeat,
            extraMeasuresAtBeginning: intro,
            onStart: function() {    
              $('.abcjs-note').removeClass('currentNote');
              $('.abcjs-rest').removeClass('currentNote'); 
              $('.abcjs-time-signature').removeClass('currentNote');
              $('.abcjs-time-signature').addClass('currentNote');
            },
            onFinished: function() {    
              $('.abcjs-time-signature').removeClass('currentNote');
              $('.abcjs-note').removeClass('currentNote');
            },
            onBeat: function(beatNumber) {  
              //console.log(beatNumber);
              function metro(){
                if(beatNumber%beat===0){ 
                  app.synth.triggerAttackRelease('A5','16n');
                }else{ 
                  app.synth.triggerAttackRelease('A4','16n');
                }
              }
              if(beatNumber<beat*subBeat*intro){ 
                metro(); 
              }else{ 
                if(app.playBack){ 
                  metro();
                } 
              }
            },
            onEvent: function(event) {   
              $('.abcjs-time-signature').removeClass('currentNote');
              if(app.playCursor){        
                $('.abcjs-note').removeClass('currentNote');
                $('.abcjs-rest').removeClass('currentNote');
                try{
                  $(event.elements[0][0]).addClass('currentNote');
                }catch(e){
                  console.error(e);
                }
              }
            }
          },{
            displayRestart: true, 
            displayPlay: true, 
            displayProgress: true 
          });
 
          app.playMusicSheet[1] = new ABCJS.synth.CreateSynth(); 
          app.playMusicSheet[1].init({  
            visualObj: app.musicSheet[0]
          }).then(function (results){
            app.playMusicSheet[0].setTune( app.musicSheet[0],false,{ 
              soundFontVolumeMultiplier: (app.playNotes?'1':'0') //'0' sound off
            }).then(function (response) {
              console.log("Audio successfully loaded.");
            }).catch(function (error) {
              console.warn("Audio problem:", error);
            });
          }).catch(function (reason) {
            console.log(reason);
          }); 

        }
      }; 
      //actionWeb  
      var web = { 
        bpm: 60,
        level: 0,
        playIntro: true,
        playBack: true,
        playCursor: true,
        playNotes: false,        
        currentToast: undefined,
        mode: 'rndMode', 
        toast: function (data){
          if(this.currentToast!==undefined){
            this.currentToast.close(true);
          }
          this.currentToast = UIkit.notification({
              message: data,
              status: 'primary',
              pos: 'top-right',
              timeout: 4000
          }); 
        }, 
        resize: function(){  
          $('#main').innerHeight($(window).innerHeight()-$('#header').innerHeight()-20);  
        },
        resetMain: function(){
          $('#main').html(' ');
        },
        initInputElements:function(){
          $('#tempoBar').val(web.bpm);
          $('#tempoBarValue').html($('#tempoBar').val()); 
          $('#tempoBar').on('change',function(){ 
            $('#tempoBarValue').html($('#tempoBar').val()); 
            web.bpm=parseInt($('#tempoBar').val());
            web.syncAppValue();
            web.exeApp();
          });

          $('#levelSelect').on('change',function(){   
            web.level=parseInt($('#levelSelect').val());
            web.toast('Level: '+$( "#levelSelect option:selected" ).text());
            web.syncAppValue();
          }); 

          $('#actionSelect').html(' '); 
          $('#actionSelect').append('<option value="00" selected>Play Intro - Play beat  - Display Cursor</option>');
          $('#actionSelect').append('<option value="01"         >Play Intro - Play beat </option>');
          $('#actionSelect').append('<option value="02"         >Play Intro - Display Cursor </option>');
          $('#actionSelect').append('<option value="03"         >Play Intro</option>');
          $('#actionSelect').append('<option value="04"         >Play beat  - Play Notes - Display Cursor</option>');
          $('#actionSelect').append('<option value="05"         >Play beat  - Play Notes</option>');
          $('#actionSelect').append('<option value="06"         >Play beat  - Display Cursor</option>');
          $('#actionSelect').append('<option value="07"         >Play beat</option>'); 
          $('#actionSelect').append('<option value="08"         >Play Notes - Display Cursor</option>');
          $('#actionSelect').append('<option value="09"         >Play Notes</option>'); 
          $('#actionSelect').append('<option value="10"         >Display Cursor</option>');           
          $('#actionSelect').on('change',function(){   
            var value=$('#actionSelect').val();
            if(value==='00'){ web.playIntro=true;  web.playBack=true;  web.playCursor=true;  web.playNotes=false; } 
            if(value==='01'){ web.playIntro=true;  web.playBack=true;  web.playCursor=false; web.playNotes=false; }
            if(value==='02'){ web.playIntro=true;  web.playBack=false; web.playCursor=true;  web.playNotes=false; }
            if(value==='03'){ web.playIntro=true;  web.playBack=false; web.playCursor=false; web.playNotes=false; }
            if(value==='04'){ web.playIntro=false; web.playBack=true;  web.playCursor=true;  web.playNotes=true;  }
            if(value==='05'){ web.playIntro=false; web.playBack=true;  web.playCursor=false; web.playNotes=true;  }
            if(value==='06'){ web.playIntro=false; web.playBack=true;  web.playCursor=true;  web.playNotes=false; }
            if(value==='07'){ web.playIntro=false; web.playBack=true;  web.playCursor=false; web.playNotes=false; }
            if(value==='08'){ web.playIntro=false; web.playBack=false; web.playCursor=true;  web.playNotes=true;  }
            if(value==='09'){ web.playIntro=false; web.playBack=false; web.playCursor=false; web.playNotes=true;  }
            if(value==='10'){ web.playIntro=false; web.playBack=false; web.playCursor=true;  web.playNotes=false; }
            web.toast($( "#actionSelect option:selected" ).text());
            web.syncAppValue();
            web.exeApp();
          });           

          $('#createBtn').on('click',function(){   
            web.resetMain();
            web.exeApp();
            web.resize();
          });
  
          $.each(app.songs,function(i,e){  
            $('#modeSelect').append('<option value="'+app.songs[i].id+'">'+app.songs[i].title+'</option>'); 
          });

          web.mode = $('#modeSelect').val();
          $('#modeSelect').on('change',function(){   
            web.mode = $('#modeSelect').val();
            if(web.mode!=='rndMode'){
              web.toast('Song: '+$( "#modeSelect option:selected" ).text());
            }else{
              web.toast($( "#modeSelect option:selected" ).text());
            } 
            web.syncAppValue(); 
            web.exeApp();
          }); 
        },
        syncAppValue: function(){ 
          app.bpm=web.bpm; 
          app.level=web.level; 
          app.playIntro=web.playIntro; 
          app.playBack=web.playBack;
          app.playCursor=web.playCursor;
          app.playNotes=web.playNotes;
          app.mode=web.mode;
        },
        exeApp: function(){
          web.syncAppValue();         
          app.init(function clickFn(noteText){ 
            web.toast(noteText);             
          });
        },
        init: function (){  
          $(window).on('resize',web.resize); 
          web.initInputElements();  
          web.resetMain(); 
          web.exeApp();
          web.resize();
          web.toast('Start App');          
          /*
          setTimeout(function(){
            //$($('button')[1]).trigger('click');
            $('#actionSelect').val('08');  
            $('#modeSelect').val('song3');  
            $('#actionSelect').trigger('change'); 
            $('#modeSelect').trigger('change');  
            setTimeout(function(){
              $('.abcjs-midi-start').trigger('click');
            },1000);
          },1000);
          */
        }        
      } 
      web.init();
    })();
    </script>
    <noscript>JAVASCRIPT NOT WORKING!</noscript>
  </body>
</html>
