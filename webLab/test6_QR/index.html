<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, minimal-ui">  
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons" > 
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.100.2/css/materialize.min.css"> 
    <title>Web Test6_QR</title>   
    <style>
      html,body{ 
        padding: 0;
        margin: 0;
        background-color: #333; 
        color: #DDD;
        -webkit-user-select: none;  
        -khtml-user-select: none;  
          -moz-user-select: none;  
            -ms-user-select: none;  
                user-select: none; 
        -webkit-tap-highlight-color: transparent; 
      } 
      #page-intro{
        padding-top: 100px; 
      } 
      #page-intro>.col{
        padding-top:    50px; 
        padding-bottom: 50px; 
      }   
      #scanQR-scanner{
        width: 100%;
      }  
      #scanQR-result{
        padding: 50px;
      }  
    </style>
  </head>
  <body>   
    <div class="fixed-action-btn" id="page-btn-back">
      <a class="btn-floating btn-large scale-transition scale-out" id="btn-back">
        <i class="large material-icons">keyboard_arrow_left</i>
      </a> 
    </div>
    <div class="container"> 
      <div class="row" id="page-intro">  
        <div class="col s12 m6 l6 center-align"><button class="btn waves-effect waves-light btn-large" type="button" value="create"><i class="material-icons left">code</i>Create QR</button></div>
        <div class="col s12 m6 l6 center-align"><button class="btn waves-effect waves-light btn-large" type="button" value="scan"  ><i class="material-icons left">photo_camera</i>Scan QR</button></div>  
      </div>
      <div class="row" id="page-createQR">  
        <div class="col s12 m12 l12 center-align"><input type="text" id="qrcode-textExe" value="Hola Mundo"></div>  
        <div class="col s12 m12 l12 center-align">
          <div class="card">
            <div class="card-content">
              <span class="card-title activator grey-text text-darken-4">Text to QR<i class="material-icons right">more_vert</i></span> 
            </div>
            <div class="card-image">
              <canvas id="qrcode"></canvas>
            </div>
            <div class="card-reveal">
              <span class="card-title grey-text text-darken-4"><i class="material-icons right">close</i></span> 
              <a id="qrcode-downloadImg" href="#" download="myQr.jpg"> Download QR</a>
            </div>
          </div>
        </div>  
      </div>  
      <div class="row" id="page-scanQR">  
        <div class="col s12 m12 l12 center-align">    
          <div class="card grey-text text-darken-4" id="scanQR-result">algo</div> 
          <video id="scanQR-scanner"></video> 
        </div> 
      </div> 
    </div> 
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>  
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.100.2/js/materialize.min.js"></script> 
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/qr-scanner/1.4.2/qr-scanner.umd.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script type="text/javascript">    
      var app = {  
        generateCodeQR: function(){   
          var dim = ($(window).innerHeight()-250>$(window).innerWidth()?$(window).innerWidth():$(window).innerHeight()-250);
          $('#qrcode').height(dim-70);
          try{
            var text = $('#qrcode-textExe').val().trim(); 
            var qrcode = new QRious({
              element: document.getElementById('qrcode'), 
              level: 'H', 
              size: dim, 
              value: text
            }); 
            $('#qrcode-downloadImg').attr('download','myQr_'+text.replaceAll(/ /ig,'_')+'.jpg'); 
            $('#qrcode-downloadImg').attr('href',document.getElementById('qrcode').toDataURL());
          }catch(e){
            console.error(e);
            $('#qrcode-container').html('<p>Error in <b>qriousjs</b>. '+e+'</p>');  
          }
        },
        qrScanner: undefined,
        scanCodeQR: function(){ 
          $('#scanQR-scanner').innerHeight($(window).innerHeight()-30); 
          $('#scanQR-result').addClass('hide');   
          app.qrScanner = new QrScanner(
            document.getElementById('scanQR-scanner'),
            function(result){
              if (!(result===null||result===undefined||result==='')){ 
                console.log('Scanned result: '+result); 
                app.qrScanner.stop(); 
                $('#scanQR-result').removeClass('hide');
                $('#scanQR-result').html('<p>'+result+'</p>');
                $('#scanQR-result').append('<a class="btn waves-effect waves-light btn-large" href="#init"> Scan QR again</a>'); 
                $('#btn-back').addClass('scale-out'); 
              }
            }
          );
          app.qrScanner.start();  
        },  
        exe: function() {
          var hash = window.location.hash; 
          if((app.qrScanner!==undefined) && (typeof app.qrScanner.stop ==="function")){
            app.qrScanner.stop();  
          }
          $('#scanQR-result').addClass('hide');
          if(hash!=='#scan-using-file'){
            $('#btn-back').addClass('scale-out');  
            $('#page-intro').removeClass('hide');  
            $('#page-createQR').addClass('hide');  
            $('#page-scanQR').addClass('hide');    
            if(hash==='#create'){
              $('#btn-back').removeClass('scale-out'); 
              $('#page-createQR').removeClass('hide');
              $('#page-intro').addClass('hide');   
              $('#page-scanQR').addClass('hide');   
              app.generateCodeQR(); 
            }
            if(hash==='#scan'){
              $('#btn-back').removeClass('scale-out'); 
              $('#page-scanQR').removeClass('hide'); 
              $('#page-intro').addClass('hide');   
              $('#page-createQR').addClass('hide');  
              app.scanCodeQR(); 
            }
          }
        },
        init: function(){
          console.log('app exe start');  
          window.location.hash=''; 
          $(window).on('hashchange',function(e){
            app.exe(); 
          });
          $('#page-intro button').on('click',function(){
            window.location.hash = $(this).val()
          });  
          $('#btn-back').on('click',function(){
            window.location.hash = 'init'
          });
          $('#qrcode-textExe').on('input',function(){
            app.generateCodeQR();
          });   
          $('#qrcode-downloadImg').on('click',function(){
            $('.card-reveal span').trigger('click');
          });
          app.exe(); 
          $(window).on('resize',app.exe);  
          console.log('app exe end');
        }     
      };  
      app.init();  
    </script> 
  </body>
</html>
