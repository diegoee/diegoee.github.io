<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, minimal-ui"> 
    <title>Web Test6_QR</title> 
    <style>   
      html,body{ 
        padding: 0;
        margin: 0;
        background-color: #333; 
        color: #DDD;
        -webkit-tap-highlight-color: transparent; 
      }  
       
      #qrcode-menu{     
        font-size: 2em;
        padding: 1em;
        text-align: center;  
        -webkit-user-select: none;  
        -khtml-user-select: none;  
          -moz-user-select: none;  
            -ms-user-select: none;  
                user-select: none; 
      }
      #qrcode-menu p{     
        padding: 0;
        margin: 0;  
      }

      #qrcode-textExe{    
        font-size: 0.75em; 
        width: 50%;
      }
      @media (max-width: 680px) {
        #qrcode-textExe{     
          width: 95%;
        }
      }

      #qrcode-downloadImg{ 
        color: #DDD;
        transition: 0.25s;
      }
      #qrcode-downloadImg:active{ 
        color: #444;
      }
      #qrcode-downloadImg:hover{ 
        text-shadow: 0 0 10px #DDD;
      } 

      #qrcode-container{  
        display: flex;
        align-items: center;
        justify-content: center; 
      }

      #menu{      
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: calc(100%- 2em); 
        text-align: center;  
        padding-top: 2em;
      }
      #menu button{    
        font-size: 2em; 
        width: 50%;
        height: 100px;
      }
      @media (max-width: 680px) {
        #menu button{     
          width: 95%;
        }
      }
      #menu div{     
        padding: 2em;
      }

      .notDisplay{
        display: none;
      } 
      
      #backBtn{     
        position: absolute;
        padding: 1em;
        margin: 1em;
        top: 0;
        right: 0;
        z-index: 10;
      }

      #video-container{  
        display: flex;
        align-items: center;
        justify-content: center; 
      }  

      #video::selection {
        background: #DDD;
        color: #333;
      }
    </style>  
  </head>
  <body>   
    <div id="body">  
      <button id="backBtn" type="button" value="back" class="notDisplay">Back</button> 
      <div id="menu" >
        <div><button type="button" value="create">Create QR</button></div> 
        <div><button type="button" value="scan"  >Scan QR</button></div> 
      </div> 
      <div id="qrcode-menu" class="notDisplay">
        <div><p>Text to QR</p></div> 
        <div><input type="text"   id="qrcode-textExe" value="Hola Mundo"></div>
        <div><a id="qrcode-downloadImg" href="#" download="myQr.jpg"> Download QR</a></div>  
      </div> 
    </div>
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>  
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/qr-scanner/1.4.2/qr-scanner.umd.min.js"></script>
    <script type="text/javascript">  
      var app = {  
        resetQR: function(){ 
          if((app.qrScanner!==undefined) && (typeof app.qrScanner.stop ==="function")){
            app.qrScanner.stop();  
          }
          $('#video-container').remove(); 
          $('#qrcode-container').remove(); 
        },
        generateCodeQR: function(){  
          $('#body').append('<div id="qrcode-container"><canvas id="qrcode"></canvas><div>'); 
          var dim = ($(window).innerHeight()-$('#qrcode-menu').innerHeight()>$(window).innerWidth()?$(window).innerWidth()-10:$(window).innerHeight()-$('#qrcode-menu').innerHeight()-10);
          try{
            var text = $('#qrcode-textExe').val().trim(); 
            var qrcode = new QRious({
              element: document.getElementById('qrcode'), 
              level: 'H', 
              size: dim, 
              value: text
            }); 
            $('#qrcode-downloadImg').attr('download','myQr_'+text.replaceAll(/ /ig,'_')+'.jpg'); 
            $('#qrcode-downloadImg').attr('href',document.getElementById('qrcode').toDataURL());
          }catch(e){
            console.error(e);
            $('#qrcode-container').html('<p>Error in <b>qriousjs</b>. '+e+'</p>');  
          }
        },
        qrScanner: undefined,
        scanCodeQR: function(){
          $('#body').append('<div id="video-container"><video id="video"></video></div>');  
          $('#video').css({
            width:  $(window).width()+'px',
            height: $(window).height()+'px'
          });   
          app.qrScanner = new QrScanner(
            document.getElementById('video'),
            function(result){
              if (!(result===null||result===undefined||result==='')){ 
                console.log('Scanned result: '+result); 
                app.qrScanner.stop();   
                $('#video-container').html('<div id="video">'+result+'</div>');   
                $('#video').css({
                  'padding': '2em',
                  'font-size': '3em'
                }); 
              }
            }
          );
          app.qrScanner.start();
        }, 
        exe: function() {
          var hash = window.location.hash;
          $('#menu').removeClass('notDisplay'); 
          $('#qrcode-menu').addClass('notDisplay'); 
          $('#backBtn').addClass('notDisplay'); 
          app.resetQR();
          if(hash==='#create'){
            $('#menu').addClass('notDisplay');
            $('#qrcode-menu').removeClass('notDisplay'); 
            $('#backBtn').removeClass('notDisplay'); 
            app.generateCodeQR(); 
          }
          if(hash==='#scan'){
            $('#menu').addClass('notDisplay');
            $('#backBtn').removeClass('notDisplay'); 
            app.scanCodeQR(); 
          }
        },
        init: function(){
          console.log('app exe start');   
          $(window).on('hashchange',function(e){
            app.exe(); 
          });
          $('#menu button').on('click',function(){
            window.location.hash = $(this).val()
          });  
          $('#backBtn').on('click',function(){
            window.location.hash = 'init'
          });
          $('#qrcode-textExe').on('input',function(){
            app.generateCodeQR();
          }); 
          app.exe(); 
          $(window).on('resize',app.exe);           
          console.log('app exe end');
        }     
      };  
      app.init();   
    </script> 
  </body>
</html>
