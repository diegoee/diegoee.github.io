<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Web test">  
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, minimal-ui"> 
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/uikit@3.9.2/dist/css/uikit.min.css" /> 
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/abcjs@6.0.0-beta.35/abcjs-audio.css" />
    <title>Web Test4_musicTheory</title>
    <style>  
      #version{
        position: absolute;
        margin: 0;
        padding: 0;
        top: 0;
        right: 5px;
        font-size: 0.75em;
      } 
      #header{
        background-color: #EEE;
      }
      .currentNote{
        color: #2196F3;
      }
      .colorPlay,.colorPlay:active,.colorPlay:hover{
        background-color: green;
      }
      .colorStop,.colorStop:active,.colorStop:hover{
        background-color: red;
      }   
      #loopBtn{
        position: fixed; 
        bottom: 0;
        left: 5px;
        z-index: 1; 
        border-radius: 5px;
      } 
      #playBtn{
        position: fixed; 
        bottom: 0;
        right: 5px;
        z-index: 1; 
        border-radius: 5px;
        color: #fff;
      }  
      #loopBtn.play,#playBtn.play{
        background-color: green;
      }       
      #loopBtn.stop,#playBtn.stop{
        background-color: #f0506e; 
      } 
      #main{
        color: #333;      
      }      
      #loader{
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 1;    
        background-color: rgba(255, 255, 255, 0.7); 
      }
      .uk-notification-close {
        display: block;
      }
      .center{
        display: flex;
        align-items: center;
        justify-content: center;
      } 
      #visual{
        position: relative;
        background-color: #EEE;
      }
    </style>
  </head>
  <body>
    <div id="version"></div>  
    <button id="loopBtn" class="uk-button uk-button-primary uk-margin stop" disabled><span uk-icon="refresh"></span>Off</button> 
    <button id="playBtn" class="uk-button uk-button-primary uk-margin play" disabled><span uk-icon="play-circle"></span></button>    
    <div id="header" class=""> 
      <button class="uk-button uk-button-default uk-button" uk-toggle="target: #modalMenu" disabled><span uk-icon="menu"></span></button>
      <div class="uk-padding-small uk-padding-remove-bottom"><div id="control" class=></div></div>   
    </div>
    <div id="main" class="center">  </div>
    <div id="visual">  </div>   
    <div id="modalMenu" uk-modal>
      <div class="uk-modal-dialog">
          <button class="uk-modal-close-default" type="button" uk-close></button>
          <div class="uk-modal-header"> 
              <h2 class="uk-modal-title">Menú</h2>
          </div>
          <div class="uk-modal-body" uk-overflow-auto>  
            <div class="uk-margin">
              <label>Rhythm</label>
              <select id="rhythmSelect" class="uk-select">  
              </select>
            </div>  
            <div class="uk-margin">  
              <p>Tempo (beats): (<span id="tempoBarValue"></span> bpm)</p>
              <div class="uk-margin">
                <input class="uk-range" type="range" value="60" id="tempoBar" min="40" max="150" step="1">
              </div>  
            </div>  
          </div> 
          <div class="uk-modal-footer uk-text-right"> 
          </div>
      </div>
    </div>
    <script type="text/javascript" src="https://code.jquery.com/jquery-3.2.1.min.js"></script> 
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/uikit@3.9.2/dist/js/uikit.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/uikit@3.9.2/dist/js/uikit-icons.min.js"></script>   
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/abcjs@6.0.0-beta.35/dist/abcjs-basic-min.js"></script>   
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/tone/13.0.1/Tone.min.js"></script> 
    <script type="text/javascript" src="https://mrdoob.github.io/stats.js/build/stats.min.js"></script>  
    <script type="text/javascript" src="https://threejs.org/build/three.js"></script>              
    <script type="text/javascript">
    /*global $, UIkit, window, setTimeout, clearTimeout, Promise, Tone, ABCJS*/ 
    (function exe(){
      var abcjs=window.ABCJS; 

       

      //versión
      $('#version').html('v2.0.0');
      //visual App
      var visual = {
        getRndN: function (nstart,nEnd){
          return Math.round(Math.random()*nEnd)+nstart;
        }, 
        stats: undefined,
        initStats: function(){
          this.stats = new Stats();
          this.stats.showPanel(0); // 0: fps, 1: ms, 2: mb, 3+: custom
          this.stats.domElement.style.position = 'absolute';
          this.stats.domElement.style.left = ''; 
          this.stats.domElement.style.right = '0px';
          $('#visual').append(this.stats.domElement); 
        },
        reset: function(){
          $('#visual').html(' ');
        },
        init: function(){
          var self = this; 
          console.log('visual exe ini');
          self.reset(); 
          self.initStats();  

          var w = $('#visual').innerWidth();
          var h = $('#visual').innerHeight();
  
          var scene = new THREE.Scene();
          scene.background = new THREE.Color( 0xEEEEEE );
          var camera = new THREE.PerspectiveCamera( 100, w/h, 1, 1000 );  
          var frustumSize = 100;
          var aspect = w / h;
          //var camera = new THREE.OrthographicCamera( frustumSize * aspect / - 2, frustumSize * aspect / 2, frustumSize / 2, frustumSize / - 2, 1, 1000 ); 
          camera.position.z = 20;
          camera.aspect=aspect;
          camera.updateProjectionMatrix();
           
          var s = 10;  
          var renderer = new THREE.WebGLRenderer();
          renderer.setSize( w, h);
          $('#visual').append( renderer.domElement );  
          
         
          //cube
          var group = new THREE.Group();
          var geometry = new THREE.BoxGeometry( s, s, s);
          var material = new THREE.MeshBasicMaterial( { color: 0xFFFFFF} ); 
          var mesh = new THREE.Mesh( geometry, material );  
          group.add( mesh ); 

          //line black
          material = new THREE.LineBasicMaterial( { color: 0x000000 } );
          var points = [];         
          //1 side
          points.push( new THREE.Vector3(  -0.51*s,  -0.51*s,  0)); //x, y, z
          points.push( new THREE.Vector3(  -0.51*s,   0.51*s,  0)); 
          points.push( new THREE.Vector3(   0.51*s,   0.51*s,  0)); 
          points.push( new THREE.Vector3(   0.51*s,  -0.51*s,  0));
          points.push( new THREE.Vector3(  -0.51*s,  -0.51*s,  0));
          geometry = new THREE.BufferGeometry().setFromPoints( points );
          mesh = new THREE.Line( geometry, material );   
          group.add( mesh );

          //2 side  
          mesh = new THREE.Line( geometry, material );  
          mesh.rotation.x=Math.PI/2; 
          group.add( mesh );

          scene.add( group );  
          
          //var pointer = new THREE.Vector2();
          //var raycaster = new THREE.Raycaster();  
          $('#visual').on('click',function(event){  
            //pointer.x =   ( event.clientX / w ) * 2 - 1;
            //pointer.y = - ( event.clientY / h ) * 2 + 1;
            //raycaster.setFromCamera( pointer, camera ); 
            //var intersects = raycaster.intersectObjects(scene.children);   
            //if(intersects.length>0){ 
              console.log('clicked'); 
            //} 
          }); 
          
          function render() {  
            group.rotation.x+=0.01; 
            group.rotation.y+=0.01; 
            renderer.render( scene, camera );   
          }; 
    
          function animate() {
            requestAnimationFrame( animate ); 
            render(); 
            self.stats.update();
          }; 
 
          render();
          animate();  
          console.log('visual exe end'); 
        } 
      }
      //app
      var app = {  
        timeSigSel: undefined, 
        bpm: 40,
        musicSheet: undefined,
        playMusicSheet: [undefined,undefined],
        synth: undefined,  
        rhythm: 'r01',
        rhythms:[ 
          {id: 'r01', title:'4/4 - 1', abc1:'\nM:4/4\nQ:', abc2:'\nK:C\nA4|A4|A4|A4||'},
          {id: 'r02', title:'4/4 - 2', abc1:'\nM:4/4\nQ:', abc2:'\nK:C\nA2A2|A2A2|A2A2|A2A2||'},  
          {id: 'r03', title:'4/4 - 4', abc1:'\nM:4/4\nQ:', abc2:'\nK:C\nAA AA|AA AA|AA AA|AA AA||'}, 
          {id: 'r04', title:'6/8 - 1', abc1:'\nM:6/8\nQ:', abc2:'\nK:C\nAAA AAA|AAA AAA|AAA AAA|AAA AAA||'}, 
          {id: 'r05', title:'6/8 - 2', abc1:'\nM:6/8\nQ:', abc2:'\nK:C\nA3 A3|A3 A3|A3 A3|A3 A3||'},        
        ], 
        translateNote: function(noteName,pitch,type){ 
          var notesPitchTranslator = [ 
            [ 48,    49,  50,   51,  52,  53,  54,     55,    56, 57,    58, 59 ],  
            [  3,     3,   3,    3,   3,   3,    3,     3,     3,   3,    3,  3 ],
            ['C',  'C#', 'D', 'D#', 'E', 'F',  'F#',  'G',  'G#', 'A', 'A#', 'B'],
            ['Do','Do#','Re','Re#','Mi','Fa', 'Fa#','Sol','sol#','La','La#','Si'],
            ['C',  'Db', 'D', 'Eb', 'E', 'F',  'Gb',  'G',  'Ab', 'A', 'Bb', 'B'],
            ['Do','Reb','Re','Mib','Mi','Fa','Solb','Sol', 'Lab','La','Sib','Si'],
          ]; 
          var l = notesPitchTranslator[0].length;
          for (var i=0;i<4;i++){
            for (var ii=0;ii<l;ii++){
              notesPitchTranslator[0].push(notesPitchTranslator[0][notesPitchTranslator[0].length-1]+1);
              notesPitchTranslator[1].push(4+i);
              notesPitchTranslator[2].push(notesPitchTranslator[2][ii]);
              notesPitchTranslator[3].push(notesPitchTranslator[3][ii]);
              notesPitchTranslator[4].push(notesPitchTranslator[4][ii]);
              notesPitchTranslator[5].push(notesPitchTranslator[5][ii]);
            }
          }  
          var res = notesPitchTranslator[0].findIndex(function(e){
            return e===pitch;
          });   
          res = notesPitchTranslator[2][res]+notesPitchTranslator[1][res]; 
 
          if(type===1){ //type=1 mode text  
            res = notesPitchTranslator[0].findIndex(function(e){
              return e===pitch;
            });       
            if(noteName.indexOf('_')!==-1) { //bemol 
              res = notesPitchTranslator[4][res]+' - '+notesPitchTranslator[5][res]; 
            }else if(noteName.indexOf('^')!==-1) { //sostenido 
              res = notesPitchTranslator[2][res]+' - '+notesPitchTranslator[3][res];
            }else{ 
              res = notesPitchTranslator[2][res]+' - '+notesPitchTranslator[3][res];
            }             
          }          
          return res;
        },  
        createMusicSheet: function(clickFn){ 
          var i=0;
          i = app.rhythms.findIndex(function(e){
            return e.id==app.rhythm;
          });   
          var abc =''  
          app.timeSigSel='';
          app.timeSigSel=app.timeSigSel+(app.rhythms[i].abc1.indexOf('M:2/4')!==-1?'2/4':'');
          app.timeSigSel=app.timeSigSel+(app.rhythms[i].abc1.indexOf('M:3/4')!==-1?'3/4':'');
          app.timeSigSel=app.timeSigSel+(app.rhythms[i].abc1.indexOf('M:4/4')!==-1?'4/4':'');
          app.timeSigSel=app.timeSigSel+(app.rhythms[i].abc1.indexOf('M:6/8')!==-1?'6/8':'');  
          abc = 'X:1\nT:'+app.rhythms[i].title+app.rhythms[i].abc1 +app.bpm+app.rhythms[i].abc2;  
        
          app.musicSheet = abcjs.renderAbc("main",abc,{ 
            add_classes: true,
            //responsive: "resize",
            clickListener: function(e){
              var noteText = app.translateNote(e.pitches[0].name,e.midiPitches[0].pitch,1);  
              var note = app.translateNote(e.pitches[0].name,e.midiPitches[0].pitch,0);
              app.synth.triggerAttackRelease(note,'8n'); 
              if(typeof clickFn==='function'){
                clickFn(noteText);
              }
            } 
          });  
        },       
        stop: function(){ 
          $('.abcjs-note').removeClass('currentNote');
          $('.abcjs-time-signature').removeClass('currentNote'); 
          app.isPlaying=false;
          try{
            app.playMusicSheet[0].pause();
            app.playMusicSheet[0].restart();
            app.playMusicSheet[1].stop();
          }catch(e){ 
            console.log(e.message);
          }
        }, 
        init: function (clickFn,endFn,finishPlayFn){  
          this.synth = new Tone.Synth().toMaster();  
          console.log('Bpm: '+this.bpm+', Rhythm: '+this.rhythm);
          app.stop(); 
          this.createMusicSheet(clickFn); 

          var subBeat=1;
          var beat=1;
          if(app.timeSigSel==='2/4'){  
            beat=2;
          }else if(app.timeSigSel==='3/4'){ 
            beat=3;
          }else if(app.timeSigSel==='4/4'){ 
            beat=4;
          }else 
          if(app.timeSigSel==='6/8'){ 
            subBeat=3;
            beat=2;
          } 

          app.playMusicSheet[0] = new ABCJS.synth.SynthController();
          app.playMusicSheet[0].load("#control", {
            beatSubdivisions: subBeat,
            extraMeasuresAtBeginning: 0,
            onStart: function() {    
              $('.abcjs-note').removeClass('currentNote');
              $('.abcjs-rest').removeClass('currentNote'); 
              $('.abcjs-time-signature').removeClass('currentNote');
              $('.abcjs-time-signature').addClass('currentNote');
            },
            onFinished: function() {    
              $('.abcjs-time-signature').removeClass('currentNote');
              $('.abcjs-note').removeClass('currentNote'); 
              if(typeof finishPlayFn==='function'){
                finishPlayFn();
              }
            },
            onBeat: function(beatNumber) { 
              if(beatNumber%beat===0){ 
                //app.synth.triggerAttackRelease('A4','16n');
              }else{ 
                //app.synth.triggerAttackRelease('A4','16n');
              }           
            },
            onEvent: function(event) {  
              $('.abcjs-time-signature').removeClass('currentNote'); 
              $('.abcjs-note').removeClass('currentNote');
              $('.abcjs-rest').removeClass('currentNote');
              try{
                $(event.elements[0][0]).addClass('currentNote');
              }catch(e){
                console.error(e);
              } 
            }
          },{
            displayRestart: true, 
            displayLoop: true,
            displayPlay: true, 
            displayProgress: true 
          });
 
          app.playMusicSheet[1] = new ABCJS.synth.CreateSynth(); 
          app.playMusicSheet[1].init({  
            visualObj: app.musicSheet[0]
          }).then(function (results){
            app.playMusicSheet[0].setTune( app.musicSheet[0],false,{ 
              soundFontVolumeMultiplier: '2' //'0' sound off
            }).then(function (response) {
              console.log("Audio successfully loaded.");
              if(typeof endFn==='function'){
                endFn();
              }
            }).catch(function (error) {
              console.warn("Audio problem:", error);
            });
          }).catch(function (reason) {
            console.log(reason);
          }); 
        }
      }; 
      //actionWeb  
      var web = {  
        currentToast: undefined,
        bpm: 120,
        rhythm: 'r01',
        toast: function (data){
          if(this.currentToast!==undefined){
            this.currentToast.close(true);
          }
          this.currentToast = UIkit.notification({
              message: data,
              status: 'primary',
              pos: 'top-right',
              timeout: 4000
          }); 
        }, 
        resize: function(){  
          $('#main').innerHeight($(window).innerHeight()/4-$('#header').innerHeight()-20);
          $('#visual').innerHeight($(window).innerHeight()-$('#main').innerHeight()-$('#header').innerHeight());
          visual.init(); 
        },
        loaderE: '<div id="loader" class="center"> <div uk-spinner="ratio: 6"></div></div>',
        loaderOn: function(){
          $('body').append(this.loaderE);
        },
        loaderOff: function(){
          $('#loader').remove();
        },
        resetMain: function(){
          $('#main').html(' ');
          web.resetPlayBtn();
          $('button').attr('disabled',false);
        },
        initInputElements:function(){    
          $('#tempoBar').val(web.bpm);
          $('#tempoBarValue').html($('#tempoBar').val()); 
          $('#tempoBar').on('change',function(){ 
            $('#tempoBarValue').html($('#tempoBar').val()); 
            web.bpm=parseInt($('#tempoBar').val()); 
            web.exeApp();  
          });
          $('#tempoBar').trigger('change');
 
          
          web.resetPlayBtn();
          $('#playBtn').on('click',function(){
            $('.abcjs-midi-start').trigger('click');
          });

          web.resetLoopBtn();
          $('#loopBtn').on('click',function(){
            $('.abcjs-midi-loop').trigger('click'); 
          }); 
  
          $.each(app.rhythms,function(i,e){  
            $('#rhythmSelect').append('<option value="'+app.rhythms[i].id+'">'+app.rhythms[i].title+'</option>'); 
          });

          $('#rhythmSelect').val(web.rhythm);
          $('#rhythmSelect').on('change',function(){   
            web.rhythm=$('#rhythmSelect').val();
            web.toast('Rhythm: '+$( "#rhythmSelect option:selected" ).text()); 
            web.exeApp();  
          }); 
          $('#rhythmSelect').trigger('change');  
        },
        resetPlayBtn: function(){ 
          var $e = $('#playBtn');
          $e.removeClass('stop');
          $e.addClass('play');
          $e.html('<span uk-icon="play-circle"></span>'); 
        },
        resetLoopBtn: function(){ 
          var $e = $('#loopBtn');
          $e.removeClass('play');
          $e.addClass('stop');
          $e.html('<span uk-icon="refresh"></span>Off'); 
        },
        endLoadSongFn: function(){
          $('.abcjs-midi-start').on('click',function(){  
            var $e = $('#playBtn');
            if($e.hasClass('play')){
              $e.removeClass('play');
              $e.addClass('stop');
              $e.html('<span uk-icon="ban"></span>'); 
            }else{ 
              $e.removeClass('stop');
              $e.addClass('play');
              $e.html('<span uk-icon="play-circle"></span>'); 
            };        
          }); 
          $('.abcjs-midi-loop').on('click',function(){
            var $e = $('#loopBtn');
            if($e.hasClass('play')){
              $e.removeClass('play');
              $e.addClass('stop');
              $e.html('<span uk-icon="refresh"></span>Off'); 
            }else{ 
              $e.removeClass('stop');
              $e.addClass('play');
              $e.html('<span uk-icon="refresh"></span>On'); 
            };  
          });   
        }, 
        syncAppValue: function(){ 
          app.bpm=web.bpm;  
          app.rhythm=web.rhythm;
        },
        exeApp: function(){
          web.syncAppValue();   
          web.resetPlayBtn();  
          web.resetLoopBtn();      
          app.init(function clickFn(noteText){ 
            web.toast(noteText);             
          },function endFn(){ 
            web.endLoadSongFn();             
          },function finishPlayFn(){ 
            web.resetPlayBtn();             
          }); 
        },
        init: function (){  
          this.loaderOn();
          this.initInputElements();  
          this.resetMain(); 
          this.resize(); 
          $(window).on('resize',this.resize); 
          this.exeApp(); 
          this.toast('Start App');  
          this.loaderOff(); 
        }        
      } 
      web.init();
    })();
    </script>
    <noscript>JAVASCRIPT NOT WORKING!</noscript>
  </body>
</html>
