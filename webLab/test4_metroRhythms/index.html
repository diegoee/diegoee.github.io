<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Web test">  
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, minimal-ui"> 
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/uikit@3.9.2/dist/css/uikit.min.css" /> 
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/abcjs@6.0.0-beta.35/abcjs-audio.css" />
    <title>Web Test4_musicTheory</title>
    <style>  
      html,body{  
        -webkit-user-select: none;  
        -khtml-user-select: none;  
          -moz-user-select: none;  
            -ms-user-select: none;  
                user-select: none; 
        -webkit-tap-highlight-color: transparent; 
        overflow-y: hidden;  
        overflow-x: hidden; 
      }
      #version{
        position: absolute;
        margin: 0;
        padding: 0;
        top: 0;
        right: 5px;
        font-size: 0.75em;
      } 
      #header{
        background-color: #EEE;
      }
      .currentNote{
        color: #2196F3;
      }
      .colorPlay,.colorPlay:active,.colorPlay:hover{
        background-color: green;
      }
      .colorStop,.colorStop:active,.colorStop:hover{
        background-color: red;
      }   
      #loopBtn{
        position: fixed; 
        bottom: 0;
        left: 5px;
        z-index: 1; 
        border-radius: 5px;
      } 
      #playBtn{
        position: fixed; 
        bottom: 0;
        right: 5px;
        z-index: 1; 
        border-radius: 5px;
        color: #fff;
      }  
      #loopBtn.play,#playBtn.play{
        background-color: green;
      }       
      #loopBtn.stop,#playBtn.stop{
        background-color: #f0506e; 
      } 
      #main{
        color: #333;      
      }      
      #loader{
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 1;    
        background-color: rgba(255, 255, 255, 0.7); 
      }
      .uk-notification-close {
        display: block;
      }
      .center{
        display: flex;
        align-items: center;
        justify-content: center;
      } 
      #visual{
        position: relative;
        background-color: #EEE;
      }
    </style>
  </head>
  <body>
    <div id="version"></div>  
    <button id="loopBtn" class="uk-button uk-button-primary uk-margin stop" disabled><span uk-icon="refresh"></span>Off</button> 
    <button id="playBtn" class="uk-button uk-button-primary uk-margin play" disabled><span uk-icon="play-circle"></span></button>    
    <div id="header" class=""> 
      <button class="uk-button uk-button-default uk-button" uk-toggle="target: #modalMenu" disabled><span uk-icon="menu"></span></button>
      <div class="uk-padding-small uk-padding-remove-bottom"><div id="control" class=></div></div>   
    </div>
    <div id="visual">  </div>   
    <div id="main" class="center">  </div>
    <div id="modalMenu" uk-modal>
      <div class="uk-modal-dialog">
          <button class="uk-modal-close-default" type="button" uk-close></button>
          <div class="uk-modal-header"> 
              <h2 class="uk-modal-title">Menú</h2>
          </div>
          <div class="uk-modal-body" uk-overflow-auto>  
            <div class="uk-margin">
              <label>Rhythm</label>
              <select id="rhythmSelect" class="uk-select">  
              </select>
            </div>  
            <div class="uk-margin">  
              <p>Tempo (beats): (<span id="tempoBarValue"></span> bpm)</p>
              <div class="uk-margin">
                <input class="uk-range" type="range" value="60" id="tempoBar" min="40" max="150" step="1">
              </div>  
            </div>  
          </div> 
          <div class="uk-modal-footer uk-text-right"> 
          </div>
      </div>
    </div>
    <script type="text/javascript" src="https://code.jquery.com/jquery-3.2.1.min.js"></script> 
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/uikit@3.9.2/dist/js/uikit.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/uikit@3.9.2/dist/js/uikit-icons.min.js"></script>   
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/abcjs@6.0.0-beta.35/dist/abcjs-basic-min.js"></script>   
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/tone/13.0.1/Tone.min.js"></script>
    <script type="text/javascript" src="https://threejs.org/build/three.js"></script>              
    <script type="text/javascript">
    /*global $, UIkit, window, setTimeout, clearTimeout, Promise, Tone, ABCJS*/ 
    (function exe(){
      var abcjs=window.ABCJS; 
      //versión
      $('#version').html('v2.0.0');
      $('#control').css({ display: 'none' });
      //visual App
      var visual = {
        inter: undefined,
        play: false,
        getRndN: function (nstart,nEnd){
          return Math.round(Math.random()*nEnd)+nstart;
        }, 
        getMaxArry: function (a){
          var l = a.length;
          var max = a[0];
          for(var i=1; i<l; i++){
            max=Math.max(max,a[i]);
          }
          return max;
        },
        reset: function(){
          $('#visual').html(' ');
        },
        init: function(data){
          var self = this; 
          //console.log('visual exe ini');
          self.reset();   

          console.log(data);
          var w = $('#visual').innerWidth();
          var h = $('#visual').innerHeight();
  
          var scene = new THREE.Scene();
          scene.background = new THREE.Color( 0xEEEEEE );
          var frustumSize = 100;
          var aspect = w / h;
          //var camera = new THREE.PerspectiveCamera( 100, w/h, 1, 1000 );   
          var camera = new THREE.OrthographicCamera( frustumSize * aspect / - 2, frustumSize * aspect / 2, frustumSize / 2, frustumSize / - 2, 1, 1000 ); 
          camera.position.z = 45;
          camera.aspect=aspect;
          camera.updateProjectionMatrix();
           
          var s = (2/3)*camera.position.z; 
          var zRef = 1; 
          var renderer = new THREE.WebGLRenderer();
          renderer.setSize( w, h);
          $('#visual').append( renderer.domElement );           
          
          var group1 = new THREE.Group();
          var group2 = new THREE.Group(); 
          var geometry, material, mesh;
          var points = []; 
 
          material = new THREE.LineBasicMaterial( { color: 0x333333 } ); 
          points = []; 
          points.push( new THREE.Vector3(  0,  +(1+(+01/20))*s,  zRef));
          points.push( new THREE.Vector3(  0,  -(1+(-15/20))*s,  zRef));
          geometry = new THREE.BufferGeometry().setFromPoints( points );                    
          mesh = new THREE.Line( geometry, material );  
          group1.add( mesh ); 
    
          geometry = new THREE.CylinderGeometry( (1/20)*s, (1/20)*s, zRef, 120); 
          mesh = new THREE.Mesh( geometry, material ); 
          mesh.rotation.x=Math.PI/2;  
          mesh.position.z=zRef;    
          mesh.position.x=0; 
          mesh.position.y=s;  
          group1.add( mesh );

          geometry = new THREE.CylinderGeometry( (1/20)*s, (1/20)*s, zRef, 120); 
          mesh = new THREE.Mesh( geometry, material ); 
          mesh.rotation.x=Math.PI/2;  
          mesh.position.z=zRef;    
          mesh.position.x=0; 
          mesh.position.y=0;  
          group1.add( mesh );

           
          material = new THREE.MeshBasicMaterial( { color: 0xFFFFFF} );   
          geometry = new THREE.CylinderGeometry( 0.99*s, 0.99*s, zRef, 120); 
          mesh = new THREE.Mesh( geometry, material ); 
          mesh.position.z=-zRef/2;    
          mesh.rotation.x=Math.PI/2;  
          group1.add( mesh );

          var l = data.beats.length;
          var max = self.getMaxArry(data.beats);
          for(var i=0; i<l; i++){
            var h = 0.75*data.beats[i]*s/max;
            var rot = i*2*Math.PI/l;
            if(h!==0){
              var group = new THREE.Group();
              material = new THREE.LineBasicMaterial( { color: 0x000000 } ); 
              points = []; 
              points.push( new THREE.Vector3(  0,  0,  zRef));
              points.push( new THREE.Vector3(  0,  0.95*s,  zRef));
              geometry = new THREE.BufferGeometry().setFromPoints( points );                    
              mesh = new THREE.Line( geometry, material );  
              group.add( mesh ); 
              material = new THREE.LineBasicMaterial( { color: 0x000000 } ); 
              geometry = new THREE.CylinderGeometry( (1/20)*s, (1/20)*s, zRef, 120); 
              mesh = new THREE.Mesh( geometry, material ); 
              mesh.rotation.x=Math.PI/2;  
              mesh.position.z=zRef;    
              mesh.position.x=0; 
              mesh.position.y=h;  
              group.add( mesh ); 
              group.rotation.z=rot;
              group2.add( group );
            }
          }

          scene.add( group1 );
          scene.add( group2 );  
          
          //var pointer = new THREE.Vector2();
          //var raycaster = new THREE.Raycaster(); 
          self.play = false; 
          $('#visual').off('click');
          $('#visual').on('click',function(event){  
            //self.play=!self.play;
          }); 
          
          var clock = new THREE.Clock();
          var d = data.div*data.bpm/60; 
          var p = data.beatPulses;
          
          function render(){  
            requestAnimationFrame(render); 
            var delta = clock.getDelta();
            if(self.play){  
              group2.rotation.z-= (1/p)*d*delta*2*Math.PI;   
            }else{  
              group1.rotation.z = 0; 
              group1.rotation.y = 0; 
              group1.rotation.x = 0; 
              group2.rotation.z = 0; 
              group2.rotation.y = 0; 
              group2.rotation.x = 0;  
            }
            renderer.render(scene,camera);   
          };     
          render();  
          //console.log('visual exe end'); 
        } 
      }
      //devOps
      /*
      setTimeout(function(){
        console.log('change1');
        $('#tempoBar').val('60');
        $('#tempoBar').trigger('change');
        setTimeout(function(){ 
        console.log('change2');
          $('#rhythmSelect').val('r24_2');
          $('#rhythmSelect').trigger('change'); 
          setTimeout(function(){  
            console.log('click'); 
            //$('#loopBtn').trigger('click'); 
            $('#playBtn').trigger('click');
            setTimeout(function(){
              //location.reload();
            },10000);
          },1000);
        },1000);
      },1000); 
      */  

      //app
      var app = {  
        timeSigSel: undefined, 
        bpm: 40,
        musicSheet: undefined,
        playMusicSheet: [undefined,undefined],
        synth: undefined,  
        rhythm: 'r01',
        rhythms:[ 
          {id: 'r24_1', title:'2/4 - 1', abc1:'\nM:2/4\nQ:', abc2:'\nK:C\nc4A4|c4A4|c4A4|c4A4||', visual:{beatPulses:2,div:1,beats:[2,1]}},
          {id: 'r24_2', title:'2/4 - 2', abc1:'\nM:2/4\nQ:', abc2:'\nK:C\nz4A4|z4A4|z4A4|z4A4||', visual:{beatPulses:2,div:1,beats:[0,1]}},
          {id: 'r24_3', title:'2/4 - 3', abc1:'\nM:2/4\nQ:', abc2:'\nK:C\nc4z2A2|nc4z2A2|nc4z2A2|nc4z2A2||', visual:{beatPulses:2,div:1,beats:[2,0,0,1]}},
          {id: 'r24_4', title:'2/4 - 4', abc1:'\nM:2/4\nQ:', abc2:'\nK:C\nc4z2AA|nc4z2AA|nc4z2AA|nc4z2AA||', visual:{beatPulses:2,div:1,beats:[2,0,0,0,0,0,1,1]}},
          {id: 'r34_1', title:'3/4 - 1', abc1:'\nM:3/4\nQ:', abc2:'\nK:C\nc2A2A2|c2A2A2|c2A2A2|c2A2A2||', visual:{beatPulses:3,div:1,beats:[2,1,1]}},  
          {id: 'r44_1', title:'4/4 - 1', abc1:'\nM:4/4\nQ:', abc2:'\nK:C\nc2A2A2A2|c2A2A2A2|c2A2A2A2|c2A2A2A2||', visual:{beatPulses:4,div:1,beats:[2,1,1,1]}},  
          {id: 'r68_1', title:'6/8 - 1', abc1:'\nM:6/8\nQ:', abc2:'\nK:C\ncAA AAA|cAA AAA|cAA AAA|cAA AAA||', visual:{beatPulses:6,div:2,beats:[2,1,1,1,1,1]}},  
          {id: 'r54_1', title:'5/4 - 1', abc1:'\nM:5/4\nQ:', abc2:'\nK:C\nc2A2A2A2A2|c2A2A2A2A2|c2A2A2A2A2|c2A2A2A2A2||', visual:{beatPulses:5,div:1,beats:[2,1,1,1,1]}},      
        ], 
        translateNote: function(noteName,pitch,type){ 
          var notesPitchTranslator = [ 
            [ 48,    49,  50,   51,  52,  53,  54,     55,    56, 57,    58, 59 ],  
            [  3,     3,   3,    3,   3,   3,    3,     3,     3,   3,    3,  3 ],
            ['C',  'C#', 'D', 'D#', 'E', 'F',  'F#',  'G',  'G#', 'A', 'A#', 'B'],
            ['Do','Do#','Re','Re#','Mi','Fa', 'Fa#','Sol','sol#','La','La#','Si'],
            ['C',  'Db', 'D', 'Eb', 'E', 'F',  'Gb',  'G',  'Ab', 'A', 'Bb', 'B'],
            ['Do','Reb','Re','Mib','Mi','Fa','Solb','Sol', 'Lab','La','Sib','Si'],
          ]; 
          var l = notesPitchTranslator[0].length;
          for (var i=0;i<4;i++){
            for (var ii=0;ii<l;ii++){
              notesPitchTranslator[0].push(notesPitchTranslator[0][notesPitchTranslator[0].length-1]+1);
              notesPitchTranslator[1].push(4+i);
              notesPitchTranslator[2].push(notesPitchTranslator[2][ii]);
              notesPitchTranslator[3].push(notesPitchTranslator[3][ii]);
              notesPitchTranslator[4].push(notesPitchTranslator[4][ii]);
              notesPitchTranslator[5].push(notesPitchTranslator[5][ii]);
            }
          }  
          var res = notesPitchTranslator[0].findIndex(function(e){
            return e===pitch;
          });   
          res = notesPitchTranslator[2][res]+notesPitchTranslator[1][res]; 
 
          if(type===1){ //type=1 mode text  
            res = notesPitchTranslator[0].findIndex(function(e){
              return e===pitch;
            });       
            if(noteName.indexOf('_')!==-1) { //bemol 
              res = notesPitchTranslator[4][res]+' - '+notesPitchTranslator[5][res]; 
            }else if(noteName.indexOf('^')!==-1) { //sostenido 
              res = notesPitchTranslator[2][res]+' - '+notesPitchTranslator[3][res];
            }else{ 
              res = notesPitchTranslator[2][res]+' - '+notesPitchTranslator[3][res];
            }             
          }          
          return res;
        },  
        createMusicSheet: function(clickFn){ 
          var i=0;
          i = app.rhythms.findIndex(function(e){
            return e.id==app.rhythm;
          });   
          var abc =''  
          app.timeSigSel='';
          app.timeSigSel=app.timeSigSel+(app.rhythms[i].abc1.indexOf('M:2/4')!==-1?'2/4':'');
          app.timeSigSel=app.timeSigSel+(app.rhythms[i].abc1.indexOf('M:3/4')!==-1?'3/4':'');
          app.timeSigSel=app.timeSigSel+(app.rhythms[i].abc1.indexOf('M:4/4')!==-1?'4/4':'');
          app.timeSigSel=app.timeSigSel+(app.rhythms[i].abc1.indexOf('M:6/8')!==-1?'6/8':'');  
          abc = 'X:1\nT:'+app.rhythms[i].title+app.rhythms[i].abc1 +app.bpm+app.rhythms[i].abc2; 
          if(app.timeSigSel==='6/8'){  
            abc = 'X:1\nT:'+app.rhythms[i].title+app.rhythms[i].abc1 +(2*app.bpm)+app.rhythms[i].abc2;
          }  
        
          //console.log(abc);
          app.musicSheet = abcjs.renderAbc("main",abc,{ 
            add_classes: true,
            responsive: "resize",
            clickListener: function(e){
              var noteText = app.translateNote(e.pitches[0].name,e.midiPitches[0].pitch,1);  
              var note = app.translateNote(e.pitches[0].name,e.midiPitches[0].pitch,0);
              app.synth.triggerAttackRelease(note,'8n'); 
              if(typeof clickFn==='function'){
                clickFn(noteText);
              }
            } 
          });  
        },       
        stop: function(){ 
          $('.abcjs-note').removeClass('currentNote');
          $('.abcjs-time-signature').removeClass('currentNote'); 
          app.isPlaying=false;
          try{
            app.playMusicSheet[0].pause();
            app.playMusicSheet[0].restart();
            app.playMusicSheet[1].stop();
          }catch(e){ 
            console.log(e.message);
          }
        }, 
        init: function (clickFn,endFn,finishPlayFn){   
          //console.log('app exe ini -> Bpm: '+this.bpm+', Rhythm: '+this.rhythm);
          this.synth = new Tone.Synth().toMaster();   
          app.stop(); 
          this.createMusicSheet(clickFn); 

          var subBeat=1;
          var beat=1;
          if(app.timeSigSel==='2/4'){  
            beat=2;
          }else if(app.timeSigSel==='3/4'){ 
            beat=3;
          }else if(app.timeSigSel==='4/4'){ 
            beat=4;
          }else 
          if(app.timeSigSel==='6/8'){ 
            subBeat=3;
            beat=2;
          } 

          app.playMusicSheet[0] = new ABCJS.synth.SynthController();
          app.playMusicSheet[0].load("#control", {
            beatSubdivisions: subBeat,
            extraMeasuresAtBeginning: 0,
            onStart: function() {    
              $('.abcjs-note').removeClass('currentNote');
              $('.abcjs-rest').removeClass('currentNote'); 
              $('.abcjs-time-signature').removeClass('currentNote');
              $('.abcjs-time-signature').addClass('currentNote');
            },
            onFinished: function() {    
              $('.abcjs-time-signature').removeClass('currentNote');
              $('.abcjs-note').removeClass('currentNote'); 
              if(typeof finishPlayFn==='function'){
                finishPlayFn();
              }
            },
            onBeat: function(beatNumber) { 
              if(beatNumber%beat===0){ 
                //app.synth.triggerAttackRelease('A4','16n');
              }else{ 
                //app.synth.triggerAttackRelease('A4','16n');
              }           
            },
            onEvent: function(event) {  
              $('.abcjs-time-signature').removeClass('currentNote'); 
              $('.abcjs-note').removeClass('currentNote');
              $('.abcjs-rest').removeClass('currentNote');
              try{
                $(event.elements[0][0]).addClass('currentNote');
              }catch(e){
                console.error(e);
              } 
            }
          },{
            displayRestart: true, 
            displayLoop: true,
            displayPlay: true, 
            displayProgress: true 
          });
 
          app.playMusicSheet[1] = new ABCJS.synth.CreateSynth(); 
          app.playMusicSheet[1].init({  
            visualObj: app.musicSheet[0]
          }).then(function (results){
            app.playMusicSheet[0].setTune( app.musicSheet[0],false,{ 
              soundFontVolumeMultiplier: '1' //'0' sound off
            }).then(function (response) {
              //console.log("Audio successfully loaded.");
              if(typeof endFn==='function'){
                var i=0;
                i = app.rhythms.findIndex(function(e){
                  return e.id==app.rhythm;
                }); 
                app.rhythms[i].visual.bpm=app.bpm;
                endFn(app.rhythms[i].visual);
              }
            }).catch(function (error) {
              console.warn("Audio problem:", error);
            });
          }).catch(function (reason) {
            console.log(reason);
          }); 
          
          //console.log('app exe end');
        }
      }; 
      var web = {  
        currentToast: undefined,
        bpm: 120,
        rhythm: 'r24_1',
        toast: function (data){
          if(this.currentToast!==undefined){
            this.currentToast.close(true);
          }
          this.currentToast = UIkit.notification({
              message: data,
              status: 'primary',
              pos: 'top-right',
              timeout: 4000
          }); 
        }, 
        resize: function(){  
          $('#visual').innerHeight($(window).innerHeight()/2-$('#header').innerHeight()-20);
          //$('#main').innerHeight($(window).innerHeight()-$('#visual').innerHeight()-$('#header').innerHeight()-20);
          web.exeApp();  
        },
        loaderE: '<div id="loader" class="center"> <div uk-spinner="ratio: 6"></div></div>',
        loaderOn: function(){
          $('body').append(this.loaderE);
        },
        loaderOff: function(){
          $('#loader').remove();
        },
        resetMain: function(){
          $('#main').html(' ');
          web.resetPlayBtn();
          $('button').attr('disabled',false);
        },
        initInputElements:function(){    
          $('#tempoBar').val(web.bpm);
          $('#tempoBarValue').html($('#tempoBar').val()); 
          $('#tempoBar').on('change',function(){ 
            $('#tempoBarValue').html($('#tempoBar').val()); 
            web.bpm=parseInt($('#tempoBar').val()); 
            web.exeApp();  
          });
          $('#tempoBar').trigger('change'); 
          
          web.resetPlayBtn();
          $('#playBtn').on('click',function(){ 
            $('.abcjs-midi-reset').trigger('click');
            $('.abcjs-midi-start').trigger('click');  
            web.syncVisual(); 
          });

          web.resetLoopBtn();
          $('#loopBtn').on('click',function(){
            $('.abcjs-midi-loop').trigger('click'); 
          }); 
  
          $.each(app.rhythms,function(i,e){  
            $('#rhythmSelect').append('<option value="'+app.rhythms[i].id+'">'+app.rhythms[i].title+'</option>'); 
          });

          $('#rhythmSelect').val(web.rhythm);
          $('#rhythmSelect').on('change',function(){   
            web.rhythm=$('#rhythmSelect').val();
            web.toast('Rhythm: '+$( "#rhythmSelect option:selected" ).text()); 
            web.exeApp();  
          }); 
          $('#rhythmSelect').trigger('change');  
        },
        resetPlayBtn: function(){ 
          var $e = $('#playBtn');
          $e.removeClass('stop');
          $e.addClass('play');
          $e.html('<span uk-icon="play-circle"></span>');  
          web.syncVisual(); 
        },
        resetLoopBtn: function(){ 
          var $e = $('#loopBtn');
          $e.removeClass('play');
          $e.addClass('stop');
          $e.html('<span uk-icon="refresh"></span>Off'); 
        },
        endLoadSongFn: function(){
          $('.abcjs-midi-start').on('click',function(){  
            var $e = $('#playBtn');
            if($e.hasClass('play')){
              $e.removeClass('play');
              $e.addClass('stop');
              $e.html('<span uk-icon="ban"></span>'); 
            }else{ 
              $e.removeClass('stop');
              $e.addClass('play');
              $e.html('<span uk-icon="play-circle"></span>'); 
            };        
          }); 
          $('.abcjs-midi-loop').on('click',function(){
            var $e = $('#loopBtn');
            if($e.hasClass('play')){
              $e.removeClass('play');
              $e.addClass('stop');
              $e.html('<span uk-icon="refresh"></span>Off'); 
            }else{ 
              $e.removeClass('stop');
              $e.addClass('play');
              $e.html('<span uk-icon="refresh"></span>On'); 
            };  
          });   
        }, 
        syncAppValue: function(){ 
          app.bpm=web.bpm;  
          app.rhythm=web.rhythm;
        },
        exeApp: function(){
          web.syncAppValue();   
          web.resetPlayBtn();  
          web.resetLoopBtn();      
          app.init(function clickFn(noteText){ 
            web.toast(noteText);             
          },function endFn(data){ 
            web.endLoadSongFn(); 
            visual.init(data);             
          },function finishPlayFn(){ 
            web.resetPlayBtn();             
          }); 
        },
        syncVisual: function(){  
          visual.play=!visual.play; 
        },
        init: function (){   
          //console.log('web exe init');
          web.loaderOn();
          web.initInputElements();  
          web.resetMain(); 
          web.resize(); 
          $(window).on('resize',web.resize); 
          web.loaderOff();  
          web.toast('Start App'); 
          //console.log('web exe end');
        }        
      } 
      web.init();
    })();
    </script>
    <noscript>JAVASCRIPT NOT WORKING!</noscript>
  </body>
</html>
