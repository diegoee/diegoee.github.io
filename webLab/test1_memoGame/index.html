<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Web test">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons" >
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.100.2/css/materialize.min.css">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, minimal-ui">
    <title>Web Test1_menoGame</title>
    <style>
      .center{
        margin: 5px;
        padding: 0px;
        /*IMPORTANTE*/
        display: flex;
        justify-content: center;
        align-items: center;
      }
      .margin{
        margin: 15px;
        margin-left: 40px;
        margin-right: 40px;
      }
      .pointer{
        transition: 0.175s;
        cursor: pointer;
        opacity: 1;
      }
      .pointer:active{
        opacity: 0.25;
      }
      .pointer.active{
        opacity: 0.25;
      }
      #version{
        position: absolute;
        margin: 0;
        padding: 0;
        top: 0;
        right: 0;
        font-size: 0.625em;
      }
    </style>
  </head>
  <body>
    <div id="version"></div>

    <div id="app">
      <div class="row right-align margin">
        <a id="helpBtn" class="waves-effect waves-light btn"><i class="material-icons left">help_outline</i>Help</a>
        <a id="startGameBtn" class="waves-effect waves-light btn"><i class="material-icons left">play_arrow</i>Start</a>
      </div>

      <div id="squares">
        <div class="row center-align center">
          <div data="0" class="col s6 red darken-1 center z-depth-4 ">
            <h2 class="white-text">1</h2>
          </div>
          <div data="1" class="col s6 blue darken-1 center z-depth-4 ">
            <h2 class="white-text">2</h2>
          </div>
        </div>
        <div class="row center">
          <div data="2" class="col s6 green darken-1 center z-depth-4 ">
            <h2 class="white-text">3</h2>
          </div>
          <div  data="3" class="col s6 yellow darken-1 center z-depth-4 ">
            <h2 class="white-text">4</h2>
          </div>
        </div>
      </div>

      <!-- Modal Structure -->
      <div id="modalHelp" class="modal">
        <div class="modal-content">
          <h4>The Memo Game</h4>

          <ul class="collapsible" data-collapsible="expandable">
            <li>
              <div class="collapsible-header active">
                <i class="material-icons"> play_arrow</i>1st
              </div>
              <div class="collapsible-body">
                <span>Press button <i>Start</i></span>
              </div>
            </li>
            <li>
              <div class="collapsible-header active">
                <i class="material-icons">tag_faces</i>2nd
              </div>
              <div class="collapsible-body">
                <span>Use your smart mind to repeat the secuence...</span>
              </div>
            </li>
            <li>
              <div class="collapsible-header active">
                <i class="material-icons">repeat</i>3rd
              </div>
              <div class="collapsible-body">
                <span>Repeat all the secuences as you can. If you fail, you are OVER!!</span>
              </div>
            </li>
          </ul>
          <p>Enjoy the Game, improve your score and have fun! :)</p>
        </div>
        <div class="modal-footer">
          <a href="#!" class="modal-action modal-close waves-effect waves-green btn-flat">Got it!!</a>
        </div>
      </div>

    </div>

    <script type="text/javascript" src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.100.2/js/materialize.min.js"></script>  
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/tone/13.0.1/Tone.min.js"></script>      
    <script type="text/javascript">
    /*global $, Materialize, window, setTimeout, clearTimeout, Promise, Tone*/
    (function exe(){
      //versi√≥n
      $('#version').html('v1.4.0'); 
      //app
      var app = {
        synth: undefined,
        notes:[ //['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
          'C4',  
          'E4', 
          'G4',
          'B4'
        ], 
        score: 0,
        startGame: function(){
          var self = this;

          $('.btn').addClass('disabled');
          var $squares = $('#squares .col');
          $squares.addClass('pointer');

          var pGame = new Promise(function(resolve) {
            console.log('Promise created');
            var sec = [];
            var rndN = 0;
            var round = 0;
            self.score= 0;

            ///---START---
            function gameGoOn(){
              round++;
              rndN = Math.floor((Math.random()*$squares.length));
              sec.push(rndN);

              self.toast('<h5>Round: '+round+'</h5>');

              $squares.off('click');
              $squares.removeClass('pointer');
              $squares.removeClass('active');

              var ii = 0;
              var p1 = new Promise(function(resolve){
                //console.log('repro secuence');
                function repro(){
                  //console.log('repro - n='+ii+' - element='+sec[ii]);
                  $squares.off('transitionend webkitTransitionEnd oTransitionEnd otransitionend MSTransitionEnd');
                  $($squares[sec[ii]]).addClass('pointer');
                  $($squares[sec[ii]]).addClass('active'); 
                  self.synth.triggerAttackRelease(self.notes[sec[ii]],'8n');
                  $($squares[sec[ii]]).on('transitionend webkitTransitionEnd oTransitionEnd otransitionend MSTransitionEnd', function() {
                    $($squares[sec[ii]]).removeClass('pointer');
                    $($squares[sec[ii]]).removeClass('active');
                    ii++;
                    if (ii<sec.length){
                      setTimeout(function(){
                        repro();
                      },250);
                    }else{
                      resolve();
                    }
                  });
                }
                setTimeout(function(){
                  repro();
                },1000);

              });

              p1.then(function(){
                //console.log('check secuence');
                var checkSec = 0;
                $squares.addClass('pointer');
                $squares.on('click',function(){
                  //console.log('check - click='+$(this).attr('data')+' - sec='+sec[checkSec]); 
                  self.synth.triggerAttackRelease(self.notes[parseInt($(this).attr('data'))],'8n');
                  if (parseInt($(this).attr('data'))===sec[checkSec]){
                    checkSec++;
                    if(checkSec<sec.length){
                      self.toast('<h6>Good! Carry on..('+checkSec+'/'+sec.length+')</h6>');
                    }else{
                      self.toast('<h6>Good! complete('+checkSec+'/'+sec.length+')</h6>');
                      self.score++;
                      gameGoOn();
                    }
                  }else{
                    self.toast('<h6>Fail! (it was '+(sec[checkSec]+1)+' and you click '+(parseInt($(this).attr('data'))+1)+')</h6>');
                    resolve();
                    return;
                  }
                });
              });
            }
            gameGoOn();

          });

          pGame.then(function(){
            console.log('Promise then');
            self.gameOver();
          });

        },
        toast: function (data){
          Materialize.Toast.removeAll();
          Materialize.toast(data, 5000);
        },
        gameOver: function (){
          var self = this;
          var data = '<div><h5>Game Over</h5><p>Score: '+this.score+' Round(s)</p></div>';
          $('#squares .col').removeClass('pointer');
          $('#squares .col').off('click');
          Materialize.toast(data, 5000, '', function(){
            $('.btn').removeClass('disabled');
            $('.btn').removeClass('pulse');
            self.playSoudElem();
          });
        },
        resizeElement: function (){
          var h=($(window).height()-$($('.row')[0]).height())/2-35;
          $('#squares .col').height(h);
        },
        playSoudElem: function playSoudElem(){
          var self = this;
          var $squares = $('#squares .col');
          $squares.addClass('pointer');
          $squares.on('click',function(){ 
            self.synth.triggerAttackRelease(self.notes[parseInt($(this).attr('data'))],'8n');
          });
        },
        init: function (){
          var self = this; 
          self.synth = new Tone.Synth().toMaster();
          var inter = setTimeout(function(){
            $('#startGameBtn').addClass('pulse');
          },3000);
          $('.btn').on('click',function(){
            clearTimeout(inter);
            $('.btn').removeClass('pulse');
          });
          $('#startGameBtn').on('click',function(){
            self.startGame();
          });

          $('#helpBtn').on('click',this.showModal);
          $('#helpBtn').addClass('modal-trigger');
          $('#helpBtn').attr('href','#modalHelp');
          $('#modalHelp').modal();
          $('.collapsible').collapsible();

          this.resizeElement();
          $(window).on('resize',this.resizeElement);

          this.playSoudElem();

        }
      };
      app.init();
    })();
    </script>
    <noscript>JAVASCRIPT NOT WORKING!</noscript>
  </body>
</html>
