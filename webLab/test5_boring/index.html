<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8"> 
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Web test">  
    <meta name="format-detection" content="telephone=no">
    <title>Web Test5_boring</title> 
    <style> 
      html,body{ 
        background-color: #333; 
        -webkit-user-select: none;  
        -khtml-user-select: none;  
        -moz-user-select: none;  
        -ms-user-select: none;  
        user-select: none; 
        -webkit-tap-highlight-color: transparent; 
      } 
      canvas{
        position: absolute;
        top: 0;
        left: 0; 
        width: 100%;
        height: 100%;
      }
      #menu{
        position: absolute; 
        top: 15px;
        right: 15px; 
        color: #EEE;
        cursor: pointer;
        font-size: 1em;
        z-index: 1;
      } 
    </style>
  </head>
  <body>     
    <div id="menu"></div>
    <script type="text/javascript" src="https://code.jquery.com/jquery-3.2.1.min.js"></script> 
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/paper.js/0.12.15/paper-full.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/tone/13.0.1/Tone.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/js/all.min.js"></script>
    <script type="text/javascript">  
    var app = { 
      canvasEle: '<canvas id="canvas"></canvas>', 
      soundOnEle: '<i class="fas fa-volume-up"></i>', 
      soundOffEle: '<i class="fas fa-volume-mute"></i>',  
      soundOnOff: true,
      synth: undefined,
      init: function(){ 
        var self = this;
        paper.install(window); 
        self.resetCanvas();
        self.synth = new Tone.Synth().toMaster(); 
        if(self.soundOnOff){
          $('#menu').html(self.soundOnEle);
        }else{
          $('#menu').html(self.soundOffEle); 
        }
        $('#menu').off('click');
        $('#menu').on('click',function(){ 
          self.soundOnOff=!self.soundOnOff;
          if(self.soundOnOff){
            $('#menu').html(self.soundOnEle);
          }else{
            $('#menu').html(self.soundOffEle); 
          } 
        });
      }, 
      resetCanvas: function(){ 
        $('#canvas').remove();
        $('body').append(this.canvasEle);
	      paper.setup('canvas');
      },
      playSoundLimit: function(type){
        ///console.log(type); 
        if(this.soundOnOff){
          this.synth.triggerAttackRelease('A3','32n'); 
        }
      },
      playSoundDelete: function(){ 
        if(this.soundOnOff){
          this.synth.triggerAttackRelease('E3','128n'); 
        }
      },
      nObj: 5,
      create: function(){ 
        this.resetCanvas(); 
        var self = this; 

        var limits = new Group({
          children: [], 
          position: view.center
        }); 
        limits.l=5
        limits.data=[{
          point: [0, 0],
          size: [view.size.width,limits.l],
        },{
          point: [0, 0],
          size: [limits.l,view.size.height],
        },{
          point: [0, view.size.height-limits.l],
          size: [view.size.width,limits.l],
        },{
          point: [view.size.width-limits.l, 0],
          size: [limits.l,view.size.height],
        }];
        
        for (var i=0; i<limits.data.length; i++){ 
          limits.children.push(new Path.Rectangle({
            point: limits.data[i].point,
            size: limits.data[i].size, 
            fillColor: '#EEE', 
            opacity: 0,
            onFrame:  function(e){
              if(this.opacity===0){ 
                this.opacity=0;  
              }else{
                this.opacity-=0.025;
              }
            } 
          }));  
        }   

        var s = 20;
        s = (view.size.width>view.size.height?view.size.width/s:view.size.height/s);

        function createObj(destroyer){
          var obj = new Path.Rectangle({
            position: view.center,
            size: [s,s], 
            fillColor: (destroyer?'#EEE':'#AAA'),
            isMoving: false, 
            isDying: false, 
            isDeath: false, 
            isAKiller: false,
            onMouseDown: function(){ 
              this.xTo = (Math.random()-0.5>0?1:-1)*this.v*Math.random();
              this.yTo = (Math.random()-0.5>0?1:-1)*this.v*Math.random();
              if(this.isDying){
                this.isDeath=true;
              }
              if(this.isDeath){
                this.remove();
              }
            }, 
            v: 5,
            xTo: 0,
            yTo: 0, 
            angle: 0.25*Math.random(),  
            changeXtoAndYto(){ 
              var v = this.v; 
              this.angle = Math.random(); 
              var l = limits.l;   
              if (this.position.x>l&&this.position.x<view.center.x/10){  
                self.playSoundLimit('left');
                this.xTo = +1*v*Math.random(); 
              }          
              if (this.position.x>view.size.width-l-s/2&&this.position.x>view.center.x/10){ 
                self.playSoundLimit('right');
                this.xTo = -1*v*Math.random(); 
              }  
              if (this.position.y>l&&this.position.y<view.center.y/2){ 
                self.playSoundLimit('top');
                this.yTo = +1*v*Math.random(); 
              }          
              if (this.position.y>view.size.height-l-s/2&&this.position.y>view.center.y/10){ 
                self.playSoundLimit('bottom');
                this.yTo = -1*v*Math.random(); 
              } 
            },
            move: function(){
              this.rotate(2*Math.PI*this.angle);  
              this.position.x=this.position.x+this.xTo; 
              this.position.y=this.position.y+this.yTo;  
            },
            onFrame: function(e){
              if(this.isMoving){ 
                this.move();
                if(intersectionLimit(this)){
                  this.changeXtoAndYto();
                } 
              } 
              if(this.isDying){   
                this.opacity-=0.015; 
                if(this.opacity<=0){
                  this.opacity=1;
                  this.isDeath=true;
                }
              }
              if(this.isAKiller){   
                this.opacity-=0.1; 
                this.fillColor='#000'; 
                if(this.opacity<=0){
                  this.opacity=1;
                  this.fillColor='#EEE';
                  this.isAKiller=false;
                }
              }
            } 
          });
          return obj; 
        }  
 
        var objs=[];
        for(var i=0; i<this.nObj; i++ ){
          objs.push(createObj(false)); 
        } 
        var objAlpha = createObj(true);

        function intersectionLimit(obj){
            var isIntersected = false;
            for (var i=0; i<limits.children.length; i++){ 
              var item = limits.children[i].intersect(obj);
              isIntersected=item.closed; 
              item.remove(); 
              if(isIntersected){ 
                limits.children[i].opacity=1; 
                break;
              }
            }    
            return isIntersected;
        }   
 
        view.on('mousedown',function(){  
          for(var i=0; i<objs.length; i++ ){ 
            objs[i].isMoving=!objs[i].isMoving&&!objs[i].isDeath&&!objs[i].isDying;
            objs[i].changeXtoAndYto();
          }           
          objAlpha.isMoving=!objAlpha.isMoving;
          objAlpha.changeXtoAndYto();
        });

        view.on('frame',function(e){
          if(e.count>200){
            for (var i=0; i<objs.length; i++){ 
              var item = objAlpha.intersect(objs[i]);
              isIntersected=item.closed; 
              item.remove(); 
              if(isIntersected&&!objs[i].isDeath){ 
                objs[i].isDying=true;   
                objs[i].isMoving=false;  
                objAlpha.isAKiller=true; 
                self.playSoundDelete(); 
              }
            } 
          }  
        });   

        for(var i=0; i<objs.length; i++ ){ 
          objs[i].isMoving=!objs[i].isMoving;
          objs[i].onMouseDown();
        }  
        objAlpha.isMoving=!objAlpha.isMoving;
        objAlpha.onMouseDown(); 

      },    
      exe: function(){
        console.clear(); 
        console.log('http://paperjs.org/reference/global/'); 
        console.log('app exe ini');  
        var self = this; 
        self.init();
        $(window).off('resize');
        $(window).on('resize',function(){ 
          self.create();
        });    
        self.create();
        console.log('app exe end'); 
      }
	  }
    app.exe();
    </script> 
  </body>
</html>
