<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, minimal-ui"> 
    <title>Web Test4_abcMusic</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css" rel="stylesheet" type="text/css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css" rel="stylesheet" type="text/css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/abcjs@6.0.0-beta.35/abcjs-audio.css" />
    <style>   
      #version{
        position: absolute;
        margin: 0;
        padding: 0;
        top: 0;
        left: 5px;
        font-size: 0.75em;
        z-index: 200;
      }  
      #control{
        height: 40px; 
      }  
      .abcjs-inline-audio{
        height: 40px;
        padding: 0 10px;
      }
      .abcjs-inline-audio .abcjs-btn{ 
        padding: 0px;
        margin-left: 20px;
        margin-right: 20px;
      }
      .currentNote{
        color: #2196F3;
      }
      @media print{
        @page { 
          size: A4 portrait;
        } 
        #version, #control, #menu, #text, #menuScreen{  
          display: none; 
        }
      }

      #menuScreen{
        position: absolute;
        margin: 0;
        padding: 0;
        top: 0;
        left: -100%;
        width: 100%; 
        height: 100%; 
        z-index: 100;
        transition: ease-in-out 0.25s;
      }
      #menuScreen.open{
        position: absolute;
        margin: 0;
        padding: 0;
        top: 0;
        left: 0; 
      }  
      .closeBtnContainer{
        padding: 1em;
        margin-bottom: 2em;
      } 
      .m{ 
        margin: 1em;
      }
      .mb{
        margin-bottom: 3em;
      } 
      #file{
        display: none;
      }
    </style>  
  </head>
  <body>
    <div id="version"></div>
    <div id='menuScreen' class="bg-light"> 
      <div class="closeBtnContainer">
        <button type="button" class="close" aria-label="Close" id="btnMenuClose"><i class="fas fa-times"></i></button>
      </div>
      <div class="card m">
        <div class="card-body"> 
          <div class="container"> 
            <div class="row mb">    
              <div class="col-md-3"></div>
              <div class="col-md-6">
                <button type="button" class="btn btn-outline-dark btn-lg btn-block" id="btnPrint"> <i class="fas fa-print"></i> Print</button> 
              </div>
              <div class="col-md-3"></div> 
            </div>
            <div class="row mb">  
              <div class="col-md-3"></div>
              <div class="col-md-6">
                <div class="form-group">
                  <label class="btn btn-outline-dark btn-lg btn-block" for="file"><i class="fas fa-upload"></i> Load abc file </label>
                  <input type="file" class="form-control-file" id="file"> 
                </div>   
              </div>
              <div class="col-md-3"></div>
            </div>
            <div class="row mb">  
              <div class="col-md-3"></div>
              <div class="col-md-6">
                <button type="button" class="btn btn-outline-dark btn-lg btn-block" id="btnDownload"><i class="fas fa-download"></i> Download abc file </button> 
              </div>
              <div class="col-md-3"></div>
            </div>
            <div class="row mb">  
              <div class="col-md-3"></div>
              <div class="col-md-3">
                <div class="form-group">
                  <select class="form-control form-control-lg" id="selectSong"></select> 
                </div> 
              </div>
              <div class="col-md-3">
                <button type="button" class="btn btn-outline-dark btn-lg btn-block" id="btnSong"><i class="fas fa-play"></i> Load song</button> 
              </div>
              <div class="col-md-3"></div>
            </div>
          </div> 
        </div>
      </div>
    </div>
    <nav id='menu' class="navbar navbar-expand-lg navbar-light bg-light">
      <div class="container-fluid"> 
        <span class="navbar-brand"><a href="https://abcnotation.com/examples" class="" >Abc Anotation Music</a></span>   
        <ul class="nav justify-content-end"> 
          <li class="nav-item"><button type="button" class="btn btn-outline-dark" id="btnMenu"><i class="fas fa-bars"></i></button></li>   
        </ul>
      </div> 
    </nav> 
    <div id="control" class=""></div> 
    <div class="container"> 
    <div class="row">   
      <div class="col-12">  
        <div id="main">Hola</div>  
        <div id="text"  class="form-row">
          <div class="input-group displayGroup">
            <span class="input-group-text">abc</span>
            <textarea class="form-control" aria-label="With textarea" id="inputText"></textarea>
          </div> 
        </div>
      </div>  
    </div>
    </div> 
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js"></script>  
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/abcjs@6.0.0-beta.35/dist/abcjs-basic-min.js"></script> 
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/tone/13.0.1/Tone.min.js"></script>
    <script type="text/javascript">  
      var abcjs=window.ABCJS;  
      $('#version').html('v1.1');
      var app = { 
        songs: [],
        inter: undefined,
        playMusicSheet: [undefined,undefined],
        musicSheet: '',
        synth: undefined,  
        translateNote: function(noteName,pitch){ 
          var notesPitchTranslator = [ 
            [ 48,    49,  50,   51,  52,  53,  54,     55,    56, 57,    58, 59 ],  
            [  3,     3,   3,    3,   3,   3,    3,     3,     3,   3,    3,  3 ],
            ['C',  'C#', 'D', 'D#', 'E', 'F',  'F#',  'G',  'G#', 'A', 'A#', 'B'],
            ['Do','Do#','Re','Re#','Mi','Fa', 'Fa#','Sol','sol#','La','La#','Si'],
            ['C',  'Db', 'D', 'Eb', 'E', 'F',  'Gb',  'G',  'Ab', 'A', 'Bb', 'B'],
            ['Do','Reb','Re','Mib','Mi','Fa','Solb','Sol', 'Lab','La','Sib','Si'],
          ]; 
          var l = notesPitchTranslator[0].length;
          for (var i=0;i<4;i++){
            for (var ii=0;ii<l;ii++){
              notesPitchTranslator[0].push(notesPitchTranslator[0][notesPitchTranslator[0].length-1]+1);
              notesPitchTranslator[1].push(4+i);
              notesPitchTranslator[2].push(notesPitchTranslator[2][ii]);
              notesPitchTranslator[3].push(notesPitchTranslator[3][ii]);
              notesPitchTranslator[4].push(notesPitchTranslator[4][ii]);
              notesPitchTranslator[5].push(notesPitchTranslator[5][ii]);
            }
          }  
          var res = notesPitchTranslator[0].findIndex(function(e){
            return e===pitch;
          });   
          res = notesPitchTranslator[2][res]+notesPitchTranslator[1][res];         
          return res;
        }, 
        createMusicSheet: function(){ 
          //console.log(abc);
          var abc = $('#inputText').val(); 
          this.musicSheet = abcjs.renderAbc('main',abc,{ 
            add_classes: true,
            responsive: 'resize',
            clickListener: function(e){ 
              var note = app.translateNote(e.pitches[0].name,e.midiPitches[0].pitch,0); 
              app.synth.triggerAttackRelease(note,'8n'); 
            }
          });    
          this.resetStatePlayer();
        },
        resetStatePlayer: function(){ 
          if($('.abcjs-midi-start').hasClass('abcjs-pushed')){
            $('.abcjs-midi-start').trigger('click');  
          }
          app.playMusicSheet=[undefined,undefined];
          $('#control').html(' ');
        },
        resetPlayer:function(){  
          this.resetStatePlayer();
          
          this.playMusicSheet[0] = new ABCJS.synth.SynthController();
          this.playMusicSheet[0].load("#control", {
            beatSubdivisions: 1,
            extraMeasuresAtBeginning: 0,
            onStart: function() {    
              $('.abcjs-note').removeClass('currentNote');
              $('.abcjs-rest').removeClass('currentNote'); 
              $('.abcjs-time-signature').removeClass('currentNote');
              $('.abcjs-time-signature').addClass('currentNote');
            },
            onFinished: function() {    
              $('.abcjs-time-signature').removeClass('currentNote');
              $('.abcjs-note').removeClass('currentNote');  
            },
            onBeat: function(beatNumber) {  
            },
            onEvent: function(event) {  
              $('.abcjs-time-signature').removeClass('currentNote'); 
              $('.abcjs-note').removeClass('currentNote');
              $('.abcjs-rest').removeClass('currentNote');
              try{
                $(event.elements[0][0]).addClass('currentNote');
              }catch(e){
                console.error(e);
              } 
            }
          },{
            displayRestart: true, 
            displayLoop: true,
            displayPlay: true, 
            displayProgress: true 
          });
  
          this.playMusicSheet[1] = new ABCJS.synth.CreateSynth(); 
          this.playMusicSheet[1].init({  
            visualObj: app.musicSheet[0]
          }).then(function (results){
            app.playMusicSheet[0].setTune( app.musicSheet[0],false,{ 
              soundFontVolumeMultiplier: '1' //'0' sound off
            }).then(function (response) {
              console.log("Audio successfully loaded.");  
            }).catch(function (error) {
              console.warn("Audio problem:", error);
            });
          }).catch(function (reason) {
            console.log(reason);
          }); 

        },
        resize: function(){  
          $('#inputText').innerHeight($(window).innerHeight()/2);  
          var h = $('#menu').innerHeight()+$('#control').innerHeight()+$('#main').innerHeight()+$('#text').innerHeight();
          $('#menuScreen').innerHeight(h); 
        },
        openCloseMenu: function(){
          if($('#menuScreen').hasClass('open')){
            $('#menuScreen').removeClass('open'); 
          }else{
            $('#menuScreen').addClass('open'); 
          }
        }, 
        init: function(){
          console.log('app exe start');
          var self = this; 
          self.synth = new Tone.Synth().toMaster(); 

          $('#btnPrint').on('click',function(){ 
            window.print(); 
            self.openCloseMenu();
          });

          var counterFile = 0;
          $('#btnDownload').on('click',function(){ 
            var text = $('#inputText').val();;
            var filename = 'song'+counterFile+'.abc';
            counterFile++;
            var element = document.createElement('a');
            element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
            element.setAttribute('download', filename);
            element.style.display = 'none';
            document.body.appendChild(element);
            element.click();
            document.body.removeChild(element);
            self.openCloseMenu();
          });

          $('#btnMenu').on('click',function(){ 
            self.openCloseMenu();
          });

          $('#btnMenuClose').on('click',function(){ 
            self.openCloseMenu();
          });

          $('#inputText').val(' ');
          $('#inputText').on('change',function(){ 
            //console.log('change');
            self.createMusicSheet();
            self.resetPlayer();   
          }); 

          $('#file').on('change',function(){ 
            if (this.files && this.files[0]) {
              console.log(this.files);
              var myFile = this.files[0];
              var reader = new FileReader();              
              reader.addEventListener('load', function (e) {
                $('#inputText').val(e.target.result);
              });              
              reader.readAsBinaryString(myFile);
              self.openCloseMenu();
            }   
          }); 

          $('#selectSong').append();
          for(var i in self.songs){
            //TODO: get tittle song
            var name = self.songs[i].substring(self.songs[i].indexOf("T:"),self.songs[i].length);
            name = name.substring(2,name.indexOf("\n")); 
            $('#selectSong').append('<option value='+i+'>'+name+'</option>');
          }
          $('#btnSong').on('click',function(){ 
            var i = parseInt($('#selectSong').val()); 
            $('#inputText').val(self.songs[i]);
            self.openCloseMenu();
          });

          self.createMusicSheet();
          self.resetPlayer(); 

          self.resize(); 
          $(window).on('resize',self.resize);   

          var valSheet = $('#inputText').val();
          self.inter = setInterval(function(){ 
            if(valSheet!==$('#inputText').val()){ 
              $('#inputText').trigger('change');
              self.resize();
            }
            valSheet=$('#inputText').val();
          },1000);  

          console.log('app exe end');
        }      
      };    
      var abc='';
      
      abc=''; 
      abc=abc+'X:1\n';
      abc=abc+'T:My Hot and Humid Solo\n'; 
      abc=abc+'M:C\n';
      abc=abc+'Q:126\n';
      abc=abc+'K:Em\n'; 
      abc=abc+'B1 B2 A1G1|';
      abc=abc+'"Em"E2z2z1G1E2|z2B1 B1B2A1G1|E2z2B,1^C1E2|z4z2F1G1|\n';
      abc=abc+'"Am"A2z2z1B1A2|z4z2F1G1|A2A2z1G1E2|z3B1 B2 A1G1|\n';
      abc=abc+'"Em"E2z2z1G1E2|z2B1 B1B2A1G1|E2z2B,1^C1E2|z4F1G1|\n'; 
      abc=abc+'"G"_A2 =A1G1  A3 z1 |z2e2 B1A1 G1A1 |"Em" G1E1z2B2E2|z8|]\n';       
      app.songs.push(abc);  
 
      abc=''; 
      abc=abc+'X:1\n';
      abc=abc+'T:My Love for Sale Solo\n'; 
      abc=abc+'M:C\n';
      abc=abc+'Q:165\n';
      abc=abc+'K:Cm\n'; 
      abc=abc+'"F"(c8|c2)z2=A4|"Cm"G4z2E2|C2z2E4|\n';
      abc=abc+'"F"z2F2G4|z2E2C2B,2|"Cm"/(C8|C6)z2|\n';
      abc=abc+'"F"z1D1F2F1F3|z1D1F2F1F3|"Eb"G4F4|E4C4|\n';
      abc=abc+'"Dm"G8|z4c2G2|"Cm"(C8|C8)|]\n'; 
      
      app.songs.push(abc); 
      app.init(); 

      $('#inputText').val(app.songs[1]);
      //$('#btnMenu').trigger('click'); 
 

    </script> 
  </body>
</html>
