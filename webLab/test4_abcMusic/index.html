<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, minimal-ui"> 
    <title>Web Test4_abcMusic</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css" rel="stylesheet" type="text/css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css" rel="stylesheet" type="text/css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/abcjs@6.0.0-beta.35/abcjs-audio.css" />
    <style>   
      #version{
        position: absolute;
        margin: 0;
        padding: 0;
        top: 0;
        left: 5px;
        font-size: 0.75em;
        z-index: 200;
      }  
      #control{
        height: 40px; 
      }  
      .abcjs-inline-audio{
        height: 40px;
        padding: 0 10px;
      }
      .abcjs-inline-audio .abcjs-btn{ 
        padding: 0px;
        margin-left: 20px;
        margin-right: 20px;
      }
      .currentNote{
        color: #2196F3;
      }
      @media print{
        @page { 
          size: A4 portrait;
        } 
        #version, #control, #menu, #text, #menuScreen, #swing, #transpor{  
          display: none; 
        }
      } 
      #menuScreen{
        position: absolute;
        margin: 0;
        padding: 0;
        top: 0;
        left: -100%;
        width: 100%; 
        height: 100%; 
        z-index: 100;
        transition: ease-in-out 0.25s;
      }
      #menuScreen.open{
        position: absolute;
        margin: 0;
        padding: 0;
        top: 0;
        left: 0;    
      }  
      .closeBtnContainer{
        padding: 1em;
        margin-bottom: 2em;
      }   
      .mb{
        margin-bottom: 3em;
      } 
      #file{
        display: none;
      }
      #loading{
        position: absolute;
        top: 0;
        left: 0; 
        width: 100%;
        height: 100%;
        background-color: rgba(33, 33, 33, 0.85);
        z-index: 1000; 
        font-size: 3em; 
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.5s ease-out; 
      }
      .spinner {
        width: 140px;
        height: 140px;
        margin: 100px auto;
        background-color: #DDD; 
        border-radius: 100%;  
        -webkit-animation: sk-scaleout 1.0s infinite ease-in-out;
        animation: sk-scaleout 1.0s infinite ease-in-out;
      } 
      @-webkit-keyframes sk-scaleout {
        0% { -webkit-transform: scale(0) }
        100% {
          -webkit-transform: scale(1.0);
          opacity: 0;
        }
      } 
      @keyframes sk-scaleout {
        0% { 
          -webkit-transform: scale(0);
          transform: scale(0);
        } 100% {
          -webkit-transform: scale(1.0);
          transform: scale(1.0);
          opacity: 0;
        }
      }
      .notScroll{
        overflow: hidden;
      }
    </style>  
  </head>
  <body>
    <div id="version"></div>
    <div id='menuScreen' class="bg-light"> 
      <div class="closeBtnContainer">
        <button type="button" class="close" aria-label="Close" id="btnMenuClose"><i class="fas fa-times"></i></button>
      </div>
      <div class="card">
        <div class="card-body"> 
          <div class="container"> 
            <div class="row mb">    
              <div class="col-md-3"></div>
              <div class="col-md-6">
                <button type="button" class="btn btn-outline-dark btn-lg btn-block" id="btnPrint"> <i class="fas fa-print"></i> Print</button> 
              </div>
              <div class="col-md-3"></div> 
            </div>
            <div class="row mb">  
              <div class="col-md-3"></div>
              <div class="col-md-6">
                <div class="form-group">
                  <label class="btn btn-outline-dark btn-lg btn-block" for="file"><i class="fas fa-upload"></i> Load .abc file </label>
                  <input type="file" class="form-control-file" id="file"> 
                </div>   
              </div>
              <div class="col-md-3"></div>
            </div>
            <div class="row mb">  
              <div class="col-md-3"></div>
              <div class="col-md-6">
                <button type="button" class="btn btn-outline-dark btn-lg btn-block" id="btnDownload"><i class="fas fa-download"></i> Download abc file </button> 
              </div>
              <div class="col-md-3"></div>
            </div>
            <div class="row mb">  
              <div class="col-md-3"></div>
              <div class="col-md-6">
                <button type="button" class="btn btn-outline-dark btn-lg btn-block" id="btnSong"><i class="fas fa-play"></i> Load song</button> 
              </div>
              <div class="col-md-3"></div>
              <div class="col-md-3"></div>
              <div class="col-md-6">
                <div class="form-group">
                  <select class="form-control form-control-lg" id="selectSong"></select> 
                </div> 
              </div>
              <div class="col-md-3"></div>
            </div>
          </div> 
        </div>
      </div>
    </div>
    <nav id='menu' class="navbar navbar-expand-lg navbar-light bg-light">
      <div class="container-fluid"> 
        <span class="navbar-brand"><a href="https://abcnotation.com/examples" class="" >Abc Anotation Music</a></span>   
        <ul class="nav justify-content-end"> 
          <li class="nav-item"><button type="button" class="btn btn-outline-dark" id="btnMenu"><i class="fas fa-bars"></i></button></li>   
        </ul>
      </div> 
    </nav> 
    <div id="control" class=""></div> 
    <div class="container"> 
    <div class="row">   
      <div class="col-sm-4">    
        <div class="card" id="swing">
          <div class="card-body">
            <div class="input-group"> 
              <div class="form-control custom-control custom-switch">
                <input type="checkbox" class="custom-control-input" id="btnSwing">
                <label class="custom-control-label ml-4" for="btnSwing">Play with "swing"</label>
              </div>
            </div>
          </div> 
        </div>  
      </div>
      <div class="col-sm-8">    
        <div class="card" id="transpor">
          <div class="card-body">
            <div class="input-group">
              <div class="input-group-prepend">
                <label class="input-group-text">Transpor. (1/2)</label>
              </div>
              <select class="custom-select" id="selectTransporSheet"> 
              </select>
              <select class="custom-select" id="selectTransporPitch"> 
              </select>
            </div>
          </div>  
        </div>  
      </div> 
      <div class="col-12">
        <div id="main">Hola</div>  
        <div id="text"  class="form-row">
          <div class="input-group displayGroup">
            <span class="input-group-text">abc</span>
            <textarea class="form-control" aria-label="With textarea" id="inputText"></textarea>
          </div> 
        </div>
      </div>  
    </div>
    </div> 
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js"></script>  
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/abcjs@6.0.0-beta.35/dist/abcjs-basic-min.js"></script> 
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/tone/13.0.1/Tone.min.js"></script>
    <script type="text/javascript" src="songs.js"></script>
    <script type="text/javascript">  
      var abcjs=window.ABCJS;  
      $('#version').html('v1.6');
      var app = { 
        loadE: '<div id="loading"><div class="spinner"></div></div>', 
        loadOn: function(){
          app.loadOff();
          $('body').append(app.loadE);
          $('body').addClass('notScroll');
        },
        loadOff: function(){   
          $('#loading').remove(); 
          $('body').removeClass('notScroll');
        },
        songs: [],
        inter: undefined,
        playMusicSheet: [undefined,undefined],
        musicSheet: '',
        synth: undefined,  
        swingMode: false,
        translateNote: function(noteName,pitch){ 
          var notesPitchTranslator = [ 
            [ 48,    49,  50,   51,  52,  53,  54,     55,    56, 57,    58, 59 ],  
            [  3,     3,   3,    3,   3,   3,    3,     3,     3,   3,    3,  3 ],
            ['C',  'C#', 'D', 'D#', 'E', 'F',  'F#',  'G',  'G#', 'A', 'A#', 'B'],
            ['Do','Do#','Re','Re#','Mi','Fa', 'Fa#','Sol','sol#','La','La#','Si'],
            ['C',  'Db', 'D', 'Eb', 'E', 'F',  'Gb',  'G',  'Ab', 'A', 'Bb', 'B'],
            ['Do','Reb','Re','Mib','Mi','Fa','Solb','Sol', 'Lab','La','Sib','Si'],
          ]; 
          var l = notesPitchTranslator[0].length;
          for (var i=0;i<4;i++){
            for (var ii=0;ii<l;ii++){
              notesPitchTranslator[0].push(notesPitchTranslator[0][notesPitchTranslator[0].length-1]+1);
              notesPitchTranslator[1].push(4+i);
              notesPitchTranslator[2].push(notesPitchTranslator[2][ii]);
              notesPitchTranslator[3].push(notesPitchTranslator[3][ii]);
              notesPitchTranslator[4].push(notesPitchTranslator[4][ii]);
              notesPitchTranslator[5].push(notesPitchTranslator[5][ii]);
            }
          }  
          var res = notesPitchTranslator[0].findIndex(function(e){
            return e===pitch;
          });   
          res = notesPitchTranslator[2][res]+notesPitchTranslator[1][res];         
          return res;
        }, 
        createMusicSheet: function(musicSheet,transpose){ 
          //console.log(abc);
          var abc = musicSheet; 
          this.musicSheet = abcjs.renderAbc('main',abc,{ 
            add_classes: true,
            visualTranspose: transpose,
            responsive: 'resize',
            clickListener: function(e){ 
              var note = app.translateNote(e.pitches[0].name,e.midiPitches[0].pitch,0); 
              app.synth.triggerAttackRelease(note,'8n'); 
            }
          });    
          this.resetStatePlayer();
        },
        resetStatePlayer: function(){  
          if($('.abcjs-midi-start').hasClass('abcjs-pushed')){
            $('.abcjs-midi-start').trigger('click');  
          }
          app.playMusicSheet=[undefined,undefined];
          $('#control').html(' ');
        },
        resetPlayer:function(transpose){  
          this.resetStatePlayer(); 
          var self = this;

          this.playMusicSheet[0] = new ABCJS.synth.SynthController();
          this.playMusicSheet[0].load("#control", {
            beatSubdivisions: 1,
            extraMeasuresAtBeginning: 0,
            onStart: function() {    
              $('.abcjs-note').removeClass('currentNote');
              $('.abcjs-rest').removeClass('currentNote'); 
              $('.abcjs-time-signature').removeClass('currentNote');
              $('.abcjs-time-signature').addClass('currentNote');
            },
            onFinished: function() {    
              $('.abcjs-time-signature').removeClass('currentNote');
              $('.abcjs-note').removeClass('currentNote');  
            },
            onBeat: function(beatNumber) {  
            },
            onEvent: function(event) {  
              $('.abcjs-time-signature').removeClass('currentNote'); 
              $('.abcjs-note').removeClass('currentNote');
              $('.abcjs-rest').removeClass('currentNote');
              try{
                $(event.elements[0][0]).addClass('currentNote');
              }catch(e){
                console.error(e);
              } 
            }
          },{  
            displayRestart: true, 
            displayLoop: true,
            displayPlay: true, 
            displayProgress: true 
          }); 

          this.playMusicSheet[1] = new ABCJS.synth.CreateSynth(); 
          this.playMusicSheet[1].init({  
            visualObj: app.musicSheet[0]
          }).then(function (results){
            app.playMusicSheet[0].setTune( app.musicSheet[0],false,{ 
              soundFontVolumeMultiplier: '1', //'0' sound off,  
              sequenceCallback: function(tracks){
                if(self.swingMode){
                  var value = 2;
                  // The beats are 0.25 long so the amount of swing needs to be between 0 and 0.125,
                  // but practically it needs to be a bit smaller so that it doesn't sound like a grace note.
                  var swing = 0.1 - 0.1 / value; 
                  var track = tracks[0];
                  for (var i = 0; i < track.length; i++) {
                    var event = track[i];
                    if (event.start % 0.25) {
                      // This is the off beat
                      event.start += swing;
                    } else {
                      // This is the beat
                      event.end += swing;
                    }
                  }
                } 
              } 
            }).then(function (response) {
              console.log("Audio successfully loaded."); 
               
              app.playMusicSheet[0].setTune(
                app.musicSheet[0], 
                true, { 
                  midiTranspose: transpose
              }).then(function(){
                console.log('Audio successfully loaded.');
              }).catch(function(error) {
                console.warn('Audio problem: ', error);
              }); 


            }).catch(function (error) {
              console.warn("Audio problem:", error);
            });
          }).catch(function (reason) {
            console.log(reason);
          }); 

        },
        resize: function(){  
          $('#inputText').innerHeight($(window).innerHeight()/2);   
          $('#menuScreen').innerHeight($(document).innerHeight()); 
        },
        openCloseMenu: function(){
          if($('#menuScreen').hasClass('open')){ 
            $('#menuScreen').removeClass('open'); 
          }else{
            $('#menuScreen').addClass('open'); 
          } 
          $(window).trigger('resize');  
        }, 
        initKeyEvent: function(){ 
          //var self = this;            
          $(window).off( 'keydown');
          $(window).on( 'keydown', function(e){  
            var data=e.originalEvent.code;
            if(data==='Enter'){
              $('.abcjs-midi-start').trigger('click');
              $(window).scrollTop(0);
            } 
            if(data==='Escape'){
              if($('.abcjs-midi-start').hasClass('abcjs-pushed')){
                $('.abcjs-midi-start').trigger('click');  
              }
              $('.abcjs-midi-reset').trigger('click');  
              $('.abcjs-note').removeClass('currentNote');
              $('.abcjs-rest').removeClass('currentNote'); 
              $('.abcjs-time-signature').removeClass('currentNote'); 
              $(window).scrollTop(0);
            }
            //console.log(data);
          });
        },     
        init: function(){
          console.log('app exe start');
          var self = this; 

          self.loadOn();            
          self.songs=window.songs;
          
          self.synth = new Tone.Synth().toMaster(); 

          $('#btnPrint').on('click',function(){ 
            window.print(); 
            self.openCloseMenu();
          });

          var counterFile = 0;
          $('#btnDownload').on('click',function(){ 
            var text = $('#inputText').val();;
            var filename = 'song'+counterFile+'.abc';
            counterFile++;
            var element = document.createElement('a');
            element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
            element.setAttribute('download', filename);
            element.style.display = 'none';
            document.body.appendChild(element);
            element.click();
            document.body.removeChild(element);
            self.openCloseMenu();
          });

          $('#btnMenu').on('click',function(){ 
            self.openCloseMenu();
          });

          $('#btnMenuClose').on('click',function(){ 
            self.openCloseMenu();
          });

          $('#inputText').val(' ');
          $('#inputText').on('change',function(){  
            var musicSheet = $('#inputText').val();
            if(musicSheet!==' '){
              self.createMusicSheet(musicSheet,0);
              self.resetPlayer(0); 
            }   
          }); 

          $('#file').on('change',function(){ 
            if (this.files && this.files[0]) {
              //console.log(this.files);
              var myFile = this.files[0];
              var reader = new FileReader();              
              reader.addEventListener('load', function (e) {
                var fileName = myFile.name;
                var extension = fileName.substring(fileName.lastIndexOf('.') + 1);
                if(extension==='abc'){ 
                  $('#inputText').val(e.target.result);
                }else{
                  $('#inputText').val(' ');
                  $('#main').html('Error! Not .abc file'); 
                }
                self.openCloseMenu();
              });              
              reader.readAsBinaryString(myFile); 
              self.openCloseMenu();
            }   
          }); 

          $('#btnSong').on('click',function(){ 
            var i = parseInt($('#selectSong').val()); 
            $('#inputText').val(self.songs[i]);
            $('#selectTransporSheet').val(0);          
            $('#selectTransporPitch').val(0);
            self.openCloseMenu();
          });

          self.swingMode = false;
          $('#btnSwing').on('click',function(){ 
            self.swingMode=!self.swingMode; 
            self.resetPlayer(0);   
          });

          var self = this;
          $('#selectSong').html(' ');
          for(var i in self.songs){
            var name = self.songs[i].substring(self.songs[i].indexOf("T:"),self.songs[i].length);
            name = name.substring(2,name.indexOf("\n")); 
            $('#selectSong').append('<option value='+i+'>'+name+'</option>');
          } 
          $('#inputText').val(self.songs[0]);


          $('#selectTransporSheet').html(' ');
          var ar = [12,11,10,9,8,7,6,5,4,3,2,1,0,-1,-2,-3,-4,-5,-6,-7,-8,-9,-10,-11,-12];
          for(var i in ar){ 
            var desc = (ar[i]>0?'+'+ar[i]:ar[i]);
            $('#selectTransporSheet').append('<option value='+ar[i]+'>'+desc+'</option>');
            $('#selectTransporPitch').append('<option value='+ar[i]+'>Pitch '+desc+'</option>');
          }       
          //$('#selectTransporPitch').html(' ');  
          ///$('#selectTransporPitch').append('<option value=0>Pitch 0</option>');  
          $('#selectTransporSheet').val(0);          
          $('#selectTransporPitch').val(0);

          $('#selectTransporSheet').on('change',function(){ 
            self.loadOn();  
            var tSheet = $(this).val();
            var tPitch = $('#selectTransporPitch').val();
            var musicSheet = $('#inputText').val();
            self.createMusicSheet(musicSheet,tSheet);  
            self.resetPlayer(tPitch); 
            self.loadOff(); 
          });

          $('#selectTransporPitch').on('change',function(){ 
            self.loadOn();  
            var tSheet = $('#selectTransporSheet').val();
            var tPitch = $(this).val();
            var musicSheet = $('#inputText').val();
            self.createMusicSheet(musicSheet,tSheet); 
            self.resetPlayer(tPitch); 
            self.loadOff(); 
          });

          var musicSheet = $('#inputText').val();
          self.createMusicSheet(musicSheet,0,0);
          self.resetPlayer(0); 
          self.initKeyEvent();

          self.resize(); 
          $(window).on('resize',self.resize);   

          var valSheet = $('#inputText').val();
          self.inter = setInterval(function(){ 
            if(valSheet!==$('#inputText').val()){ 
              $('#inputText').trigger('change');
              self.resize();
            }
            valSheet=$('#inputText').val();
          },1000);   
 
          self.loadOff();
          console.log('app exe end');
        }     
      };  
      app.init();   
    </script> 
  </body>
</html>
