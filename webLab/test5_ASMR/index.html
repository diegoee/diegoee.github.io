<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Web test">  
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, minimal-ui">  
    <title>Web Test5_ASMR</title>
    <style>  
      html,body{  
        -webkit-user-select: none;  
        -khtml-user-select: none;  
          -moz-user-select: none;  
            -ms-user-select: none;  
                user-select: none; 
        -webkit-tap-highlight-color: transparent; 
        overflow-y: hidden;  
        overflow-x: hidden; 
      }

      #version{
        position: absolute;
        margin: 0;
        padding: 0;
        top: 0;
        right: 5px;
        font-size: 0.75em;
      } 
      
      #visual{
        position: absolute;
        margin: 0;
        padding: 0;
        top: 0;
        right: 0;
        width: 100%;
        height: 100%;  
      }

      #loading{
        background-color: rgb(255,255,255,0.85);
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 1000;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      
      .spinner {
        width: 40px;
        height: 40px; 
        position: relative;
        margin: 100px auto;
      }

      .double-bounce1, .double-bounce2 {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        background-color: #333;
        opacity: 0.6;
        position: absolute;
        top: 0;
        left: 0;        
        -webkit-animation: sk-bounce 2.0s infinite ease-in-out;
        animation: sk-bounce 2.0s infinite ease-in-out;
      }

      .double-bounce2 {
        -webkit-animation-delay: -1.0s;
        animation-delay: -1.0s;
      }

      @-webkit-keyframes sk-bounce {
        0%, 100% { -webkit-transform: scale(0.0) }
        50% { -webkit-transform: scale(1.0) }
      }

      @keyframes sk-bounce {
        0%, 100% { 
          transform: scale(0.0);
          -webkit-transform: scale(0.0);
        } 50% { 
          transform: scale(1.0);
          -webkit-transform: scale(1.0);
        }
      } 
    </style>
  </head>
  <body>
    <div id="version"></div>   
    <div id="visual"></div>  
    <script type="text/javascript" src="https://code.jquery.com/jquery-3.2.1.min.js"></script>      
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/tone/13.0.1/Tone.min.js"></script>
    <script type="text/javascript" src="https://threejs.org/build/three.js"></script>        
    <script type="text/javascript">
    /*global $, window, setTimeout, clearTimeout, Promise, Tone*/ 
    (function exe(){ 
      //versi√≥n
      $('#version').html('v3.0.0');
      //visual App
      var app = {
        loaderE: '<div id="loading"><div class="spinner"><div class="double-bounce1"></div><div class="double-bounce2"></div></div></div>',
        inter: undefined,
        synth: undefined, 
        play: false,
        reset: function(){ 
          $('#visual').html(' ');
          this.createAnimation();
        },
        resize: function(){   
          app.reset(); 
        }, 
        loaderOn: function(){
          $('body').append(this.loaderE);
        },
        loaderOff: function(){
          $('#loading').remove();
        },
        getRndN: function (nstart,nEnd){
          return Math.round(Math.random()*nEnd)+nstart;
        }, 
        getMaxArry: function (a){
          var l = a.length;
          var max = a[0];
          for(var i=1; i<l; i++){
            max=Math.max(max,a[i]);
          }
          return max;
        },
        createAnimation: function(){
          console.log('createAnimation ini');
          var self = this;  
          var data = {
            beats: [],
            div: 1,
            bpm: 90,
            beatPulses: 4
          } 
          var l = self.getRndN(2,12);
          for(var i=0; i<l; i++){
            data.beats.push(self.getRndN(0,2)); 
          }  
          var w = $('#visual').innerWidth();
          var h = $('#visual').innerHeight();
  
          var scene = new THREE.Scene();
          scene.background = new THREE.Color( 0xEEEEEE );
          var frustumSize = 100;
          var aspect = w / h;
          //var camera = new THREE.PerspectiveCamera( 100, w/h, 1, 1000 );   
          var camera = new THREE.OrthographicCamera( frustumSize * aspect / - 2, frustumSize * aspect / 2, frustumSize / 2, frustumSize / - 2, 1, 1000 ); 
          camera.position.z = 45;
          camera.aspect=aspect;
          camera.updateProjectionMatrix();
           
          var s = (2/3)*camera.position.z; 
          var zRef = 1; 
          var renderer = new THREE.WebGLRenderer();
          renderer.setSize( w, h);
          $('#visual').append( renderer.domElement );           
           
          var group1 = new THREE.Group();
          var group2 = new THREE.Group(); 
          var geometry, material, mesh;
          var points = []; 
 
          material = new THREE.LineBasicMaterial( { color: 0x333333 } ); 
          points = []; 
          points.push( new THREE.Vector3(  0,  +(1+(+01/20))*s,  zRef));
          points.push( new THREE.Vector3(  0,  -(1+(-15/20))*s,  zRef));
          geometry = new THREE.BufferGeometry().setFromPoints( points );                    
          mesh = new THREE.Line( geometry, material );  
          group1.add( mesh ); 
    
          geometry = new THREE.CylinderGeometry( (1/20)*s, (1/20)*s, zRef, 120); 
          mesh = new THREE.Mesh( geometry, material ); 
          mesh.rotation.x=Math.PI/2;  
          mesh.position.z=zRef;    
          mesh.position.x=0; 
          mesh.position.y=s;  
          group1.add( mesh );

          geometry = new THREE.CylinderGeometry( (1/20)*s, (1/20)*s, zRef, 120); 
          mesh = new THREE.Mesh( geometry, material ); 
          mesh.rotation.x=Math.PI/2;  
          mesh.position.z=zRef;    
          mesh.position.x=0; 
          mesh.position.y=0;  
          group1.add( mesh );
           
          material = new THREE.MeshBasicMaterial( { color: 0xFFFFFF} );   
          geometry = new THREE.CylinderGeometry( 0.99*s, 0.99*s, zRef, 120); 
          mesh = new THREE.Mesh( geometry, material ); 
          mesh.position.z=-zRef/2;    
          mesh.rotation.x=Math.PI/2;  
          group1.add( mesh );

          var l = data.beats.length;
          var max = self.getMaxArry(data.beats);
          for(var i=0; i<l; i++){
            var h = 0.75*data.beats[i]*s/max;
            var rot = i*2*Math.PI/l;
            if(h!==0){
              var group = new THREE.Group();
              material = new THREE.LineBasicMaterial( { color: 0x000000 } ); 
              points = []; 
              points.push( new THREE.Vector3(  0,  0,  zRef));
              points.push( new THREE.Vector3(  0,  0.95*s,  zRef));
              geometry = new THREE.BufferGeometry().setFromPoints( points );                    
              mesh = new THREE.Line( geometry, material );  
              group.add( mesh ); 
              material = new THREE.LineBasicMaterial( { color: 0x000000 } ); 
              geometry = new THREE.CylinderGeometry( (1/20)*s, (1/20)*s, zRef, 120); 
              mesh = new THREE.Mesh( geometry, material ); 
              mesh.rotation.x=Math.PI/2;  
              mesh.position.z=zRef;    
              mesh.position.x=0; 
              mesh.position.y=h;  
              group.add( mesh ); 
              group.rotation.z=rot;
              group2.add( group );
            }
          }

          scene.add( group1 );
          scene.add( group2 );   

          self.synth = new Tone.Synth().toMaster(); 
          
          var clock = new THREE.Clock();
          var d = data.div*data.bpm/60; 
          var p = data.beatPulses; 
          //console.log(d);
          //console.log(data.beats);

          //var pointer = new THREE.Vector2();
          //var raycaster = new THREE.Raycaster(); 

          self.play = false; 
          $('#visual').off('click');
          $('#visual').on('click',function(event){   
            self.play=!self.play; 
            if(self.play){
              self.synth.triggerAttackRelease('A4','16n');  
            }else{
              self.synth.triggerAttackRelease('E4','16n');  
            }
          });  
          
          function render(){  
            requestAnimationFrame(render); 
            var delta = clock.getDelta();
            if(self.play){  
              group2.rotation.z-= (1/p)*d*delta*2*Math.PI;   
              group1.rotation.z+= 0.002*Math.PI; 
              group1.rotation.y+= 0.001*Math.PI; 
              group1.rotation.x-= 0.001*Math.PI; 
              group2.rotation.z+= 0.002*Math.PI; 
              group2.rotation.y+= 0.001*Math.PI; 
              group2.rotation.x-= 0.001*Math.PI;  
            }else{  
              //group1.rotation.z = 0; 
              //group1.rotation.y = 0; 
              //group1.rotation.x = 0; 
              //group2.rotation.z = 0; 
              //group2.rotation.y = 0; 
              //group2.rotation.x = 0;  
              clearInterval(self.inter);
            }
            renderer.render(scene,camera);   
          };     
          render(); 
          console.log('createAnimation end');
        },
        init: function(){
          console.log('exe init');
          this.loaderOn();
          $(window).on('resize', this.resize);
          this.reset();  
          this.loaderOff();  
          console.log('exe end'); 
        } 
      } 
      app.init();
    })();
    </script> 
  </body>
</html>
