<!DOCTYPE html>
<html lang="en">
  <head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="description" content="Web test">  
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, minimal-ui">
	<title>Web Test3_gameOfLife</title>
	<style> 
    html,body{ 
			background-color: #333;
    } 
		canvas{
      position: absolute;
      top: 0;
      left: 0; 
			width: 100%;
			height: 100%;
		}
    #loading{
      position: absolute;
      top: 0;
      left: 0; 
			width: 100%;
			height: 100%;
			background-color: rgba(33, 33, 33, 0.85);
      z-index: 1; 
      font-size: 3em; 
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.5s ease-out;
      animation-name: ani;
      animation-duration: 4s;
      animation-iteration-count: infinite; 
		}
    .spinner {
      width: 140px;
      height: 140px;
      margin: 100px auto;
      background-color: #DDD; 
      border-radius: 100%;  
      -webkit-animation: sk-scaleout 1.0s infinite ease-in-out;
      animation: sk-scaleout 1.0s infinite ease-in-out;
    } 
    @-webkit-keyframes sk-scaleout {
      0% { -webkit-transform: scale(0) }
      100% {
        -webkit-transform: scale(1.0);
        opacity: 0;
      }
    } 
    @keyframes sk-scaleout {
      0% { 
        -webkit-transform: scale(0);
        transform: scale(0);
      } 100% {
        -webkit-transform: scale(1.0);
        transform: scale(1.0);
        opacity: 0;
      }
    }
    #display{
      padding: 5px;
      margin: 2px;
      position: absolute;
      top: 0;
      right: 0; 
			background-color: #DDD;
      color: #333;
      z-index: 1; 
      font-size: 1.5em;  
      border-radius: 5px;
      opacity: 1;
      transition: 0.25s;
		}
    #display:hover{  
      opacity: 0.25;
		}
    #load{
      display: none;
      padding: 5px;
      margin: 2px;
      position: absolute;
      bottom: 0;
      right: 0; 
			background-color: #DDD;
      color: #333;
      z-index: 1; 
      font-size: 2em;  
      border-radius: 5px;
      opacity: 1;
      transition: 0.25s;
      cursor: pointer;
		}  
	</style>
  </head>
  <body>    
  <div id="display"></div>
	<!--<canvas id="canvas"></canvas>-->  
	<button id="load"> reload</button>
	<script type="text/javascript" src="https://code.jquery.com/jquery-3.2.1.min.js"></script> 
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/stats.js/16/Stats.min.js"></script>  
  <script type="text/javascript" src="https://threejs.org/build/three.js"></script>     
	<script type="text/javascript">   
    var stats = new Stats();
    stats.showPanel(0); // 0: fps, 1: ms, 2: mb, 3+: custom
    document.body.appendChild( stats.dom );

	  var app = {
      loadE: '<div id="loading"><div class="spinner"></div></div>', 
      loadOn: function(){
        app.loadOff();
        $('body').append(app.loadE);
      },
      loadOff: function(){   
        $('#loading').remove(); 
      },
      getRndN: function (nstart,nEnd){
        return Math.round(Math.random()*nEnd)+nstart;
      },
      deadColor:  '#333333',
      aliveColor: '#DDDDDD', 
      lineColor:  '#444444', 
      updateDisplay: function(html){
        $('#display').html(html);
      }, 
      nIter: 0,
      exe: function(){
        console.log('app exe ini');
        app.loadOn();  

        var w = window.innerWidth;
        var h = window.innerHeight;
 
        var scene = new THREE.Scene();
        //var camera = new THREE.PerspectiveCamera( 100, w/h, 1, 1000 );  
			  var frustumSize = 100;
				var aspect = w / h;
				var camera = new THREE.OrthographicCamera( frustumSize * aspect / - 2, frustumSize * aspect / 2, frustumSize / 2, frustumSize / - 2, 1, 1000 ); 
        camera.position.z = 2;
        
        var dx = Math.round((1/2)*w/9.5);
        var dy = Math.round((1/2)*h/9.5);
        var s = 1; 

        var renderer = new THREE.WebGLRenderer();
        renderer.setSize( window.innerWidth, window.innerHeight );
        document.body.appendChild( renderer.domElement );  
         
        var matrix = [];
        for(var i=0; i<2*dx; i++) {
          matrix[i] = new Array(2*dy);
        }
 
        for(var x=0; x<2*dx; x++){ 
          for(var y=0; y<2*dy; y++){  

            //cube
            group = new THREE.Group();
            geometry = new THREE.BoxGeometry( s, s, 0.1);
            material = new THREE.MeshBasicMaterial( { color: app.aliveColor} ); 
            mesh = new THREE.Mesh( geometry, material );  
            group.add( mesh ); 

            //line black
            material = new THREE.LineBasicMaterial( { color: app.lineColor } );
            var points = [];         
            //1 side
            
            points.push( new THREE.Vector3(  -0.5*s,  -0.5*s,  0.051)); //x, y, z
            points.push( new THREE.Vector3(  -0.5*s,   0.5*s,  0.051)); 
            points.push( new THREE.Vector3(   0.5*s,   0.5*s,  0.051)); 
            points.push( new THREE.Vector3(   0.5*s,  -0.5*s,  0.051));
            points.push( new THREE.Vector3(  -0.5*s,  -0.5*s,  0.051));
            geometry = new THREE.BufferGeometry().setFromPoints( points );
            mesh = new THREE.Line( geometry, material );   
            group.add( mesh );   
 
            group.alive=false;  
            group.position.x = s*(x-dx);
            group.position.y = s*(y-dy);
            matrix[x][y] = group; 
            scene.add( group );  
             
            //ON CLCIK!!!
            //this.alive=!this.alive; 
          } 
        }

        function rndAlive(){
          var n = 1.25;
          var len = matrix.length;  
          for(var x=0; x<matrix.length; x++){ 
            for(var y=0; y<matrix[0].length; y++){  
              matrix[x][y].alive=(app.getRndN(0,n)===0);
              if(matrix[x][y].alive){  
                matrix[x][y].children[0].material.color=new THREE.Color(app.aliveColor);
              }else{ 
                matrix[x][y].children[0].material.color=new THREE.Color(app.deadColor);
              }
            }
          }           
          app.nIter=0;
        }   

        function countPob(){
          var pob=0; 
          for(var x=0; x<matrix.length; x++){ 
            for(var y=0; y<matrix[0].length; y++){  
              if(matrix[x][y].alive){ 
                pob++;
              } 
            }
          } 
          return pob; 
        }

        function deadOrAlive(){   
          var mtx = [];
          var lenx = 2*dx;
          var leny = 2*dy; 
          for(var i=0; i<lenx; i++) {
            mtx[i] = new Array(leny);
          }

          function countAlive(x,y){
            var neighbor=[-1,0,1]; 
            var c = 0;
            for(var i=0; i<neighbor.length; i++){
              for(var ii=0; ii<neighbor.length; ii++){
                if(!(neighbor[i]===0&&neighbor[ii]===0)){ 
                  var xx=(x+neighbor[i]<0?lenx-1:x+neighbor[i]);
                  xx=(xx>lenx-1?0:xx);
                  var yy=(y+neighbor[ii]<0?leny-1:y+neighbor[ii]);
                  yy=(yy>leny-1?0:yy); 
                  if(matrix[xx][yy].alive){ 
                    c++;
                  }
                }
              }
            }       
            return c;
          }

          //https://es.wikipedia.org/wiki/Juego_de_la_vida    
          for(var x=0; x<matrix.length; x++){ 
            for(var y=0; y<matrix[0].length; y++){  
              mtx[x][y]=false;
              var c = 0;
              //Una célula viva con 2 o 3 células vecinas vivas sigue viva, en otro caso muere (por "soledad" o "superpoblación").
              if(matrix[x][y].alive){  
                c = countAlive(x,y);  
                if(c===2||c===3){
                  mtx[x][y]=true;
                }  
              //Una célula muerta con exactamente 3 células vecinas vivas "nace" (es decir, al turno siguiente estará viva).
              }else{  
                c = countAlive(x,y);   
                if(c===3){
                  mtx[x][y]=true;
                }  
              }
            }
          }
    
            //Regla inventada: viva expontanea. probabilidad de 1/n
          var n = 75000;
          for(var x=0; x<matrix.length; x++){ 
            for(var y=0; y<matrix[0].length; y++){
              matrix[x][y].alive=mtx[x][y];
              if(!matrix[x][y].alive){
                matrix[x][y].alive=(app.getRndN(0,n)===0);
              }
              if(matrix[x][y].alive){  
                matrix[x][y].children[0].material.color=new THREE.Color(app.aliveColor);
              }else{ 
                matrix[x][y].children[0].material.color=new THREE.Color(app.deadColor);
              }
            }
          }
        }

        var pointer = new THREE.Vector2();
				var raycaster = new THREE.Raycaster(); 

        var on = false;  
        $('canvas').on('click',function(event){  
          if(!on){
            on=true; 
          }else{ 
            pointer.x =   ( event.clientX / w ) * 2 - 1;
            pointer.y = - ( event.clientY / h ) * 2 + 1;
            raycaster.setFromCamera( pointer, camera ); 
            var intersects = raycaster.intersectObjects(scene.children);   
            if(intersects.length>0){ 
              intersects[0].object.parent.alive=!intersects[0].object.parent.alive;
              if(intersects[0].object.parent.alive){  
                intersects[0].object.parent.children[0].material.color=new THREE.Color(app.aliveColor);
              }else{ 
                intersects[0].object.parent.children[0].material.color=new THREE.Color(app.deadColor);
              } 
            }
          }
        });


        $(window).off('resize');
        $(window).on('resize',function(){  
          $('#load').css({
            display: 'flex'
          });
        });  

        $('#load').off('click');
        $('#load').on('click',function(){  
          app.loadOn();
          window.location.reload();   
        });    
         
        function render() { 
          var pob = countPob(); 
          deadOrAlive();  
          app.nIter++;    
          app.updateDisplay('<div>N iter.: '+app.nIter+' - Pob: '+pob+'</div>');  
          renderer.render( scene, camera );   
        }; 
   
        function animate() {
          requestAnimationFrame( animate );
          if(on){ 
            render(); 
          } 
          stats.update();
        }; 

        rndAlive();
        render();
        animate(); 
 
        app.loadOff();
        console.log('app exe end'); 
      }
	  }
    app.exe();
	</script>
	<noscript>JAVASCRIPT NOT WORKING!</noscript>
  </body>
</html>
