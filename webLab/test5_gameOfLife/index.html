<!DOCTYPE html>
<html lang="en">
  <head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="description" content="Web test">  
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, minimal-ui">
	<title>Web Test5_gameOfLife</title>
	<style> 
    html,body{ 
			background-color: #333;
    } 
		#canvas{
      position: absolute;
      top: 0;
      left: 0;
			margin: 1em;
			width: calc(100% - 2em);
			height: calc(100% - 2em);
			background-color: #000;
		}
    #loading{
      position: absolute;
      top: 0;
      left: 0; 
			width: 100%;
			height: 100%;
			background-color: rgba(33, 33, 33, 0.85);
      z-index: 1; 
      font-size: 3em; 
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.5s ease-out;
      animation-name: ani;
      animation-duration: 4s;
      animation-iteration-count: infinite; 
		}
    .spinner {
      width: 140px;
      height: 140px;
      margin: 100px auto;
      background-color: #DDD; 
      border-radius: 100%;  
      -webkit-animation: sk-scaleout 1.0s infinite ease-in-out;
      animation: sk-scaleout 1.0s infinite ease-in-out;
    } 
    @-webkit-keyframes sk-scaleout {
      0% { -webkit-transform: scale(0) }
      100% {
        -webkit-transform: scale(1.0);
        opacity: 0;
      }
    } 
    @keyframes sk-scaleout {
      0% { 
        -webkit-transform: scale(0);
        transform: scale(0);
      } 100% {
        -webkit-transform: scale(1.0);
        transform: scale(1.0);
        opacity: 0;
      }
    }
    #display{
      padding: 5px;
      margin: 2px;
      position: absolute;
      top: 0;
      right: 0; 
			background-color: #DDD;
      color: #333;
      z-index: 1; 
      font-size: 1.5em;  
      border-radius: 5px;
      opacity: 1;
      transition: 0.25s;
		}
    #display:hover{  
      opacity: 0.25;
		}
    #load{
      display: none;
      padding: 5px;
      margin: 2px;
      position: absolute;
      bottom: 0;
      right: 0; 
			background-color: #DDD;
      color: #333;
      z-index: 1; 
      font-size: 2em;  
      border-radius: 5px;
      opacity: 1;
      transition: 0.25s;
		}  
	</style>
  </head>
  <body>    
  <div id="display"></div>
	<div id="canvas"></div>  
	<button id="load"> relaod</button>
	<script type="text/javascript" src="https://code.jquery.com/jquery-3.2.1.min.js"></script> 
  <script type="text/javascript" src="https://threejs.org/build/three.js"></script> 
	<script type="text/javascript"> 
	  var app = {
      loadE: '<div id="loading"><div class="spinner"></div></div>', 
      loadOn: function(){
        app.loadOff();
        $('body').append(app.loadE);
      },
      loadOff: function(){   
        $('#loading').remove(); 
      },
      getRndN: function (nstart,nEnd){
        return Math.round(Math.random()*nEnd)+nstart;
      },
      deadColor: '#000',
      rndColor: function(){
        var color='#';
        var values = ['0','1','2','3','4','5','6','7','8','9','A','B','C','D','E','F'];
        for(var i=0; i<6; i++){ 
          color=color+values[this.getRndN(0,values.length-1)];
        } 
        return color;
      },   
      updateDisplay: function(pob,n){
        $('#display').html('<div>Pob: '+pob+'</div><div>N iter.: '+n+'</div>');
      }, 
      nIter: 0,
      exe: function(){  
        console.log('app exe ini');
        app.loadOn();
        $e=$('#canvas');
        $e.html(' '); 
         
        var scene = new THREE.Scene();
        var camera = new THREE.PerspectiveCamera( 40, $e.innerWidth()/$e.innerHeight(), 1, 1000); 
        var renderer = new THREE.WebGLRenderer();
        renderer.setSize($e.innerWidth(),$e.innerHeight());
        renderer.setClearColor( '#111111', 1);
         
        $e.html(renderer.domElement);

        function createBox(pos){ 
          var geometry = new THREE.PlaneGeometry( 1, 1);
          var material = new THREE.MeshBasicMaterial({ 
            color: app.rndColor(), 
            side: THREE.DoubleSide
          }); 
          var mesh = new THREE.Mesh( geometry, material ); 
          mesh.position.x = pos.x;
          mesh.position.y = pos.y;
          mesh.position.z = 0; 
          return mesh;  
        }
        var radioWH = 75;
        //radioWH = 3;
        var l = 2*radioWH-1;

        var matrix = [];
        for(var i=0; i<l; i++) {
          matrix[i] = new Array(l);
        } 
        var group = new THREE.Group();
        for(var x=-radioWH+1; x<radioWH; x++){ 
          for(var y=-radioWH+1; y<radioWH; y++){ 
            var box = createBox({
              x: x,
              y: y
            });
            matrix[radioWH-1+x][radioWH-1+y]={
              alive: true,
              box: box
            } 
            group.add(box);
          } 
        }   

        scene.add(group); 
        camera.position.set( 0, 0, l+l/10); 
        renderer.render( scene, camera );  
 
        function rndAlive(){
          var n = 2;
          var len = matrix.length;  
          for(var x=0; x<len; x++){
            for(var y=0; y<len; y++){ 
              matrix[x][y].alive=(app.getRndN(0,n)===0);
            }
          }           
          app.nIter=0;
        } 

        function changeColorBoxMatrix(){
          var len = matrix.length;  
          for(var x=0; x<len; x++){
            for(var y=0; y<len; y++){ 
              if(matrix[x][y].alive){
                matrix[x][y].box.material.color.set(app.rndColor());
              }else{ 
                matrix[x][y].box.material.color.set(app.deadColor);
              }
            }
          } 
          
          var pob=0;
          var len = matrix.length;  
          for(var x=0; x<len; x++){
            for(var y=0; y<len; y++){ 
              if(matrix[x][y].alive){ 
                pob++;
              } 
            }
          } 
          app.updateDisplay(pob,app.nIter); 
        }   

        function deadOrAlive(){
          var len = matrix.length;  
          var mtx = [];
          for(var i=0; i<len; i++) {
            mtx[i] = new Array(len);
          }
          function countAlive(x,y){
            var neighbor=[-1,0,1]; 
            var c = 0;
            for(var i=0; i<neighbor.length; i++){
              for(var ii=0; ii<neighbor.length; ii++){
                if(!(neighbor[i]===0&&neighbor[ii]===0)){ 
                  var xx=(x+neighbor[i]<0?len-1:x+neighbor[i]);
                  xx=(xx>len-1?0:xx);
                  var yy=(y+neighbor[ii]<0?len-1:y+neighbor[ii]);
                  yy=(yy>len-1?0:yy); 
                  if(matrix[xx][yy].alive){ 
                    c++;
                  }
                }
              }
            }       
            return c;
          }
          //https://es.wikipedia.org/wiki/Juego_de_la_vida    
          for(var x=0; x<len; x++){
            for(var y=0; y<len; y++){   
              mtx[x][y]=false;
              var c = 0;
              //Una célula viva con 2 o 3 células vecinas vivas sigue viva, en otro caso muere (por "soledad" o "superpoblación").
              if(matrix[x][y].alive){  
                c = countAlive(x,y);  
                if(c===2||c===3){
                  mtx[x][y]=true;
                }  
              //Una célula muerta con exactamente 3 células vecinas vivas "nace" (es decir, al turno siguiente estará viva).
              }else{  
                c = countAlive(x,y);   
                if(c===3){
                  mtx[x][y]=true;
                }  
              }
            }
          }  
          for(var x=0; x<len; x++){
            for(var y=0; y<len; y++){
              matrix[x][y].alive=mtx[x][y];
              //Regla inventada: viva expontanea. probabilidad de 1/n
              if(!matrix[x][y].alive){
                var n = 10000;
                matrix[x][y].alive=(app.getRndN(0,n)===0);
              }
            }
          }
        }

        app.nIter=0;
        var exe = false;
        function loopAnimate(){ 
          if(exe){
            renderer.render(scene, camera);
            deadOrAlive(); 
            changeColorBoxMatrix();
            app.nIter++;
            requestAnimationFrame(loopAnimate);
          }
        } 
         
        $e.on('click',function(){ 
          console.log('click run-> '+exe); 
          if(exe){
            exe=false; 
          }else{ 
            exe=true; 
            rndAlive(); 
            loopAnimate(); 
          }  
        });

        $(window).on('load',function(){ 
          setTimeout(function(){   
            app.loadOff();
          },3000); 
        });  
        
        $(window).on('resize',function(){  
          $('#load').css({
            display: 'flex'
          });
        }); 
        $('#load').on('click',function(){  
          exe = false;
          app.loadOn();
          window.location.reload();  
        });  

        console.log('app exe end');
      }
	  }
    app.exe();
	</script>
	<noscript>JAVASCRIPT NOT WORKING!</noscript>
  </body>
</html>
