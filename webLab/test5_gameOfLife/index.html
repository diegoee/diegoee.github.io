<!DOCTYPE html>
<html lang="en">
  <head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="description" content="Web test">  
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, minimal-ui">
	<title>Web Test5_gameOfLife</title>
	<style> 
    html,body{ 
			background-color: #333;
    } 
		#canvas{
      position: absolute;
      top: 0;
      left: 0; 
			width: 100%;
			height: 100%;
			background-color: #000;
		}
    #loading{
      position: absolute;
      top: 0;
      left: 0; 
			width: 100%;
			height: 100%;
			background-color: rgba(33, 33, 33, 0.85);
      z-index: 1; 
      font-size: 3em; 
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.5s ease-out;
      animation-name: ani;
      animation-duration: 4s;
      animation-iteration-count: infinite; 
		}
    .spinner {
      width: 140px;
      height: 140px;
      margin: 100px auto;
      background-color: #DDD; 
      border-radius: 100%;  
      -webkit-animation: sk-scaleout 1.0s infinite ease-in-out;
      animation: sk-scaleout 1.0s infinite ease-in-out;
    } 
    @-webkit-keyframes sk-scaleout {
      0% { -webkit-transform: scale(0) }
      100% {
        -webkit-transform: scale(1.0);
        opacity: 0;
      }
    } 
    @keyframes sk-scaleout {
      0% { 
        -webkit-transform: scale(0);
        transform: scale(0);
      } 100% {
        -webkit-transform: scale(1.0);
        transform: scale(1.0);
        opacity: 0;
      }
    }
    #display{
      padding: 5px;
      margin: 2px;
      position: absolute;
      top: 0;
      right: 0; 
			background-color: #DDD;
      color: #333;
      z-index: 1; 
      font-size: 1.5em;  
      border-radius: 5px;
      opacity: 1;
      transition: 0.25s;
		}
    #display:hover{  
      opacity: 0.25;
		}
    #load{
      display: none;
      padding: 5px;
      margin: 2px;
      position: absolute;
      bottom: 0;
      right: 0; 
			background-color: #DDD;
      color: #333;
      z-index: 1; 
      font-size: 2em;  
      border-radius: 5px;
      opacity: 1;
      transition: 0.25s;
      cursor: pointer;
		}  
	</style>
  </head>
  <body>    
  <div id="display"></div>
	<canvas id="canvas"></canvas>  
	<button id="load"> relaod</button>
	<script type="text/javascript" src="https://code.jquery.com/jquery-3.2.1.min.js"></script> 
  <script type="text/javascript" src="https://threejs.org/build/three.js"></script>  
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/paper.js/0.12.15/paper-full.js"></script>
	<script type="text/javascript">  
    paper.install(window);
	  var app = {
      loadE: '<div id="loading"><div class="spinner"></div></div>', 
      loadOn: function(){
        app.loadOff();
        $('body').append(app.loadE);
      },
      loadOff: function(){   
        $('#loading').remove(); 
      },
      getRndN: function (nstart,nEnd){
        return Math.round(Math.random()*nEnd)+nstart;
      },
      deadColor: '#333333',
      aliveColor: '#DDDDDD',
      rndColor: function(){
        var color='#';
        var values = ['0','1','2','3','4','5','6','7','8','9','A','B','C','D','E','F'];
        for(var i=0; i<6; i++){ 
          color=color+values[this.getRndN(0,values.length-1)];
        } 
        return color;
      },   
      updateDisplay: function(html){
        $('#display').html(html);
      }, 
      nIter: 0,
      exe: function(){
        console.log('app exe ini');
        app.loadOn(); 
        var w = $('#canvas').innerWidth();
        var h = $('#canvas').innerHeight();
  
        var canvas = document.getElementById('canvas');  
        paper.setup(canvas);  
        
        var s = 7;  

        var pos = [];
        var i = 0;
        for(var x=0; x<h; x=x+s){ 
          var a = []; 
          for(var y=0; y<w; y=y+s){  
            a.push([x,y]); 
          }
          pos.push(a);
        }    
        //console.log(pos.length+' - '+pos[0].length);
        
        var matrix = [];
        for(var i=0; i<pos.length; i++) {
          matrix[i] = new Array(pos[i].length);
        } 
        
        var group = new paper.Path();
        for(var x=0; x<matrix.length; x++){ 
          for(var y=0; y<matrix[0].length; y++){ 
            var cell = new paper.Path.Rectangle({
              point: [pos[x][y][1],  pos[x][y][0]],
              size:  [s, s],
              strokeColor: '#444444',
              fillColor: '#333333',
            });
            matrix[x][y]={
              alive: true,
              cell: cell
            } 
            group.add(cell);
          } 
        } 

        function rndAlive(){
          var n = 1.25;
          var len = matrix.length;  
          for(var x=0; x<matrix.length; x++){ 
            for(var y=0; y<matrix[0].length; y++){  
              matrix[x][y].alive=(app.getRndN(0,n)===0);
              if(matrix[x][y].alive){ 
                matrix[x][y].cell.fillColor=app.rndColor();
              }else{ 
                matrix[x][y].cell.fillColor='#333333';
              }
            }
          }           
          app.nIter=0;
        }  
        
        function color(){ 
          for(var x=0; x<matrix.length; x++){ 
            for(var y=0; y<matrix[0].length; y++){  
              if(matrix[x][y].alive){ 
                matrix[x][y].cell.fillColor=app.rndColor();
              } 
            }
          }  
        }

        function countPob(){
          var pob=0; 
          for(var x=0; x<matrix.length; x++){ 
            for(var y=0; y<matrix[0].length; y++){  
              if(matrix[x][y].alive){ 
                pob++;
              } 
            }
          } 
          return pob; 
        }

        function deadOrAlive(){   
          var mtx = [];
          var lenx = pos.length;
          var leny = pos[0].length; 
          for(var i=0; i<lenx; i++) {
            mtx[i] = new Array(leny);
          }

          function countAlive(x,y){
            var neighbor=[-1,0,1]; 
            var c = 0;
            for(var i=0; i<neighbor.length; i++){
              for(var ii=0; ii<neighbor.length; ii++){
                if(!(neighbor[i]===0&&neighbor[ii]===0)){ 
                  var xx=(x+neighbor[i]<0?lenx-1:x+neighbor[i]);
                  xx=(xx>lenx-1?0:xx);
                  var yy=(y+neighbor[ii]<0?leny-1:y+neighbor[ii]);
                  yy=(yy>leny-1?0:yy); 
                  if(matrix[xx][yy].alive){ 
                    c++;
                  }
                }
              }
            }       
            return c;
          }

          //https://es.wikipedia.org/wiki/Juego_de_la_vida    
          for(var x=0; x<matrix.length; x++){ 
            for(var y=0; y<matrix[0].length; y++){  
              mtx[x][y]=false;
              var c = 0;
              //Una célula viva con 2 o 3 células vecinas vivas sigue viva, en otro caso muere (por "soledad" o "superpoblación").
              if(matrix[x][y].alive){  
                c = countAlive(x,y);  
                if(c===2||c===3){
                  mtx[x][y]=true;
                }  
              //Una célula muerta con exactamente 3 células vecinas vivas "nace" (es decir, al turno siguiente estará viva).
              }else{  
                c = countAlive(x,y);   
                if(c===3){
                  mtx[x][y]=true;
                }  
              }
            }
          } 

          //Regla inventada: viva expontanea. probabilidad de 1/n
          var n = 75000;
          for(var x=0; x<matrix.length; x++){ 
            for(var y=0; y<matrix[0].length; y++){
              matrix[x][y].alive=mtx[x][y];
              if(!matrix[x][y].alive){
                matrix[x][y].alive=(app.getRndN(0,n)===0);
              }
              if(matrix[x][y].alive){ 
                matrix[x][y].cell.fillColor=app.aliveColor;
              }else{ 
                matrix[x][y].cell.fillColor=app.deadColor;
              }
            }
          }
        }

        //TODO: Frame
        var exe = true;
        rndAlive();
        view.onFrame = function(event){  
          var pob = countPob();
          if(exe){    
            deadOrAlive();  
            app.nIter++;    
            app.updateDisplay('<div>Time: '+Math.round(event.time)+' - Inc: '+Math.round(event.delta*100)/100+'</div><div>N iter.: '+app.nIter+' - Pob: '+pob+'</div>'); 
          }else{
            color();
            app.updateDisplay('<div>Time: '+Math.round(event.time)+' - Inc: '+Math.round(event.delta*100)/100+'</div><div>N iter.: '+app.nIter+' - Pob: '+pob+'</div>'); 
          } 
        }
        paper.view.draw(); 
 
        $('#canvas').on('click',function(){ 
          console.log('click run-> '+exe); 
          if(exe){
            exe=false; 
          }else{ 
            rndAlive();
            exe=true;    
          }  
        }); 

        $(window).off('resize');
        $(window).on('resize',function(){  
          $('#load').css({
            display: 'flex'
          });
        });  

        $('#load').off('click');
        $('#load').on('click',function(){ 
          exe = false;
          app.loadOn();
          window.location.reload();   
        });   
 
        app.loadOff();
        console.log('app exe end'); 
      }
	  }
    app.exe();
	</script>
	<noscript>JAVASCRIPT NOT WORKING!</noscript>
  </body>
</html>
