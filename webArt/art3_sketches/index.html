<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, minimal-ui"> 
    <title>Web Art3: Sketches</title> 
    <style>   
      html,body{ 
        padding: 0;
        margin: 0;  
        background-color: #333;  
        color: #DDD;
        -webkit-user-select: none;  
        -khtml-user-select: none;  
          -moz-user-select: none;  
            -ms-user-select: none;  
                user-select: none; 
        -webkit-tap-highlight-color: transparent; 
      }
      body{  
        display: flex;
        align-items: center;
        justify-content: center;
      }  
      #actionBtn{
        position: absolute;
        top: 0;
        right: 0;
        margin: 10px;
        font-size: 1.5em;
        cursor: pointer;
      }
    </style>   
  </head>
  <body>    
    <button id="actionBtn"> Next </button>
    <main></main>
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>     
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.5.0/p5.min.js"></script> 
    <script type="text/javascript"> 
      console.log('Exe start'); 
      sketchs = [];

      aux = { 
        getRandomN: function(min, max){
          return Math.round(Math.random() * (max - min) + min);
        },
        beens: [],
        idBeen: 0,
        dBeen: 30,
        vMove: 5,
        counterLimit: 1500,
        collisionCircle: function (circ1,circ2){   
          var dis = dist(circ1.x, circ1.y, circ2.x, circ2.y);
          if (dis < this.dBeen){
            return true;
          }else{
            return false;
          }
        },
        addBeens: function (x,y){  
          this.idBeen++;
          this.beens.push({  
            id: this.idBeen,
            state: 1, //0: bad, 1: good, 2: again
            x: x,
            y: y, 
            color: '#DDD',
            counter: 0, 
            counterLimit: this.getRandomN(this.counterLimit/2,this.counterLimit)
          });  
        }, 
        plot: function(){   
          noStroke();   
          for (var i=0; i<this.beens.length; i++){ 
            fill(this.beens[i].color);
            ellipse(this.beens[i].x, this.beens[i].y, this.dBeen, this.dBeen); 
          }    
        }, 
        animation: function(){  
          for (var i=0; i<this.beens.length; i++){  
            this.beens[i].x=this.beens[i].x+this.vMove*(Math.random()-0.5); 
            this.beens[i].y=this.beens[i].y+this.vMove*(Math.random()-0.5); 
            if (this.beens[i].x<0){
              this.beens[i].x=0;  
            }
            if (this.beens[i].x>width){
              this.beens[i].x=width;
            }
            if (this.beens[i].y<0){
              this.beens[i].y=0;  
            }
            if (this.beens[i].y>height){
              this.beens[i].y=height;
            }
          }
          
          for (var i=0; i<this.beens.length; i++){  
            for (var ii=0; ii<this.beens.length; ii++){
              if(this.beens[i].id!==this.beens[ii].id){
                if(this.collisionCircle(this.beens[i],this.beens[ii])){ 
                  if(this.beens[i].state===1&&this.beens[ii].state===0){ 
                    this.beens[i].state=0;
                  }
                  if(this.beens[i].state===0&&this.beens[ii].state===1){ 
                    this.beens[ii].state=0;
                  }
                }
              }
            }
          }

          for (var i=0; i<this.beens.length; i++){  
            if(this.beens[i].state===0){ 
              this.beens[i].color='#111'; 
              this.beens[i].counter++;
              if(this.beens[i].counter>this.beens[i].counterLimit){
                this.beens[i].counter=0;
                this.beens[i].state=2;
              }
            }
            if(this.beens[i].state===1){ 
              this.beens[i].color='#DDD'; 
            }
            if(this.beens[i].state===2){ 
              this.beens[i].color='#555'; 
              this.beens[i].counter++;
              if(this.beens[i].counter>this.beens[i].counterLimit){
                this.beens[i].counter=0;
                this.beens[i].state=1;
              }
            }
          }  
        },
        //exe in mouseClicked
        mouseClicked: function(mouseX,mouseY){   
          for (var i=0; i<this.beens.length; i++){  
            if(this.beens[i].state===1 && this.collisionCircle(this.beens[i],{
              x: mouseX,
              y: mouseY
            })){ 
              this.beens[i].state=0;
              this.beens[i].counter=0; 
            }
          }
        },  
        //exe in setup
        setup: function(){  
          //https://p5js.org/es/reference/ 
          for (var i=this.dBeen; i<width; i=i+2*this.dBeen){ 
            for (var ii=this.dBeen; ii<height; ii=ii+2*this.dBeen){ 
              this.addBeens(i,ii); 
            } 
          }     
          this.beens[Math.floor(this.beens.length*Math.random())].state=0;
        },
        //exe in draw
        draw: function(){ 
          background(color(51));    
          this.animation();   
          this.plot();  
        }
      };
      sketchs.push(aux);
 
      aux = {
        getRnd: function(min, max){
          return Math.round(Math.random() * (max - min) + min);
        },  
        ecgData: [          
          0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,           
          0.08, 0.18, 0.08, 0, 0, 0, 0, 0, 0, -0.04,           
          -0.08, 0.3, 0.7, 0.3, -0.17, 0.00, 0.04, 0.04, 
          0.05, 0.05, 0.06, 0.07, 0.08, 0.10, 0.11, 0.11,           
          0.10, 0.085, 0.06, 0.04, 0.03, 0.01, 0.01, 0.01,           
          0.01, 0.02, 0.03, 0.05, 0.05, 0.05, 0.03, 0.02, 0, 0, 0,
          0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,  
        ], 
        signal: { 
          r: 6,
          x:[], 
          y:[],
          c:[],
          p:[],
          n:[], 
          s:[],
        },
        plot: function (){    
          for (var i=0; i<this.signal.x.length-1; i++){ 
            fill('#DDD');  
            stroke(this.signal.c[i]);  
            line(this.signal.x[i], this.signal.y[i], this.signal.x[i+1], this.signal.y[i+1]); 
            if(this.signal.p[i]){
              ellipse(this.signal.x[i], this.signal.y[i], this.signal.r, this.signal.r);
            }
          }  
        }, 
        animation: function(){  
          this.signal.c.unshift(this.signal.c.pop());   
          this.signal.c.unshift(this.signal.c.pop());   
          this.signal.p.unshift(this.signal.p.pop());   
          this.signal.p.unshift(this.signal.p.pop());  
          for (var i=0; i<this.signal.s.length; i++){  
            this.signal.y[i]=this.signal.s[i]+this.signal.n[i];    
          }   
          this.signal.r--;
          if(this.signal.r<6){
            this.signal.r=6;
          }
        },
        //exe in mouseClicked 
        mouseClicked: function(mouseX,mouseY){  
          this.signal.r=55;
          if((mouseY<5*height/6)&&(mouseY>1*height/6)){
            for (var i=0; i<this.signal.s.length; i++){ 
              this.signal.n[i]=-3*height/4+mouseY; 
            }    
          }
        },  
        //exe in setup
        setup: function(){  
          //https://p5js.org/es/reference/  
          var aux = [];  
          for (var i=0; i<this.ecgData.length-1; i++){   
              aux.push(this.ecgData[i]);       
              aux.push((this.ecgData[i]+this.ecgData[i+1])/2); 
          } 
          aux = aux.map(function(e){
            return 3*height/4-height*0.85*e+5*Math.random(); 
          });   
          var opac = 0; 
          var count = 0; 
          for (var i=0; i<Math.floor(width/aux.length)*aux.length; i++){  
            this.signal.p.push(false);
            this.signal.x.push(i); 
            this.signal.s.push(aux[i % aux.length]); 
            this.signal.n.push(0);
            this.signal.y.push(0);
            if(opac>1){ 
              this.signal.c.push('rgba(221, 221, 221, 0)');
            }else{
              count++;
              opac=opac+0.0055;
              this.signal.c.push('rgba(221, 221, 221, '+opac+')');
            } 
          }   
          this.signal.p[count]=true;  
        },
        //exe in draw
        draw: function(){ 
          background(color(51));    
          this.animation();   
          this.plot();  
        }
      };
      sketchs.push(aux); 
      
      sketchs=[sketchs[1]];

      app = { 
        time: 0,
        interval: undefined,
        intervalTime: 0,
        intervalTimeLimit: 30,
        createInterval: function(){
          var self = this;
          if(this.interval!==undefined){
            clearInterval(this.interval);
          }
          self.intervalTime=0;
          this.interval = setInterval(function(){
            self.intervalTime++;
            if (self.intervalTime>self.intervalTimeLimit){ 
              self.addCount();
              self.intervalTime=0;
            }
          },1000);
        },
        counter: 0,
        addCount: function(){
          this.createInterval();
          this.counter++;
          if(this.counter>=this.sketchs.length){
            this.counter=0;
          }
        },
        getTimeInMinSec: function(sec){ 
          //sec = (2*24*60*60+4*60*60+3*60+2) // 2dias 4horas 3min 2sec
          var seg   = sec%60; 
          var min   = Math.floor(sec%(60*60)/60); 
          var hours = Math.floor(sec%(60*60*24)/60/60);
          var days  = Math.floor(sec/(60*60*24)); 
          res = days+'d '+hours+':'+(min<9?'0'+min:min)+':'+(seg<9?'0'+seg:seg); 
          if(days===0){ 
            res = hours+':'+(min<9?'0'+min:min)+':'+(seg<9?'0'+seg:seg); 
          }
          if(days===0&&hours===0){ 
            res = (min<9?'0'+min:min)+':'+(seg<9?'0'+seg:seg); 
          }
          if(days===0&&hours===0&&min===0){ 
            res = (seg<9?'0'+seg:seg)+'s'; 
          }
          return res;
        },
        init: function(){
          this.sketchs = Array.from(sketchs); 
          this.counter = Math.floor(Math.random()*this.sketchs.length); 
          $(window).on('resize',function(){
            location.reload();  
          });      
          var self = this;
          $('#actionBtn').on('click',function(){
            self.addCount();
          });  
          this.createInterval();
          setInterval(function(){
            self.time++;  
          },1000);
        }
      }
      app.init();     
      delete sketchs;   
      delete aux; 

      //https://p5js.org/es/examples/
      function setup(){ 
        createCanvas($(window).width()-6, $(window).height()-6);
        frameRate(60);
        for(var i=0; i<app.sketchs.length; i++){
          app.sketchs[i].setup();  
        } 
      }
 
      function draw(){  
        background(color(51)); 
        app.sketchs[app.counter].draw();  
        noStroke();       
        textAlign(LEFT);
        textSize(18);
        fill(0);
        text('Art '+(app.counter+1)+'/'+app.sketchs.length+': '+app.getTimeInMinSec(app.intervalTime)+' ('+app.getTimeInMinSec(app.intervalTimeLimit)+')', 10, 30);
        text('Time: '+app.getTimeInMinSec(app.time), 10, 50);
      } 

      function mouseClicked(){    
        app.sketchs[app.counter].mouseClicked(mouseX,mouseY);  
      }    
      console.log('Exe end'); 
    </script>
  </body>
</html>
