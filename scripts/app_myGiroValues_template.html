<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Giro Count</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
      .table{
        font-size: 0.85em; 
      } 
      .table>:not(caption)>*>*{
        padding: 0.2em; 
      }
      .tableSmall{
        font-size: 0.7em;
      }
    </style>
  </head>
  <body> 
    <div class="container"> 
      <div class="row">
        <div class="col mt-2 text-center">
          <button class="btn btn-light" type="button" data-bs-toggle="collapse" data-bs-target="#section01">
            Giro Count
          </button>
        </div> 
      </div>
      <div class="row collapse show" id="section01">
        <div class="col mt-5">
          <table class="table table-striped table-hover mt-3" id="countStateTable"></table>
        </div>
        <div class="col text-center"> 
          <div id="graph01"></div>
        </div> 
      </div>
      <div class="row">
        <div class="col mt-2 text-center">
          <button class="btn btn-light" type="button" data-bs-toggle="collapse" data-bs-target="#section02">
            Evolución valores B/P
          </button>
        </div> 
      </div>
      <div class="row collapse show" id="section02" >
        <div class="col"> 
          <div id="graph02"></div>
        </div> 
      </div>
      <div class="row">
        <div class="col mt-2 text-center">
          <button class="btn btn-light" type="button" data-bs-toggle="collapse" data-bs-target="#section03">
            Movimentos de cuenta
        </button>
        </div> 
      </div>
      <div class="row collapse show" id="section03">
        <div class="col-1"></div> 
        <div class="col-10">
          <table class="table table-striped table-hover tableSmall" id="movementsTable"></table>
        </div> 
        <div class="col-1"></div> 
      </div> 
      <div class="row">
        <div class="col mt-2 text-center">
          <button class="btn btn-light" type="button" data-bs-toggle="collapse" data-bs-target="#section04">
            Evolución de los valores adquiridos
        </button>
        </div> 
      </div>
      <div class="row collapse show" id="section04"> 
        <div id="graph03"></div> 
      </div>
    </div>
    <script src="https://code.jquery.com/jquery-3.7.1.js" ></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script> 
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script id="dataScript">      
    </script>
    <script>   
      console.log(data);
      var countState=data.countState;
      var movements =data.movements;
      var graph01   =data.graph01Data;
      var graph02   =data.graph02Data;
      var graph03   =data.graph03Data;
    
      try{
        keys = Object.keys(countState[0]);
        ele = '<thead class="text-center"><tr>';        
        keys.forEach(function(e){
          ele = ele+'<th>'+e+'</th>';
        });
        ele = ele+'</tr></thead>';
        $('#countStateTable').html(ele);
        ele = '<tbody>';        
        countState.forEach(function(e,i){ 
          ele = ele+'<tr>';   
          keys.forEach(function(k){
            if(k==='value'||k==='extra'){
              ele = ele+'<td class="text-end">'+e[k]+'</td>'; 
            }else{
              ele = ele+'<td>'+e[k]+'</td>'; 
            }
          }); 
          ele = ele+'</tr>';
        });
        ele = ele+'</tbody>';
        $('#countStateTable').append(ele);
        var cond = parseFloat(countState[0].value.replace('€','').trim())-parseFloat(countState[3].value.replace('€','').trim());  
        $($('#countStateTable tbody tr')[0]).addClass('fw-bold');
        $($('#countStateTable tbody tr')[3]).addClass('fw-bold');
        if(cond>0){
          $($($('#countStateTable tbody tr')[0]).find('td')[2]).addClass('text-success');
          $($($('#countStateTable tbody tr')[3]).find('td')[2]).addClass('text-success');
        }else{
          $($($('#countStateTable tbody tr')[0]).find('td')[2]).addClass('text-danger');
          $($($('#countStateTable tbody tr')[3]).find('td')[2]).addClass('text-danger');
        }
      }catch(e){
        $('#countStateTable').html(e);
      } 

      try{
        keys = Object.keys(movements[0]);
        ele = '<thead class="text-center"><tr>';        
        keys.forEach(function(e){
          ele = ele+'<th>'+e+'</th>';
        });
        ele = ele+'</tr></thead>';
        $('#movementsTable').html(ele);
        ele = '<tbody>';        
          movements.forEach(function(e){
          ele = ele+'<tr>'; 
          keys.forEach(function(k){
            if(k==='CastflowEUR'){
              ele = ele+'<td class="text-end">'+e[k]+'</td>'; 
            }else{
              ele = ele+'<td>'+e[k]+'</td>'; 
            }
          }); 
          ele = ele+'</tr>';
        });
        ele = ele+'</tbody>';
        $('#movementsTable').append(ele);  
      }catch(e){
        $('#movementsTable').html(e);
      } 
      
      try{  
        Highcharts.chart('graph01',{
          chart: {
            type: 'pie'
          },
          title: {
            text: ' '
          },
          credits: {
            enabled: false
          }, 
          legend: {
            align: 'center',
            verticalAlign: 'bottom',
            layout: 'vertical',
            x: 0,
            y: 0,
            enabled: true,
            itemWidth: 250,
            labelFormatter: function() {
              return '<b>'+this.name+'</b>: '+this.y+'€ ('+(Math.round(this.percentage*100)/100)+' %)';
            }
          },
          plotOptions: {
            pie: {
              allowPointSelect: false,
              cursor: 'pointer',
              dataLabels: {
                enabled: true,
                format: '{point.percentage:.1f} % <br>{point.y} €',
                distance: -10,
              },
              showInLegend: true
            }
          }, 
          tooltip: {
            pointFormat: '{series.name}: <b>{point.percentage:.1f}%</b> <br>{point.y} €'
          },
          series: [{ 
            name: 'Stocks',
            //animation: {
            //  duration: 0
            //},
            colorByPoint: true,
            data: graph01
          }]
        });  
      }catch(e){
        $('#graph01').html(e);
      }

      try{  
        var ele = (graph02.bpNumber>0?
          '<span class="text-success fw-bold">'+graph02.bp+'</span> - timing: '+graph02.timming:
          '<span class="text-danger fw-bold">'+graph02.bp+' </span> - timing: '+graph02.timming
        );
        ele = '<div class="text-end fs-5">'+ele+'</div>';
        $('#graph02').before(ele);
        graph02.series.forEach(function(e){
          e.lineWidth = 1.25;
          e.marker = {radius: 0};
          //e.animation = {
          //  duration: 0
          //}
        });
        graph02.series[0].lineWidth = 3,
        graph02.series[0].marker = {radius: 4}
        graph02.series[0].color='#3333FF';
        graph02.series[1].color='#009900';
        graph02.series[2].color='#000000';
        graph02.series[3].color='#FF0000';

        Highcharts.chart('graph02',{ 
          chart: {
            height: 500,
            type: 'spline',
            zoomType: 'xy',
          },
          title: {
            text: ' ' 
          }, 
          credits: {
            enabled: false
          }, 
          yAxis: {
            title: {
              text: 'EUR'
            },
            max: graph02.series[1].data[0], 
            min: graph02.series[3].data[0]
          }, 
          xAxis: {
            categories: graph02.categories
          }, 
          series: graph02.series
        });    
      }catch(e){
        $('#graph02').html(e);
      }

      try{   
        $('#graph03').html('--');
      }catch(e){
        $('#graph03').html(e);
      } 
    </script>
  </body>
</html>