<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Web test">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons" > 
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">  
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, minimal-ui">
    <title>Web Test3_concept2</title>
    <style> 
      #loading{
        background-color: rgb(255,255,255,0.85);
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 1000;
        display: flex;
        align-items: center;
        justify-content: center;
      }     
    </style>
  </head>
  <body> 
    <div id="loading"> 
      <div class="preloader-wrapper big active">
        <div class="spinner-layer spinner-blue-only">
          <div class="circle-clipper left">
            <div class="circle"></div>
          </div><div class="gap-patch">
            <div class="circle"></div>
          </div><div class="circle-clipper right">
            <div class="circle"></div>
          </div>
        </div>
      </div>
    </div>
    <div id="body"></div>  
    <script type="text/javascript" src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/3.6.2/fabric.min.js"></script>  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/13.0.1/Tone.min.js"></script>   
    <script type="text/javascript"> 
      (function exe(){  

        function toast(text,fn){
          M.Toast.dismissAll();
          var toastMsg = M.toast({
            html: '<span>'+text+'</span><button class="btnToast btn-flat toast-action">Close</button>', // btn-flat toast-action
            displayLength: 1500, 
            completeCallback: fn
          }); 
          $('.btnToast').on('click',function(){
            M.Toast.dismissAll();
          }); 
        } 

        function onOffLoading(state){ 
          if(state){
            $('#loading').css({
              display: 'flex'
            });
          }else{
            $('#loading').css({
              display: 'none'
            });
          } 
        }
        
        
        var synth = new Tone.Synth().toMaster(); 
        function plotCanvas(){ 
          onOffLoading(true);        
          var canvas = new fabric.Canvas('canvas',{ 
            selection: false,
            preserveObjectStacking: true,
            width: $(window).innerWidth()-40, 
            height: $(window).innerHeight()-46             
          });   
 

          var color = ['red','pink','purple', 'indigo', 'blue', 'cyan', 'teal', 'green', 'yellow', 'orange', 'brown', 'grey'];
          var opacityOctave = [0.85,0.65,0.45,0.25];
          var numberOctave = ['2','3','4','5'];
          var notes = ['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
          var spaceX = Math.floor(canvas.width/notes.length);
          var spaceY = Math.floor(canvas.height/opacityOctave.length);
          var allNotes = [];
          for(var i=0; i<notes.length; i++){
            for(var ii=0; ii<opacityOctave.length; ii++){
              allNotes.push({
                x: [i*spaceX,(i+1)*spaceX-1],
                y: [ii*spaceY,(ii+1)*spaceY-1],
                opacity: opacityOctave[ii],
                n: numberOctave[ii],
                color: color[i],
                note: notes[i],
              });
            } 
          }         

          canvas.on({ 
            'mouse:down': function(options) { 
              var pos = 0; 
              for(var i=0; i<allNotes.length; i++){  
                if(allNotes[i].x[0]<=options.e.offsetX&&allNotes[i].x[1]>options.e.offsetX &&allNotes[i].y[0]<=options.e.offsetY&&allNotes[i].y[1]>options.e.offsetY){
                  pos = i;
                  break;
                }
              }                
              synth.triggerAttackRelease(allNotes[pos].note+allNotes[pos].n, '8n'); 
              var circle = new fabric.Circle({ 
                radius: 1,  
                opacity: allNotes[pos].opacity,
                fill: allNotes[pos].color, 
                selectable: false,
                top: options.e.offsetY, 
                left: options.e.offsetX, 
                originX: 'center',
                originY: 'center' 
              });
              canvas.add(circle);
              canvas.renderAll(); 
              circle.animate({ 
                radius: 1000, 
                opacity: 0
              },{
                duration: 1000,
                onChange: canvas.renderAll.bind(canvas),
                onComplete: function(){ 
                  canvas.remove(circle);                    
                },
                easing: fabric.util.ease.easeInQuad
              });
            }
          });

          onOffLoading(false);
        }

        function resize(){  
          $('#body').html('<canvas id="canvas"></canvas>'); 
          $('#canvas').css({ 
            'margin': '20px',
            'border': 'solid 1px',
            'border-color': 'rgba(0, 0, 0, 0.25)' 
          });  
          toast('Welcome!',function(){
            plotCanvas();
          });
        }         
        resize();
        $(window).on('resize',resize);   
      })();
    </script>
    <noscript>JAVASCRIPT NOT WORKING!</noscript>
  </body>
</html>
