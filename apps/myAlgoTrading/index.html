<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="user-scalable=no, width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.13.0/css/all.min.css">
    <title>Plot</title>    
    <style>  
      #terminal{
        background-color: black;
        color: white;
        font: 0.75em sans-serif;
        overflow: auto;
      }
      #terminal p{
        margin: 0;
        padding: 0;
      } 
    </style>     
  </head>
  <body> 
    <div class="col">
      <div class="row">
        <div class="col-md-5">
          <div id="terminal"></div>
        </div>
        <div class="col-md-7" id="comboContainer">
          <div class="row">
            <div class="col-sm-4"> 
              <div class="input-group"> 
                <button id="btnDeleteTerminal" type="button" class="btn btn-danger btn-block"><i class="fas fa-trash-alt"></i> <i class="fas fa-terminal"></i></button>
              </div> 
              <div class="input-group">  
                <div class="input-group-prepend">
                 <div class="input-group-text"><i class="fas fa-comments-dollar"></i></div>
                </div>
                <select class="custom-select" id="selectTradeMark"> 
                  <option value="EUR/USD" selected>EUR/USD</option> 
                </select>
              </div>
              <div class="input-group">   
                <div class="input-group-prepend">
                  <div class="input-group-text"><i class="fas fa-chart-line"></i></div>
                </div>  
                <select class="custom-select" id="selectDate"> 
                </select>
              </div> 
            </div>
            <div class="col-sm-4">
              <div class="input-group">
                <div class="input-group-prepend">
                  <div class="input-group-text"><i class="fas fa-wallet"></i></div>
                </div>  
                <select class="custom-select" id="selectTradeOper">
                  <option value="BUY" selected>Buy</option>
                  <option value="SELL">Sell</option> 
                </select>
              </div> 
              <div class="input-group"> 
                <div class="input-group-prepend">
                  <div class="input-group-text"><i class="fas fa-ban"></i></div>
                </div>
                <select class="custom-select" id="selectTradeStop"> 
                  <option value="5"  >5</option>
                  <option value="10" selected>10</option>
                  <option value="20" >20</option>
                  <option value="50" >50</option>
                  <option value="100">100</option> 
                </select>
              </div>
              <div class="input-group"> 
                <div class="input-group-prepend" >
                  <div class="input-group-text"><i class="fas fa-grip-lines"></i></div>
                </div>
                <select class="custom-select" id="selectTradeLimit"> 
                  <option value="5"  >5</option>
                  <option value="10" selected>10</option>
                  <option value="20" >20</option>
                  <option value="50" >50</option>
                  <option value="100">100</option> 
                </select>
              </div> 
            </div>
            <div class="col-sm-4">
              <div class="input-group">  
                <button id="btnClosePosition" type="button" class="btn btn-secondary btn-block"><i class="fas fa-times"></i> <i class="fas fa-business-time"></i></button>
              </div> 
              <div class="input-group"> 
                <button id="btnOn" type="button" class="btn btn-success btn-block"><i class="fas fa-play"></i> <i class="fas fa-chart-line"></i></button>
              </div> 
              <div class="input-group"> 
                <button id="btnFast" type="button" class="btn btn-primary btn-block" disabled><i class="fas fa-forward"></i> x1</button>
              </div>
            </div>
          </div>           
        </div>
      </div>
      <div class="row">
        <div class="col-sm-12">
          <div id="chart"></div>
        </div>
      </div>
    </div>  
    <script src="https://code.jquery.com/jquery-3.5.1.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js"></script>  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.26.0/moment.min.js"></script> 
    <script src="https://code.highcharts.com/stock/highstock.js"></script> 
    <script src="https://code.highcharts.com/stock/modules/data.js"></script>
    <script>  
      var app = {
        //aux function
        getRndInteger: function(min, max) {
          return Math.floor(Math.random() * (max - min) ) + min;
        },
        resize: function(){ 
          var s = this;
          function exe(){ 
            s.heightTerminal();
            s.heightChart();
          }
          $(window).off('resize');
          exe();
          $(window).on('resize',function(){ 
            exe();
          }); 
        },
        disableAllButton: function(){
          $('button').prop('disabled', true);
          $('select').prop('disabled', true);  
          $('#btnDeleteTerminal').prop('disabled', false);
        },
        //terminal
        timestampTerminal: undefined,
        startTerminal: function(){
          this.timestampTerminal = new Date(); 
          $('#btnDeleteTerminal').on('click',function(){
            $('#terminal').html(' ');
          });     
        },
        addTerminal: function(text){
          var time = new Date()-this.timestampTerminal;
          time = (Math.floor(time/60/60/1000)<10?'0'+Math.floor(time/60/60/1000):Math.floor(time/60/60/1000))+
          ':'+(Math.floor(time/60/1000%60)<10?'0'+Math.floor(time/60/1000%60):Math.floor(time/60/1000%60))+
          ':'+(Math.floor(time/1000%60)<10?'0'+Math.floor(time/1000%60):Math.floor(time/1000%60));
          $('#terminal').append('<p>('+time+') > '+text+'</p>'); 
          var scrollSize = $('#terminal').height();
          $('#terminal p').each(function(){
            scrollSize = scrollSize + $(this).height();
          })
          $('#terminal').animate({ 
            scrollTop: scrollSize 
          },100); 
        },
        heightTerminal: function(){
          $('#terminal').css({
            'height': $('#comboContainer').innerHeight() 
          }); 
        },
        //chart
        chart: undefined,
        createChart: function(){
          var s = this;
          s.chart = Highcharts.stockChart('chart', { 
            title: {
              text: ''
            },  
            loading: {
              hideDuration: 500,
              showDuration: 500
            },
            credits: {
              enabled: false
            },
            plotOptions: {
              candlestick: {
                color: 'red',
                upColor: 'green'
              }
            },
            rangeSelector: {
              buttons: [{
                type: 'all',
                count: 1,
                text: 'All'
              },{
                type: 'year',
                count: 1,
                text: '1y'
              },{
                type: 'month',
                count: 6,
                text: '6m'
              },{
                type: 'month',
                count: 1,
                text: '1m'
              },{
                type: 'week',
                count: 1,
                text: '1w'
              },{
                type: 'day',
                count: 1,
                text: '1D'
              },{
                type: 'hour',
                count: 4,
                text: '4h'
              },{
                type: 'hour',
                count: 1,
                text: '1h'
              },{
                type: 'minute',
                count: 30,
                text: '30mi'
              },{
                type: 'minute',
                count: 5,
                text: '5mi'
              }],
              selected: 0,
              inputEnabled: false
            }, 
            series: [{
              name: $('#selectTradeMark option:selected').text(),
              type: 'candlestick',
              data: [],
              tooltip: {
                valueDecimals: 4
              }
            }]
          });
        }, 
        heightChart: function(){
          $('#chart').css({
            'height': $(window).innerHeight() - $('#comboContainer').innerHeight() 
          }); 
        },
        tempo: 0,
        intervalChart: undefined,
        setBtnPlayChart: function(){ 
          var s = this;    
          $('#btnOn').prop('disabled', false);
          $('#btnFast').prop('disabled', true); 
          var s = this;  
          $('#btnOn').on('click',function(){ 
            if($(this).hasClass('btn-success')){
              $(this).removeClass('btn-success');
              $(this).addClass('btn-danger');
              $(this).html('<i class="fas fa-stop"></i> <i class="fas fa-chart-line"></i>'); 
              $('#btnFast').prop('disabled', false);   
              s.addTerminal('On:  PlayChart');  
              s.exeStartChart();
            }else{
              $(this).addClass('btn-success');
              $(this).removeClass('btn-danger');
              $(this).html('<i class="fas fa-play"></i> <i class="fas fa-chart-line"></i>'); 
              $('#btnFast').prop('disabled', true); 
              s.tempo=1;
              $('#btnFast').html('<i class="fas fa-forward"></i> x'+s.tempo); 
              s.addTerminal('Off: PlayChart'); 
              s.exeStopChart();  
            }
          });
          s.tempo = 1;
          $('#btnFast').on('click',function(){   
            s.tempo++;
            $(this).html('<i class="fas fa-forward"></i> x'+s.tempo); 
            s.addTerminal('tempo x'+s.tempo); 
            s.exeStopChart();  
            s.exeStartChart();  
            if(s.tempo>4){
              s.tempo=0;
            }
          });   
        },
        exeBtnPlayChart: function(){ 
          $('#btnOn').trigger('click');    
        }, 
        exeStartChart: function(){ 
          var s = this;  
          var time = 1000/s.tempo;  
          $('#selectDate').prop('disabled', true);  
          $('#selectTradeMark').prop('disabled', true);  
          this.intervalChart = setInterval(function (){ 
            if(s.data[1].length===0){
              s.exeBtnPlayChart();
            }else{ 
              var point = s.data[1].shift()
              s.data[0].push(point);       
              s.chart.series[0].addPoint(point);
              s.chart.redraw(); 
            }
          },time);   
        },
        exeStopChart: function(){
          var s = this;     
          clearInterval(s.intervalChart); 
          $('#selectDate').prop('disabled', false);  
          $('#selectTradeMark').prop('disabled', false);    
        },
        //data
        data: [], 
        getData: function(yyyymm){
          var s = this; 
          s.chart.showLoading();
          $('#btnOn').prop('disabled', false);
          return new Promise(function(resolve) { 
            var rootFile = 'data/DAT_ASCII_EURUSD_M1_';
            var extFile = '.csv';              
            $.ajax({
              url: rootFile+yyyymm+extFile, // data/DAT_ASCII_EURUSD_M1_202001.csv
              context: document.body
            }).done(function(csv){  
              //20200501 011900;1.094530;1.094540;1.094510;1.094510;0\n
              //20200501 012000;1.094510;1.094610;1.094510;1.094610;0 
              csv = csv.split('\n'); 
              //for (var i=0; i<csv.length; i=i+1){ 
              for (var i=0; i<500; i=i+1){ 
                var row = csv[i].split(';');
                var timestamp = row[0].substring(6,8)+'/'+row[0].substring(4,6)+'/'+row[0].substring(0,4); 
                timestamp = timestamp+' '+row[0].substring(9,11)+':'+row[0].substring(11,13)+':00';   
                timestamp = moment(timestamp,'DD/MM/YYYY hh:mm:ss').valueOf();  
                s.data.push([timestamp,parseFloat(row[1]),parseFloat(row[2]),parseFloat(row[3]),parseFloat(row[4])]);
              } 
              s.addTerminal('data Loaded'); 
              s.chart.hideLoading();
              resolve(); 
            }).fail(function(){
              var d = new Date();
              s.data=[]; 
              for (var i=1; i<=25; i++){ 
                s.data.push([d.setDate(d.getDate()+1),1,1,1,1]);
              }              
              s.chart.hideLoading();
              resolve();
            }); 
          });
        },
        exeBtnData: function(){ 
          $('#selectDate').trigger('change');
        }, 
        setDataOnChart: function(){
          var s = this;
          s.exeStopChart();
          for (var i=5; i>0 ;i--){
            $('#selectDate').append('<option value="20200'+i+'">20200'+i+'</option>');
          }
          $('#selectDate').on('change',function(){
            var yyyymm = $('#selectDate').val();
            s.addTerminal('date: '+yyyymm);   
            s.getData(yyyymm).then(function(){ 
              var n = 10; //s.getRndInteger(1,10);  
              s.data = [
                s.data.slice(0, Math.round(s.data.length/n)-1),
                s.data.slice(Math.round(s.data.length/n), s.data.length-1)
              ];  
              s.chart.series[0].setData([]);
              s.chart.series[0].setData(s.data[0]);   
              s.chart.redraw(); 
              s.resize(); 
            });  
          });
          s.exeBtnData();
        }, 
        //Position  
        position:{
          flagStart: false,
          startTime: undefined,
          closeTime: undefined,
          startPrice: undefined,
          closePrice: undefined,
          stop: undefined,
          limit: undefined,
          pip: undefined,
          spread: undefined
        },
        setBtnPosition: function(){

        },
        openPosition: function(){
          /*
          var s = this;
          s.chart.series[1].setData([ ]); 
          s.chart.series[2].setData([ ]); 
          s.chart.series[3].setData([ ]); 
          s.chart.redraw();
          s.position.spread = 0.00006;
          s.position.pip    = 0.0001;
          s.position.flagStart  = true;
          s.position.startTime  = s.data[0][s.data[0].length-1][0];
          s.position.closeTime  = s.position.startTime;
          s.position.startPrice = s.data[0][s.data[0].length-1][4]+($('#selectTradeOper').val()==='BUY'?1:-1)*s.position.spread;
          s.position.closePrice = s.position.startPrice;
          s.position.stop       = s.data[0][s.data[0].length-1][4]+($('#selectTradeOper').val()==='BUY'?-1:1)*s.position.pip*$('#selectTradeStop').val();
          s.position.limit      = s.data[0][s.data[0].length-1][4]+($('#selectTradeOper').val()==='BUY'?1:-1)*s.position.pip*$('#selectTradeLimit').val();   
          $('#btnClosePosition').one('click',function(){
            $('#btnClosePosition').prop('disabled', true); 
            s.position.flagStart = false; 
            s.addTerminal('Position Closed');
            s.addTerminal('Pips Gain: '+s.calcGain());
          }); 
          */
          /*
          s.chart.addSeries({
            name: 'start price Position',
            type: 'line',
            color: 'black', 
            data: [ 
            ],
            tooltip: {
              valueDecimals: 4
            }
          });
          s.chart.addSeries({
            name: 'stop',
            type: 'line',
            color: 'red',
            dashStyle: 'shortdash',
            data: [ 
            ],
            tooltip: {
              valueDecimals: 4
            }
          });
          s.chart.addSeries({
            name: 'limit',
            type: 'line',
            color: 'green',
            dashStyle: 'shortdash',
            data: [ 
            ],
            tooltip: {
              valueDecimals: 4
            }
          });      
          */
        },
        closePosition: function(){

        },
        checkPosition: function(){
          /*
          if (!s.position.flagStart){
            s.createPosition(); 
            s.chart.series[1].setData([
              [s.position.startTime,s.position.startPrice]
            ]);
            s.chart.series[2].setData([
              [s.position.startTime,s.position.stop]
            ]);
            s.chart.series[3].setData([
              [s.position.startTime,s.position.limit]
            ]); 
            s.chart.redraw(); 
          }  
          s.chart.series[1].addPoint([point[0],s.position.startPrice]);
          s.chart.series[2].addPoint([point[0],s.position.stop]);
          s.chart.series[3].addPoint([point[0],s.position.limit]); 
          s.checkPosition(); 
          */
          /*
          var s = this;
          s.position.stopTime = s.data[0][s.data[0].length-1][0];
          s.position.closePrice = s.data[0][s.data[0].length-1][4];  
          if($('#selectTradeOper').val()==='BUY'){
            if(s.data[0][s.data[0].length-1][2]>s.position.limit){ //pass limit: high>limit
              s.position.closePrice=s.position.limit;
              s.addTerminal($('#selectTradeOper').val()+': Limit Prices!');  
              s.exeBtnClosePosition(); 
              s.exeBtnStart();
            }
            if(s.data[0][s.data[0].length-1][3]<s.position.stop){ //pass stop: low<stop
              s.position.stopPrice=s.position.stop;
              s.addTerminal($('#selectTradeOper').val()+': Stop Prices!');   
              s.exeBtnClosePosition(); 
              s.exeBtnStart();
            }
          }else{
            if(s.data[0][s.data[0].length-1][3]<s.position.limit){ //pass limit: low<limit
              s.position.closePrice=s.position.limit;
              s.addTerminal($('#selectTradeOper').val()+': Limit Prices!');    
              s.exeBtnClosePosition(); 
              s.exeBtnStart();
            }
            if(s.data[0][s.data[0].length-1][2]>s.position.stop){ //pass stop: high>stop
              s.position.stopPrice=s.position.stop;
              s.addTerminal($('#selectTradeOper').val()+': Stop Prices!');    
              s.exeBtnClosePosition(); 
              s.exeBtnStart();        
            }
          } 
          if(Math.random()<0.125){
            s.addTerminal('Pips Gain: '+s.calcGain());
          }
          */
        },
        calcGainPosition: function(){
          var s = this;
          return Math.round(($('#selectTradeOper').val()==='BUY'?1:-1)*(s.position.closePrice-s.position.startPrice)/s.position.pip*100000)/100000;
        },
        exe: function(){ 
          var s = this; 
          s.disableAllButton();
          s.startTerminal(); 
          s.addTerminal('start!');       
          s.createChart();  
          s.setDataOnChart(); 
          s.setBtnPlayChart(); 
          s.setBtnPosition();  
          s.resize();
        }
      } 
      app.exe();  
    </script>   
  </body>
</html>