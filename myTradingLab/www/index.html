<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="user-scalable=no, width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" type="text/css" href="../node_modules/bootstrap/dist/css/bootstrap.css"> 
    <link rel="stylesheet" type="text/css" href="../node_modules/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="../node_modules/node-snackbar/dist/snackbar.css">
    <title>My App</title>    
    <style>  
      #terminal{
        background-color: black;
        color: white;
        font: 0.75em sans-serif;
        overflow: auto;
        border-radius: 5px; 
      }
      #terminal p{
        margin: 0;
        padding: 0;
      } 
    </style>     
  </head>
  <body> 
    <div class="col">  
      <div class="row" id="menu">
        <div class="col-md-4">
          <div class="input-group">
            <div class="input-group-text"><i class="fa fa-database"></i></div> 
            <select class="form-control" id="selectData">
              <option value="1" selected>1</option>
              <option value="2">Pie</option> 
            </select>
          </div>
        </div> 
        <div class="col-md-4">
          <div class="input-group">
            <div class="input-group-text"><i class="fa fa-line-chart"></i></div> 
            <select class="form-control" id="selectPlot"> 
              <option value="1" selected>Candlestick</option>
              <option value="2">Pie</option> 
            </select>
          </div>
        </div> 
        <div class="col-md-2"> 
          <button type="button" class="btn btn-dark btn-block" id='plotBtn'><i class="fa fa-play"></i></button> 
        </div>
        <div class="col-md-2"> 
          <button type="button" class="btn btn-dark btn-block" data-toggle="collapse" data-target="#collapseTerminal"><i class="fa fa-terminal"></i></button> 
        </div> 
      </div>
      <div class="collapse" id="collapseTerminal">
        <div class="row">
          <div class="col-12">
            <div id="terminal"></div>
          </div>       
        </div> 
      </div>
      <div class="row">
        <div class="col-12">
          <div id="chart"> Algo</div>
        </div> 
      </div>  
    </div>  
    <div class="modal fade" id="loadingModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Loading...</h5>
          </div>
          <div class="modal-body"> 
            <div class="progress">
              <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" aria-valuenow="75" aria-valuemin="0" aria-valuemax="100" style="width: 100%"></div>
            </div>
          </div> 
        </div>
      </div>
    </div>
    <script type="text/javascript" src="../node_modules/jquery/dist/jquery.js"></script>  
    <script type="text/javascript" >
      try{
        window.$ = window.jQuery = require('../node_modules/jquery/dist/jquery.js');
      }catch(error){
        console.error(error);
      }
    </script> 
    <script type="text/javascript" src="../node_modules/highcharts/highstock.js"></script>
    <script type="text/javascript" >
      try{
        window.Highcharts = require('../node_modules/highcharts/highstock.js');
      }catch(error){
        console.error(error);
      }
    </script> 
    <!--<script type="text/javascript" src="../node_modules/popper.js/dist/umd/popper.js"></script>--> 
    <script type="text/javascript" src="../node_modules/bootstrap/dist/js/bootstrap.bundle.js"></script> 
    <script type="text/javascript" src="../node_modules/moment/moment.js"></script>  
    <script type="text/javascript" src="../node_modules/node-snackbar/dist/snackbar.min.js"></script>
    <script type="text/javascript"> 
      var ipcRenderer = require('electron').ipcRenderer; 
      var app = {
        //Terminal 
        timestampTerminal: undefined,
        setTerminal: function(){
          var s = this;
          s.timestampTerminal = new Date(); 
          $('#btnDeleteTerminal').on('click',function(){
            $('#terminal').html(' '); 
            Snackbar.show({text: 'Terminal Deleted'}); 
            s.addTerminal('Terminal Restored'); 
          });     
        },
        addTerminal: function(text,removeclass){
          var time = new Date()-this.timestampTerminal;
          time = (Math.floor(time/60/60/1000)<10?'0'+Math.floor(time/60/60/1000):Math.floor(time/60/60/1000))+
          ':'+(Math.floor(time/60/1000%60)<10?'0'+Math.floor(time/60/1000%60):Math.floor(time/60/1000%60))+
          ':'+(Math.floor(time/1000%60)<10?'0'+Math.floor(time/1000%60):Math.floor(time/1000%60));
          var cl = '';
          if (removeclass===true){
            cl = 'removeTerminalIntro';
          }
          $('.removeTerminalIntro').remove();
          $('#terminal').append('<p class="'+cl+'">('+time+') > '+text+'</p>'); 
          var scrollSize = $('#terminal').height();
          $('#terminal p').each(function(){
            scrollSize = scrollSize + $(this).height();
          })
          $('#terminal').animate({ 
            scrollTop: scrollSize 
          },100); 
        }, 
        //Modal Loading
        exeModal: true, 
        showLoadingModal: function(){ 
          var s = this;
          s.exeModal = false; 
          $('#loadingModal').modal({ 
            backdrop: 'static',
            keyboard: false
          });
        }, 
        hideLoadingModal: function(){
          var s = this;
          s.exeModal = true; 
          $('#loadingModal').modal('hide'); 
        },
        setLoadingModal: function(){
          var s = this;
          $('#loadingModal').on('shown.bs.modal', function (e) { 
            if(s.exeModal){ 
              s.hideLoadingModal();
            }
          });
        },  
        //General Event
        resize: function(){ 
          var s = this; 
          function size(){
            var h = $(window).innerHeight()-$('#menu').innerHeight()-10;
            $('#terminal').css({
              'height': h
            }); 
            $('#chart').css({
              'height': h
            });
          }
          size();
          $(window).off('resize'); 
          $(window).on('resize',size); 
          var event;
          if(typeof(Event) === 'function') { //CHROME
                event = new Event('resize');
          }else{ // IE
            event = window.document.createEvent('UIEvents'); 
            event.initUIEvent('resize', true, false, window, 0);  
          }
          window.dispatchEvent(event);
        }, 
        listData: undefined,   
        getLoadListData: function(fnSuccess,fnFail){
          var s = this;
          ipcRenderer.send('request01', true);
          ipcRenderer.once('replyRequest01',function(event, arg){ 
            if(arg!==null||arg!==undefined){    
              s.listData=arg;  
              fnSuccess();
            }else{
              fnFail();
            } 
          }); 
        }, 
        setDataList: function(){
          var s = this; 
          $('#selectData').html(' ');
          $.each(s.listData,function(i,e){
            var namefile = e.split('\\');
            namefile = namefile[namefile.length-1];
            if(i===0){
              $('#selectData').append('<option value="'+e+'" selected>'+namefile+'</option>');
            }else{
              $('#selectData').append('<option value="'+e+'">'+e+'</option>');
            } 
          });          
        },
        setPlotBtn: function(){
          var s = this; 
          $('#plotBtn').on('click',function(){
            s.plot(); 
          });
        },
        readPlotData: function(file,fnSuccess,fnFail){
          $.ajax({
            url: file, 
            success: function (data){
              data = JSON.parse(data);
              fnSuccess(data);
            },
            error: function (){
              fnFail();
            }
          });
        },
        plot: function(){ 
          var s = this; 
          function endPlot(err){
            s.hideLoadingModal();
            if(err){
              $('#chart').html('<div class="alert alert-danger" role="alert"><h4 class="alert-heading">Error</h4> <p>Ploting Data with plot type or reading data</p> <hr> <p class="mb-0">Try again!</p></div>'); 
              s.addTerminal('Error ploting or reading data'); 
            }else{
              s.addTerminal('ploting and reading data done'); 
            }
          }
          var plotType = parseInt($('#selectPlot').val());
          var plotData = $('#selectData').val();          
          s.showLoadingModal();
          $('#chart').html(' ');
          s.readPlotData(plotData,function(data){ 
            var namefile = plotData.split('\\');
            namefile = namefile[namefile.length-1];
            try{
              if(plotType===1){ //Candlestick 
                Highcharts.stockChart('chart', { 
                  rangeSelector: {
                    selected: 1
                  }, 
                  title: {
                    text: ' '
                  }, 
                  credits: {
                      enabled: false
                  },
                  chart: { 
                    zoomType: 'x'
                  },
                  series: [{
                    type: 'candlestick',
                    name: namefile,
                    data: data.data,
                    dataGrouping: {
                      units: [
                        [
                          'week', // unit name
                          [1] // allowed multiples
                        ], [
                          'month',
                          [1, 2, 3, 4, 6]
                        ]
                      ]
                    }
                  }]
                });
                endPlot(); 
              }else{
                endPlot(true);
              } 
            }catch(err){
              endPlot(true);
            }
          },function(){
            endPlot(true);
          }); 
        },
        exe: function(){ 
          var s = this; 
          s.showLoadingModal();  
          s.setTerminal(); 
          s.addTerminal('start App!'); 
          s.setLoadingModal(); 
          s.setPlotBtn(); 
          s.resize(); 
          Snackbar.show({text: 'Getting Data ...'});
          s.getLoadListData(function(){
            s.hideLoadingModal();
            s.addTerminal('List data loaded'); 
            s.setDataList();
            Snackbar.show({text: 'List data loaded'});  
            $('#plotBtn').trigger('click');
          },function(){
            s.hideLoadingModal(); 
            s.addTerminal('Getting Data error');  
            Snackbar.show({text: 'Getting Data error'});
          });
        }
      }
      app.exe();
    </script>    
  </body>
</html>